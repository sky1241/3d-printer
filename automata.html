<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üî© Automata Generator V5</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;0,9..40,900;1,9..40,400&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#06060a;--s1:#0c0c14;--s2:#13131f;--s3:#1e1e32;--s4:#2a2a44;
  --t1:#e8e6f0;--t2:#7a7894;--t3:#4a4866;
  --ac:#ff6b35;--ac2:#ff8c5a;--acg:rgba(255,107,53,.08);
  --ok:#34d399;--warn:#fbbf24;--err:#f87171;
  --blu:#60a5fa;--blug:rgba(96,165,250,.08);
  --r:10px
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;overflow:hidden;-webkit-font-smoothing:antialiased}
.mono{font-family:'JetBrains Mono',monospace}

/* ‚ïê‚ïê‚ïê LAYOUT 3 COLONNES ‚ïê‚ïê‚ïê */
.app{display:grid;grid-template-columns:280px 1fr 260px;grid-template-rows:52px 1fr;height:100vh;gap:0}

/* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
.topbar{grid-column:1/-1;display:flex;align-items:center;padding:0 16px;background:var(--s1);border-bottom:1px solid var(--s3)}
.topbar-icon{width:32px;height:32px;background:var(--ac);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 12px rgba(255,107,53,.2);margin-right:10px}
.topbar h1{font-size:.95rem;font-weight:900;letter-spacing:-.02em}
.topbar-tag{font-size:.55rem;color:var(--t3);margin-left:8px;padding:2px 6px;background:var(--s3);border-radius:4px}.topbar-tag.mono{letter-spacing:.04em}
.topbar-drive{margin-left:auto;display:flex;align-items:center;gap:8px}
.drive-chip{display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:6px;border:1px solid var(--s3);background:var(--s2);cursor:pointer;font-size:.7rem;font-weight:700;color:var(--t3);transition:all .15s;font-family:'DM Sans'}
.drive-chip.on{border-color:var(--ac);color:var(--ac);background:var(--acg)}
.drive-chip.on-b{border-color:var(--blu);color:var(--blu);background:var(--blug)}
.topbar-gen{margin-left:12px;padding:6px 16px;border-radius:7px;border:none;background:var(--ac);color:#fff;font-weight:800;font-size:.72rem;cursor:pointer;font-family:'DM Sans';letter-spacing:.02em;transition:all .15s;box-shadow:0 2px 12px rgba(255,107,53,.25)}
.topbar-gen:hover{background:var(--ac2);transform:translateY(-1px)}
.topbar-gen:disabled{opacity:.4;cursor:not-allowed;transform:none}

/* ‚îÄ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ‚îÄ */
.left{background:var(--s1);border-right:1px solid var(--s3);display:flex;flex-direction:column;overflow:hidden}
.panel-h{padding:10px 14px 8px;font-size:.65rem;font-weight:700;color:var(--t3);letter-spacing:.06em;text-transform:uppercase;display:flex;align-items:center;gap:6px;border-bottom:1px solid rgba(255,255,255,.03)}
.panel-h .dot{width:5px;height:5px;border-radius:50%;background:var(--ac)}
.panel-h .dot-b{width:5px;height:5px;border-radius:50%;background:var(--blu)}

/* AI Input */
.ai-input-wrap{padding:10px 12px}
.ai-input{width:100%;min-height:70px;max-height:140px;resize:vertical;background:var(--s2);border:1px solid var(--s3);border-radius:8px;color:var(--t1);padding:10px 12px;font-family:'DM Sans',sans-serif;font-size:.78rem;line-height:1.5;outline:none;transition:border-color .15s}
.ai-input::placeholder{color:var(--t3)}
.ai-input:focus{border-color:var(--ac)}
.ai-btn{width:100%;padding:9px;border:none;border-radius:7px;font-weight:800;font-size:.72rem;cursor:pointer;font-family:'DM Sans';letter-spacing:.02em;transition:all .15s;margin-top:6px}
.ai-btn.primary{background:var(--ac);color:#fff;box-shadow:0 2px 10px rgba(255,107,53,.2)}
.ai-btn.primary:hover{background:var(--ac2)}
.ai-btn.secondary{background:var(--s3);color:var(--t2)}
.ai-btn.secondary:hover{background:var(--s4);color:var(--t1)}
.ai-btn:disabled{opacity:.35;cursor:not-allowed}

/* Step indicator */
.steps{display:flex;padding:8px 12px;gap:4px}
.step{flex:1;height:3px;border-radius:2px;background:var(--s3);transition:background .3s}
.step.done{background:var(--ok)}
.step.active{background:var(--ac);box-shadow:0 0 8px rgba(255,107,53,.3)}

/* Pieces list */
.pieces-list{flex:1;overflow-y:auto;padding:4px 8px}
.piece-item{display:flex;align-items:center;gap:8px;padding:7px 8px;border-radius:7px;cursor:pointer;transition:all .12s;border:1px solid transparent;margin-bottom:2px}
.piece-item:hover{background:var(--s2);border-color:var(--s3)}
.piece-item.selected{background:var(--acg);border-color:rgba(255,107,53,.2)}
.piece-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.piece-name{font-size:.72rem;font-weight:600;flex:1}
.piece-shape{font-size:.58rem;color:var(--t3);font-family:'JetBrains Mono'}
.piece-movable{font-size:.65rem;cursor:pointer;opacity:.5;transition:opacity .15s}
.piece-movable.on{opacity:1}

/* ‚îÄ‚îÄ‚îÄ CENTER CANVAS ‚îÄ‚îÄ‚îÄ */
.center{position:relative;background:var(--bg);display:flex;flex-direction:column}
.canvas-wrap{flex:1;position:relative;overflow:hidden}
.canvas-wrap canvas{width:100%;height:100%;display:block}
.cv-badge{position:absolute;bottom:10px;left:10px;font-size:.55rem;padding:3px 8px;border-radius:5px;font-weight:700;letter-spacing:.02em}
.cv-badge.ok{background:rgba(52,211,153,.12);color:var(--ok);border:1px solid rgba(52,211,153,.15)}
.cv-badge.tag{background:rgba(255,107,53,.08);color:var(--ac);border:1px solid rgba(255,107,53,.12)}
.cv-hint{position:absolute;bottom:10px;right:10px;font-size:.52rem;color:var(--t3)}
.zoom-bar{position:absolute;top:10px;right:10px;display:flex;gap:3px}
.zoom-bar button{width:26px;height:26px;border:1px solid var(--s3);background:rgba(6,6,10,.85);color:var(--t2);border-radius:6px;font-size:.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s}
.zoom-bar button:hover{background:var(--s3);color:var(--t1)}
/* Status bar */
.status-bar{display:flex;align-items:center;padding:6px 12px;background:var(--s1);border-top:1px solid var(--s3);gap:8px}
.stat{font-size:.6rem;color:var(--t3);display:flex;align-items:center;gap:4px}
.stat .v{color:var(--ac);font-weight:700;font-family:'JetBrains Mono'}
.stat .v-b{color:var(--blu);font-weight:700;font-family:'JetBrains Mono'}

/* ‚îÄ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ‚îÄ */
.right{background:var(--s1);border-left:1px solid var(--s3);display:flex;flex-direction:column;overflow-y:auto}

/* Shape buttons */
.shape-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;padding:8px 10px}
.shape-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;border-radius:7px;border:1px solid var(--s3);background:var(--s2);cursor:pointer;transition:all .12s}
.shape-btn:hover{border-color:var(--ac);background:var(--acg)}
.shape-btn.active{border-color:var(--ac);background:var(--acg);box-shadow:0 0 8px rgba(255,107,53,.15)}
.shape-btn svg{width:24px;height:24px}
.shape-btn span{font-size:.55rem;font-weight:700;color:var(--t2)}

/* Motion buttons */
.motion-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:4px;padding:8px 10px}
.motion-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 4px;border-radius:7px;border:1px solid var(--s3);background:var(--s2);cursor:pointer;transition:all .12s}
.motion-btn:hover{border-color:var(--blu);background:var(--blug)}
.motion-btn.active{border-color:var(--blu);background:var(--blug);box-shadow:0 0 8px rgba(96,165,250,.15)}
.motion-btn .ico{font-size:1.1rem}
.motion-btn span{font-size:.55rem;font-weight:700;color:var(--t2)}

/* Sliders */
.slider-group{padding:6px 10px}
.slider-row{margin-bottom:8px}
.slider-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.slider-label span{font-size:.6rem;font-weight:600;color:var(--t2)}
.slider-label .val{font-family:'JetBrains Mono';color:var(--ac);font-weight:700;font-size:.6rem}
.slider-label .val-b{font-family:'JetBrains Mono';color:var(--blu);font-weight:700;font-size:.6rem}
input[type=range]{-webkit-appearance:none;width:100%;height:4px;background:var(--s3);border-radius:2px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--ac);border-radius:50%;cursor:pointer;box-shadow:0 1px 6px rgba(255,107,53,.3)}
input[type=range].blu::-webkit-slider-thumb{background:var(--blu);box-shadow:0 1px 6px rgba(96,165,250,.3)}

/* Phase selector */
.phase-row{display:flex;gap:3px;padding:4px 10px 8px}
.phase-btn{flex:1;padding:6px;border:1px solid var(--s3);background:var(--s2);border-radius:5px;font-size:.6rem;font-weight:700;color:var(--t3);cursor:pointer;text-align:center;font-family:'JetBrains Mono';transition:all .12s}
.phase-btn.on{border-color:var(--blu);color:var(--blu);background:var(--blug)}

/* Profile selector */
.profile-row{display:flex;gap:3px;padding:4px 10px 8px}
.prof-btn{flex:1;padding:6px 4px;border:1px solid var(--s3);background:var(--s2);border-radius:5px;font-size:.55rem;font-weight:700;color:var(--t3);cursor:pointer;text-align:center;transition:all .12s}
.prof-btn.on{border-color:var(--warn);color:var(--warn);background:rgba(251,191,36,.08)}

/* Divider */
.divider{height:1px;background:var(--s3);margin:4px 10px}

/* Loading */
.loading{display:flex;align-items:center;gap:6px;padding:8px 12px;font-size:.7rem;color:var(--ac)}
.loading .spin{width:14px;height:14px;border:2px solid var(--s3);border-top-color:var(--ac);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* AI Response preview */
.ai-response{padding:6px 10px;font-size:.6rem;color:var(--ok);font-family:'JetBrains Mono';background:rgba(52,211,153,.04);border-radius:6px;margin:4px 12px;max-height:60px;overflow-y:auto;border:1px solid rgba(52,211,153,.08)}

/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--s3);border-radius:2px}

/* Empty state */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:10px;padding:20px}
.empty-state .big{font-size:2.5rem}
.empty-state p{font-size:.75rem;color:var(--t3);text-align:center;line-height:1.5;max-width:280px}
.empty-state .hint{font-size:.65rem;color:var(--t3);font-style:italic}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê TOP BAR ‚ïê‚ïê‚ïê -->
<div class="app">
<div class="topbar">
  <div class="topbar-icon">üî©</div>
  <h1>Automata Generator</h1>
  <span class="topbar-tag mono">V5</span>
  <div class="topbar-drive">
    <div class="drive-chip on-b" id="dCrank" onclick="setDrive(0)"><span>üñêÔ∏è</span> Manivelle</div>
    <div class="drive-chip" id="dMotor" onclick="setDrive(1)"><span>‚ö°</span> Moteur</div>
    <button class="topbar-gen" id="btnGenerate" disabled onclick="doGenerate()">‚¨á G√âN√âRER STL</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LEFT PANEL ‚ïê‚ïê‚ïê -->
<div class="left">
  <!-- Steps -->
  <div class="steps">
    <div class="step active" id="s1"></div>
    <div class="step" id="s2"></div>
    <div class="step" id="s3"></div>
  </div>

  <!-- Step 1: Describe -->
  <div id="stepDescribe">
    <div class="panel-h"><div class="dot"></div> √âTAPE 1 ‚Äî D√âCRIS TA FIGURINE</div>
    <div class="ai-input-wrap">
      <textarea class="ai-input" id="aiInput" placeholder="Ex: un chien, un oiseau qui vole, un robot, un dinosaure..."></textarea>
      <button class="ai-btn primary" id="btnDecompose" onclick="doDecompose()">üß† D√©composer en formes</button>
    </div>
  </div>

  <!-- Step 2: Movement -->
  <div id="stepMovement" style="display:none">
    <div class="panel-h"><div class="dot-b"></div> √âTAPE 2 ‚Äî D√âCRIS LE MOUVEMENT</div>
    <div class="ai-input-wrap">
      <textarea class="ai-input" id="aiMotion" placeholder="Ex: il remue la queue, il bat des ailes, il marche..."></textarea>
      <button class="ai-btn primary" style="background:var(--blu);box-shadow:0 2px 10px rgba(96,165,250,.2)" id="btnMotion" onclick="doMotion()">‚öôÔ∏è Assigner les mouvements</button>
      <button class="ai-btn secondary" style="margin-top:4px" onclick="backToStep1()">‚Üê Modifier les formes</button>
    </div>
  </div>

  <!-- Pieces list -->
  <div class="panel-h" id="piecesHeader" style="display:none"><div class="dot"></div> PI√àCES <span id="pieceCount" style="margin-left:auto;font-size:.6rem;color:var(--ac)" class="mono"></span></div>
  <div class="pieces-list" id="piecesList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê CENTER CANVAS ‚ïê‚ïê‚ïê -->
<div class="center">
  <div class="canvas-wrap">
    <canvas id="mainCanvas"></canvas>
    <div class="zoom-bar">
      <button onclick="toggleExplode()" id="btnExplode" title="Vue √©clat√©e">üí•</button>
      <button onclick="zoomIn()">Ôºã</button>
      <button onclick="zoomReset()">‚ü≥</button>
      <button onclick="zoomOut()">Ôºç</button>
    </div>
    <div class="cv-badge ok" id="badgeFDM" style="display:none">‚úì FDM valid√©</div>
    <div class="cv-badge tag" id="badgePieces" style="display:none"></div>
    <div class="cv-hint" id="cvHint">‚Üî glisse pour tourner ¬∑ scroll pour zoomer</div>

    <!-- Empty state -->
    <div class="empty-state" id="emptyState">
      <div class="big">üé®</div>
      <p><strong>D√©cris ce que tu veux</strong><br>Tape une description √† gauche et l'IA d√©compose ta figurine en formes g√©om√©triques</p>
      <span class="hint">"un chien qui remue la queue"</span>
    </div>
  </div>
  <div class="status-bar">
    <div class="stat">Pi√®ces <span class="v" id="statPieces">‚Äî</span></div>
    <div class="stat">Cames <span class="v" id="statCams">‚Äî</span></div>
    <div class="stat">Drive <span class="v-b" id="statDrive">Manivelle</span></div>
    <div class="stat" style="margin-left:auto">Zoom <span class="v mono" id="statZoom">√ó1.0</span></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê RIGHT PANEL ‚ïê‚ïê‚ïê -->
<div class="right">
  <!-- Shapes section -->
  <div class="panel-h"><div class="dot"></div> FORMES DE BASE</div>
  <div class="shape-grid">
    <div class="shape-btn" onclick="setShape('circle')" id="sh_circle">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><circle cx="12" cy="12" r="9"/></svg>
      <span>Cercle</span>
    </div>
    <div class="shape-btn" onclick="setShape('rect')" id="sh_rect">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><rect x="4" y="6" width="16" height="12" rx="1"/></svg>
      <span>Rectangle</span>
    </div>
    <div class="shape-btn" onclick="setShape('tri')" id="sh_tri">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><polygon points="12,3 22,21 2,21"/></svg>
      <span>Triangle</span>
    </div>
    <div class="shape-btn" onclick="setShape('square')" id="sh_square">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><rect x="5" y="5" width="14" height="14" rx="1"/></svg>
      <span>Carr√©</span>
    </div>
    <div class="shape-btn" onclick="setShape('ellipse')" id="sh_ellipse">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><ellipse cx="12" cy="12" rx="10" ry="6"/></svg>
      <span>Ellipse</span>
    </div>
    <div class="shape-btn" onclick="setShape('diamond')" id="sh_diamond">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><polygon points="12,2 22,12 12,22 2,12"/></svg>
      <span>Losange</span>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Movement section -->
  <div class="panel-h"><div class="dot-b"></div> MOUVEMENTS</div>
  <div class="motion-grid">
    <div class="motion-btn" onclick="setMotion('TRANSLATE_V')" id="mo_tv">
      <span class="ico">‚ÜïÔ∏è</span>
      <span>Monte/Descend</span>
    </div>
    <div class="motion-btn" onclick="setMotion('TRANSLATE_H')" id="mo_th">
      <span class="ico">‚ÜîÔ∏è</span>
      <span>Gauche/Droite</span>
    </div>
    <div class="motion-btn" onclick="setMotion('OSCILLATE')" id="mo_osc">
      <span class="ico">üîÑ</span>
      <span>Oscillation</span>
    </div>
    <div class="motion-btn" onclick="setMotion('ROTATE')" id="mo_rot">
      <span class="ico">‚ü≥</span>
      <span>Rotation</span>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Sliders -->
  <div class="panel-h"><div class="dot"></div> PARAM√àTRES</div>
  <div class="slider-group">
    <div class="slider-row">
      <div class="slider-label"><span>Amplitude</span><span class="val" id="valAmp">30¬∞</span></div>
      <input type="range" min="5" max="90" value="30" id="slAmp" oninput="updateParam()">
    </div>
    <div class="slider-row">
      <div class="slider-label"><span>Vitesse</span><span class="val-b" id="valSpeed">1.0 Hz</span></div>
      <input type="range" class="blu" min="1" max="6" value="2" step="1" id="slSpeed" oninput="updateParam()">
    </div>
    <div class="slider-row">
      <div class="slider-label"><span>Taille pi√®ce</span><span class="val" id="valSize">100%</span></div>
      <input type="range" min="50" max="200" value="100" id="slSize" oninput="updateParam()">
    </div>
  </div>

  <!-- Phase -->
  <div class="panel-h"><div class="dot-b"></div> PHASE</div>
  <div class="phase-row">
    <div class="phase-btn on" onclick="setPhase(0)">0¬∞</div>
    <div class="phase-btn" onclick="setPhase(90)">90¬∞</div>
    <div class="phase-btn" onclick="setPhase(180)">180¬∞</div>
    <div class="phase-btn" onclick="setPhase(270)">270¬∞</div>
  </div>

  <!-- Cam profile -->
  <div class="panel-h"><div class="dot"></div> PROFIL CAME</div>
  <div class="profile-row">
    <div class="prof-btn on" onclick="setProfile('smooth')">Smooth</div>
    <div class="prof-btn" onclick="setProfile('sharp')">Sharp</div>
    <div class="prof-btn" onclick="setProfile('dwell')">Dwell</div>
  </div>

  <div class="divider"></div>

  <!-- Pivot -->
  <div class="panel-h"><div class="dot-b"></div> PIVOT</div>
  <div class="phase-row">
    <div class="phase-btn" onclick="setPivot('top')">‚Üë Haut</div>
    <div class="phase-btn on" onclick="setPivot('center')">‚äï Centre</div>
    <div class="phase-btn" onclick="setPivot('bottom')">‚Üì Bas</div>
  </div>
  <div class="phase-row" style="padding-top:0">
    <div class="phase-btn" onclick="setPivot('left')">‚Üê Gauche</div>
    <div class="phase-btn" onclick="setPivot('right')">‚Üí Droite</div>
  </div>
</div>

</div><!-- /app -->

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let figurine = null;     // JSON from prompt 1
let motions = null;      // JSON from prompt 2
let drive = 0;           // 0=crank, 1=motor
let selectedPiece = null;
let currentStep = 1;
let zoom = 1, panX = 0, panY = 0, rotAngle = 0, autoRotate = true;
let anim = null;

// Piece colors
const COLORS = [
  '#34d399','#60a5fa','#f472b6','#fbbf24','#a78bfa',
  '#fb923c','#2dd4bf','#e879f9','#f87171','#94a3b8',
  '#4ade80','#38bdf8','#f9a8d4','#facc15','#c084fc'
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DRIVE TOGGLE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setDrive(d){
  drive=d;
  document.getElementById('dCrank').className='drive-chip'+(d===0?' on-b':'');
  document.getElementById('dMotor').className='drive-chip'+(d===1?' on':'');
  document.getElementById('statDrive').textContent=d===0?'Manivelle':'Moteur';
  document.getElementById('statDrive').className=d===0?'v-b':'v';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AI CALLS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* ‚ïê‚ïê‚ïê SMART LOCAL DECOMPOSER ‚ïê‚ïê‚ïê */
const TEMPLATES = {
  // ‚îÄ‚îÄ ANIMALS ‚îÄ‚îÄ
  chien:{name:"Chien",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:30,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:14},position:{x:-35,y:-8},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"museau",name:"Museau",shape:{type:"ellipse",rx:8,ry:5},position:{x:-50,y:-5},rotation:0,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"oreille_g",name:"Oreille G",shape:{type:"tri",base:10,h:14},position:{x:-38,y:-22},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oreille_d",name:"Oreille D",shape:{type:"tri",base:10,h:14},position:{x:-28,y:-22},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte avant G",shape:{type:"rect",w:6,h:22},position:{x:-18,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte avant D",shape:{type:"rect",w:6,h:22},position:{x:-8,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte arri√®re G",shape:{type:"rect",w:6,h:22},position:{x:18,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_ar_d",name:"Patte arri√®re D",shape:{type:"rect",w:6,h:22},position:{x:10,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"tri",base:8,h:24},position:{x:34,y:-6},rotation:120,parent:"corps",anchor:"right",layer:1,movable:true}
  ]},
  chat:{name:"Chat",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:24,ry:16},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:15},position:{x:-28,y:-10},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"oreille_g",name:"Oreille G",shape:{type:"tri",base:8,h:12},position:{x:-34,y:-26},rotation:-10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oreille_d",name:"Oreille D",shape:{type:"tri",base:8,h:12},position:{x:-22,y:-26},rotation:10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte avant G",shape:{type:"rect",w:5,h:18},position:{x:-14,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_av_d",name:"Patte avant D",shape:{type:"rect",w:5,h:18},position:{x:-6,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"patte_ar_g",name:"Patte arri√®re G",shape:{type:"rect",w:5,h:18},position:{x:14,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_ar_d",name:"Patte arri√®re D",shape:{type:"rect",w:5,h:18},position:{x:8,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"patte_wave",name:"Patte qui wave",shape:{type:"rect",w:5,h:18},position:{x:-18,y:8},rotation:-30,parent:"corps",anchor:"left",layer:2,movable:true},
    {id:"queue",name:"Queue",shape:{type:"ellipse",rx:4,ry:20},position:{x:28,y:-12},rotation:30,parent:"corps",anchor:"right",layer:1,movable:true}
  ]},
  oiseau:{name:"Oiseau",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:22,ry:14},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:10},position:{x:-26,y:-12},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bec",name:"Bec",shape:{type:"tri",base:8,h:14},position:{x:-40,y:-12},rotation:-90,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:2},position:{x:-28,y:-14},rotation:0,parent:"tete",anchor:"center",layer:3,movable:false},
    {id:"aile_g",name:"Aile gauche",shape:{type:"tri",base:30,h:18},position:{x:0,y:-18},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"aile_d",name:"Aile droite",shape:{type:"tri",base:30,h:18},position:{x:0,y:-18},rotation:180,parent:"corps",anchor:"top",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"tri",base:16,h:12},position:{x:24,y:-4},rotation:150,parent:"corps",anchor:"right",layer:1,movable:false},
    {id:"patte_g",name:"Patte G",shape:{type:"rect",w:3,h:14},position:{x:-6,y:14},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_d",name:"Patte D",shape:{type:"rect",w:3,h:14},position:{x:6,y:14},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false}
  ]},
  canard:{name:"Canard",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:26,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:true},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:12},position:{x:-28,y:-14},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"bec",name:"Bec",shape:{type:"rect",w:16,h:5},position:{x:-44,y:-12},rotation:0,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"aile",name:"Aile",shape:{type:"ellipse",rx:16,ry:10},position:{x:4,y:-6},rotation:-10,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"queue",name:"Queue",shape:{type:"tri",base:12,h:10},position:{x:28,y:-8},rotation:140,parent:"corps",anchor:"right",layer:1,movable:false}
  ]},
  poisson:{name:"Poisson",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:30,ry:14},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"queue",name:"Queue",shape:{type:"tri",base:22,h:16},position:{x:32,y:0},rotation:90,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"nageoire_d",name:"Nageoire dorsale",shape:{type:"tri",base:18,h:12},position:{x:-4,y:-16},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"nageoire_v",name:"Nageoire ventrale",shape:{type:"tri",base:10,h:8},position:{x:4,y:14},rotation:180,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:3},position:{x:-18,y:-3},rotation:0,parent:"corps",anchor:"left",layer:2,movable:false}
  ]},
  dinosaure:{name:"Dinosaure",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:28,ry:20},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:14,ry:10},position:{x:-34,y:-12},rotation:-15,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"machoire",name:"M√¢choire",shape:{type:"tri",base:12,h:8},position:{x:-46,y:-8},rotation:-90,parent:"tete",anchor:"left",layer:2,movable:true},
    {id:"patte_av_g",name:"Bras G",shape:{type:"rect",w:5,h:14},position:{x:-16,y:10},rotation:20,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Bras D",shape:{type:"rect",w:5,h:14},position:{x:-10,y:10},rotation:20,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte G",shape:{type:"rect",w:8,h:24},position:{x:14,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_ar_d",name:"Patte D",shape:{type:"rect",w:8,h:24},position:{x:22,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"queue",name:"Queue",shape:{type:"tri",base:10,h:35},position:{x:32,y:4},rotation:100,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"crete1",name:"Cr√™te 1",shape:{type:"tri",base:8,h:10},position:{x:-10,y:-22},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false},
    {id:"crete2",name:"Cr√™te 2",shape:{type:"tri",base:8,h:10},position:{x:0,y:-22},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false},
    {id:"crete3",name:"Cr√™te 3",shape:{type:"tri",base:8,h:10},position:{x:10,y:-22},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false}
  ]},
  robot:{name:"Robot",pieces:[
    {id:"corps",name:"Torse",shape:{type:"rect",w:30,h:36},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"square",s:22},position:{x:0,y:-30},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"antenne",name:"Antenne",shape:{type:"rect",w:3,h:12},position:{x:0,y:-44},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:4},position:{x:-6,y:-32},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:4},position:{x:6,y:-32},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:6,h:28},position:{x:-22,y:2},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D",shape:{type:"rect",w:6,h:28},position:{x:22,y:2},rotation:0,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"patte_g",name:"Jambe G",shape:{type:"rect",w:8,h:26},position:{x:-10,y:32},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_d",name:"Jambe D",shape:{type:"rect",w:8,h:26},position:{x:10,y:32},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  cheval:{name:"Cheval",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:34,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:12,ry:8},position:{x:-42,y:-16},rotation:-30,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"cou",name:"Cou",shape:{type:"rect",w:8,h:20},position:{x:-34,y:-8},rotation:-20,parent:"corps",anchor:"left",layer:0,movable:false},
    {id:"oreille_g",name:"Oreille G",shape:{type:"tri",base:5,h:10},position:{x:-44,y:-28},rotation:-10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oreille_d",name:"Oreille D",shape:{type:"tri",base:5,h:10},position:{x:-38,y:-28},rotation:10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"rect",w:5,h:28},position:{x:-20,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"rect",w:5,h:28},position:{x:-12,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"rect",w:5,h:28},position:{x:18,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"rect",w:5,h:28},position:{x:26,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"ellipse",rx:4,ry:18},position:{x:36,y:-8},rotation:20,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"criniere",name:"Crini√®re",shape:{type:"ellipse",rx:4,ry:14},position:{x:-32,y:-14},rotation:-20,parent:"cou",anchor:"top",layer:2,movable:false}
  ]},
  bonhomme:{name:"Bonhomme",pieces:[
    {id:"corps",name:"Torse",shape:{type:"rect",w:24,h:32},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:14},position:{x:0,y:-28},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:5,h:26},position:{x:-18,y:0},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D",shape:{type:"rect",w:5,h:26},position:{x:18,y:0},rotation:0,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"jambe_g",name:"Jambe G",shape:{type:"rect",w:7,h:28},position:{x:-8,y:30},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"jambe_d",name:"Jambe D",shape:{type:"rect",w:7,h:28},position:{x:8,y:30},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  papillon:{name:"Papillon",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:4,ry:16},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:6},position:{x:0,y:-20},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"antenne_g",name:"Antenne G",shape:{type:"rect",w:2,h:12},position:{x:-6,y:-30},rotation:-20,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"antenne_d",name:"Antenne D",shape:{type:"rect",w:2,h:12},position:{x:6,y:-30},rotation:20,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"aile_hg",name:"Aile haute G",shape:{type:"ellipse",rx:22,ry:16},position:{x:-22,y:-8},rotation:-10,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"aile_hd",name:"Aile haute D",shape:{type:"ellipse",rx:22,ry:16},position:{x:22,y:-8},rotation:10,parent:"corps",anchor:"right",layer:-1,movable:true},
    {id:"aile_bg",name:"Aile basse G",shape:{type:"ellipse",rx:16,ry:12},position:{x:-18,y:8},rotation:-20,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"aile_bd",name:"Aile basse D",shape:{type:"ellipse",rx:16,ry:12},position:{x:18,y:8},rotation:20,parent:"corps",anchor:"right",layer:-1,movable:true}
  ]}
};

// Movement templates
const MOTION_TEMPLATES = {
  marche:{desc:"Marche altern√©e",cams:2,fn:(pieces)=>{
    const motions=[];const pattes=pieces.filter(p=>p.movable&&(p.id.includes('patte')||p.id.includes('jambe')));
    const av=pattes.filter(p=>p.id.includes('av')||p.id.includes('_g')&&!p.id.includes('ar'));
    pattes.forEach((p,i)=>{motions.push({piece_id:p.id,motion:"OSCILLATE",pivot:"top",amplitude:25,speed:"medium",phase:i%2===0?0:180,cam_profile:"smooth",cam_index:i%2});});
    return{motions,cam_count:2};
  }},
  queue:{desc:"Queue remuante",cams:1,fn:(pieces)=>{
    const q=pieces.find(p=>p.id==='queue');
    if(!q)return{motions:[],cam_count:0};
    return{motions:[{piece_id:"queue",motion:"OSCILLATE",pivot:"left",amplitude:40,speed:"medium",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  ailes:{desc:"Battement d'ailes",cams:1,fn:(pieces)=>{
    const ailes=pieces.filter(p=>p.id.includes('aile'));
    return{motions:ailes.map((a,i)=>({piece_id:a.id,motion:"OSCILLATE",pivot:"bottom",amplitude:35,speed:"medium",phase:i%2===0?0:180,cam_profile:"smooth",cam_index:0})),cam_count:1};
  }},
  tete:{desc:"Hochement de t√™te",cams:1,fn:(pieces)=>{
    const t=pieces.find(p=>p.id==='tete');
    if(!t)return{motions:[],cam_count:0};
    return{motions:[{piece_id:"tete",motion:"OSCILLATE",pivot:"bottom",amplitude:20,speed:"fast",phase:0,cam_profile:"sharp",cam_index:0}],cam_count:1};
  }},
  wave:{desc:"Bras/patte qui wave",cams:1,fn:(pieces)=>{
    const arm=pieces.find(p=>p.id.includes('bras_d')||p.id.includes('patte_wave'));
    if(!arm)return{motions:[],cam_count:0};
    return{motions:[{piece_id:arm.id,motion:"OSCILLATE",pivot:"top",amplitude:45,speed:"medium",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  nage:{desc:"Nage ‚Äî queue ondule",cams:1,fn:(pieces)=>{
    const q=pieces.find(p=>p.id==='queue');
    if(!q)return{motions:[],cam_count:0};
    return{motions:[{piece_id:"queue",motion:"OSCILLATE",pivot:"left",amplitude:30,speed:"fast",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  bob:{desc:"Corps qui plonge",cams:1,fn:(pieces)=>{
    const c=pieces.find(p=>p.id==='corps');
    if(!c)return{motions:[],cam_count:0};
    return{motions:[{piece_id:"corps",motion:"TRANSLATE_V",pivot:"center",amplitude:15,speed:"medium",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }}
};

function matchTemplate(input){
  const t=input.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  // Match animal/object
  const formKeys={chien:['chien','dog','toutou','chiot'],chat:['chat','cat','chaton','minou','kitty'],oiseau:['oiseau','bird','piaf'],canard:['canard','duck'],poisson:['poisson','fish'],dinosaure:['dinosaure','dino','trex','t-rex','rex'],robot:['robot','mecha','androide'],cheval:['cheval','horse','poney','pony'],bonhomme:['bonhomme','personnage','humain','homme','femme','personne','figure','man','person'],papillon:['papillon','butterfly']};
  let formKey=null;
  for(const[k,words]of Object.entries(formKeys)){if(words.some(w=>t.includes(w))){formKey=k;break;}}
  return formKey;
}

function matchMotions(input, pieces){
  const t=input.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  const allMotions=[];let totalCams=0;
  const motionKeys={marche:['marche','walk','avance','court','run'],queue:['queue','tail','remue'],ailes:['aile','bat','fly','vole','envol'],tete:['tete','head','hoche','nod','picore','peck'],wave:['wave','salue','bras','patte','main','hand'],nage:['nage','swim','ondule'],bob:['plonge','bob','monte','descend','bounce','saute','jump']};

  for(const[k,words]of Object.entries(motionKeys)){
    if(words.some(w=>t.includes(w))){
      const tmpl=MOTION_TEMPLATES[k];
      if(tmpl){
        const result=tmpl.fn(pieces);
        result.motions.forEach(m=>{
          m.cam_index=m.cam_index+totalCams;
          if(!allMotions.find(em=>em.piece_id===m.piece_id)) allMotions.push(m);
        });
        totalCams+=result.cam_count;
      }
    }
  }

  // If no motion matched, try smart default based on movable pieces
  if(allMotions.length===0){
    const movables=pieces.filter(p=>p.movable);
    movables.forEach((p,i)=>{
      const isLeg=p.id.includes('patte')||p.id.includes('jambe');
      const isArm=p.id.includes('bras');
      const isWing=p.id.includes('aile');
      const isTail=p.id.includes('queue');
      const isHead=p.id==='tete';
      allMotions.push({
        piece_id:p.id,
        motion:isWing?"OSCILLATE":isLeg?"OSCILLATE":isArm?"OSCILLATE":isTail?"OSCILLATE":isHead?"OSCILLATE":"TRANSLATE_V",
        pivot:isLeg?"top":isArm?"top":isWing?"bottom":isTail?"left":"center",
        amplitude:isWing?35:isLeg?25:isTail?40:isHead?20:15,
        speed:"medium",
        phase:i%2===0?0:180,
        cam_profile:"smooth",
        cam_index:Math.min(i,3)
      });
    });
    totalCams=Math.min(movables.length,4);
  }

  // Cap at 4 cams
  allMotions.forEach(m=>{m.cam_index=Math.min(m.cam_index,3);});
  totalCams=Math.min(totalCams,4);

  // Build groups
  const groups=[];
  for(let ci=0;ci<=3;ci++){
    const gp=allMotions.filter(m=>m.cam_index===ci);
    if(gp.length>0) groups.push({cam_index:ci,pieces:gp.map(m=>m.piece_id),note:gp.map(m=>m.piece_id).join('+')});
  }

  return{description:t,cam_count:totalCams||1,drive:"crank",motions:allMotions,groups};
}

/* Prompts IA gard√©s dans PROMPTS_IA.md sur GitHub pour l'int√©gration backend future */

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STEP 1: DECOMPOSE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function doDecompose(){
  const input = document.getElementById('aiInput').value.trim();
  if(!input) return;
  const btn = document.getElementById('btnDecompose');
  btn.disabled=true; btn.textContent='üß† D√©composition...';

  // Simulate brief AI thinking
  await new Promise(r=>setTimeout(r,400));

  try{
    const key = matchTemplate(input);
    if(!key){
      alert("Je ne reconnais pas encore √ßa ! Essaie : chien, chat, oiseau, canard, poisson, dinosaure, robot, cheval, bonhomme, papillon");
      btn.disabled=false; btn.textContent='üß† D√©composer en formes';
      return;
    }
    figurine = JSON.parse(JSON.stringify(TEMPLATES[key])); // deep clone
    motions = null;
    selectedPiece = null;
    goToStep(2);
    renderPiecesList();
    startRenderer();
    document.getElementById('emptyState').style.display='none';
    document.getElementById('badgeFDM').style.display='';
    document.getElementById('piecesHeader').style.display='';
    document.getElementById('statPieces').textContent=figurine.pieces.length+'p';
    document.getElementById('badgePieces').textContent=figurine.pieces.length+'p ¬∑ '+figurine.name;
    document.getElementById('badgePieces').style.display='';
  }catch(e){
    console.error(e);
    alert("Erreur: "+e.message);
  }
  btn.disabled=false; btn.textContent='üß† D√©composer en formes';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STEP 2: MOVEMENT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function doMotion(){
  const input = document.getElementById('aiMotion').value.trim();
  if(!input || !figurine) return;
  const btn = document.getElementById('btnMotion');
  btn.disabled=true; btn.textContent='‚öôÔ∏è Analyse...';

  // Simulate brief thinking
  await new Promise(r=>setTimeout(r,400));

  try{
    motions = matchMotions(input, figurine.pieces);
    goToStep(3);
    document.getElementById('statCams').textContent=motions.cam_count;
    document.getElementById('btnGenerate').disabled=false;
    renderPiecesList();
  }catch(e){
    console.error(e);
    alert("Erreur: "+e.message);
  }
  btn.disabled=false; btn.textContent='‚öôÔ∏è Assigner les mouvements';
}

function backToStep1(){
  goToStep(1);
  motions=null;
  document.getElementById('btnGenerate').disabled=true;
}

function goToStep(n){
  currentStep=n;
  document.getElementById('s1').className='step'+(n>=1?(n===1?' active':' done'):'');
  document.getElementById('s2').className='step'+(n>=2?(n===2?' active':' done'):'');
  document.getElementById('s3').className='step'+(n>=3?' active done':'');
  document.getElementById('stepDescribe').style.display=n===1?'':'none';
  document.getElementById('stepMovement').style.display=n>=2?'':'none';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PIECES LIST
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPiecesList(){
  if(!figurine) return;
  const el = document.getElementById('piecesList');
  document.getElementById('pieceCount').textContent=figurine.pieces.length+'p';
  el.innerHTML = figurine.pieces.map((p,i)=>{
    const c = COLORS[i%COLORS.length];
    const motionInfo = motions?.motions?.find(m=>m.piece_id===p.id);
    const motionIcon = motionInfo ? {TRANSLATE_V:'‚Üï',TRANSLATE_H:'‚Üî',OSCILLATE:'üîÑ',ROTATE:'‚ü≥'}[motionInfo.motion]||'' : '';
    return `<div class="piece-item${selectedPiece===p.id?' selected':''}" onclick="selectPiece('${p.id}')">
      <div class="piece-dot" style="background:${c}"></div>
      <span class="piece-name">${p.name}</span>
      <span class="piece-shape">${p.shape.type}</span>
      ${motionIcon?`<span style="font-size:.7rem">${motionIcon}</span>`:''}
      <span class="piece-movable${p.movable?' on':''}" onclick="event.stopPropagation();toggleMovable('${p.id}')">${p.movable?'‚ö°':'‚óã'}</span>
    </div>`;
  }).join('');
}

function selectPiece(id){
  selectedPiece=selectedPiece===id?null:id;
  renderPiecesList();
  // Update right panel to reflect selected piece's params
  if(selectedPiece && motions){
    const m = motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m){
      document.querySelectorAll('.motion-btn').forEach(b=>b.classList.remove('active'));
      const moId={TRANSLATE_V:'mo_tv',TRANSLATE_H:'mo_th',OSCILLATE:'mo_osc',ROTATE:'mo_rot'}[m.motion];
      if(moId)document.getElementById(moId)?.classList.add('active');
      document.getElementById('slAmp').value=m.amplitude;
      updateParam();
    }
  }
}
function toggleMovable(id){
  const p=figurine.pieces.find(p=>p.id===id);
  if(p){p.movable=!p.movable;renderPiecesList();}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RIGHT PANEL CONTROLS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setShape(type){
  document.querySelectorAll('.shape-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('sh_'+type)?.classList.add('active');
  if(selectedPiece && figurine){
    const p=figurine.pieces.find(pp=>pp.id===selectedPiece);
    if(p){
      const defaults={circle:{type:'circle',r:15},rect:{type:'rect',w:30,h:20},tri:{type:'tri',base:20,h:18},square:{type:'square',s:20},ellipse:{type:'ellipse',rx:25,ry:15},diamond:{type:'diamond',w:20,h:25}};
      p.shape=defaults[type]||p.shape;
      renderPiecesList();
    }
  }
}

function setMotion(type){
  document.querySelectorAll('.motion-btn').forEach(b=>b.classList.remove('active'));
  const moId={TRANSLATE_V:'mo_tv',TRANSLATE_H:'mo_th',OSCILLATE:'mo_osc',ROTATE:'mo_rot'}[type];
  if(moId) document.getElementById(moId)?.classList.add('active');
  if(selectedPiece && motions){
    const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m) m.motion=type;
  }
}

function setPhase(deg){
  document.querySelectorAll('.phase-row .phase-btn').forEach(b=>b.classList.remove('on'));
  event.target.classList.add('on');
  if(selectedPiece && motions){
    const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m) m.phase=deg;
  }
}
function setProfile(prof){
  document.querySelectorAll('.profile-row .prof-btn').forEach(b=>b.classList.remove('on'));
  event.target.classList.add('on');
  if(selectedPiece && motions){
    const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m) m.cam_profile=prof;
  }
}
function setPivot(piv){
  // handled by onclick, update motion
  if(selectedPiece && motions){
    const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m) m.pivot=piv;
  }
}

function updateParam(){
  const amp=document.getElementById('slAmp').value;
  const spd=document.getElementById('slSpeed').value;
  const sz=document.getElementById('slSize').value;
  const speeds=[0.25,0.5,1,1.5,2,3];
  document.getElementById('valAmp').textContent=amp+'¬∞';
  document.getElementById('valSpeed').textContent=speeds[spd-1]+' Hz';
  document.getElementById('valSize').textContent=sz+'%';
  if(selectedPiece && motions){
    const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m){m.amplitude=+amp;m.speed=speeds[spd-1]<=0.5?'slow':speeds[spd-1]<=1.5?'medium':'fast';}
  }
}

function doGenerate(){
  alert("üî© G√©n√©ration STL en cours...\n\nJSON formes: "+figurine.pieces.length+" pi√®ces\nJSON mouvements: "+motions.cam_count+" cames\nDrive: "+(drive===0?"Manivelle":"Moteur")+"\n\n‚Üí Pr√™t pour automata_unified_v4.py");
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   3D RENDERER
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startRenderer(){
  const cv=document.getElementById('mainCanvas');
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const ctx=cv.getContext('2d');
  let f=0, dragging=false, lastX=0, pinchDist=0;

  function resize(){cv.width=cv.parentElement.offsetWidth*dpr;cv.height=cv.parentElement.offsetHeight*dpr;}
  resize(); window.addEventListener('resize',resize);

  // Controls
  cv.onmousedown=e=>{dragging=true;lastX=e.clientX;autoRotate=false;};
  cv.onmousemove=e=>{if(dragging){rotAngle+=(e.clientX-lastX)*0.008;lastX=e.clientX;}};
  cv.onmouseup=cv.onmouseleave=()=>{dragging=false;};
  cv.onwheel=e=>{e.preventDefault();zoom*=e.deltaY>0?0.92:1.08;zoom=Math.max(0.4,Math.min(4,zoom));};
  cv.ontouchstart=e=>{if(e.touches.length===2){const dx=e.touches[0].clientX-e.touches[1].clientX;const dy=e.touches[0].clientY-e.touches[1].clientY;pinchDist=Math.sqrt(dx*dx+dy*dy);}else{dragging=true;lastX=e.touches[0].clientX;autoRotate=false;}};
  cv.ontouchmove=e=>{e.preventDefault();if(e.touches.length===2){const dx=e.touches[0].clientX-e.touches[1].clientX;const dy=e.touches[0].clientY-e.touches[1].clientY;const d=Math.sqrt(dx*dx+dy*dy);if(pinchDist>0){zoom*=d/pinchDist;zoom=Math.max(0.4,Math.min(4,zoom));}pinchDist=d;}else if(dragging){rotAngle+=(e.touches[0].clientX-lastX)*0.008;lastX=e.touches[0].clientX;}};
  cv.ontouchend=()=>{dragging=false;pinchDist=0;};

  window.zoomIn=()=>{zoom=Math.min(zoom*1.25,4);};
  window.zoomOut=()=>{zoom=Math.max(zoom/1.25,0.4);};
  window.zoomReset=()=>{zoom=1;panX=0;panY=0;autoRotate=true;};

  function draw(){
    f++;
    if(autoRotate) rotAngle=f*0.004;
    const w=cv.width, h=cv.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle='#08080f';ctx.fillRect(0,0,w,h);
    if(!figurine){anim=requestAnimationFrame(draw);return;}

    const cx=w/2+panX, cy=h/2+panY;
    const sc=Math.min(w,h)/300*zoom;
    const cr=Math.cos(rotAngle), sr=Math.sin(rotAngle);

    // 3D projection
    function proj(x,y,z){
      return[cx+(x*cr-y*sr*0.55)*sc, cy+(-z*0.82+x*sr*0.32+y*cr*0.32)*sc];
    }

    // Grid
    ctx.globalAlpha=0.06;ctx.strokeStyle='#60a5fa';ctx.lineWidth=0.5;
    for(let i=-6;i<=6;i++){
      let[x1,y1]=proj(i*20,-120,0),[x2,y2]=proj(i*20,120,0);ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();
      let[x3,y3]=proj(-120,i*20,0),[x4,y4]=proj(120,i*20,0);ctx.beginPath();ctx.moveTo(x3,y3);ctx.lineTo(x4,y4);ctx.stroke();
    }
    ctx.globalAlpha=1;

    // Cam animation
    const camAngle=f*0.02;
    const camLift=9*Math.sin(camAngle)+4*Math.sin(camAngle*1.3);

    // ‚îÄ‚îÄ CHASSIS BOX (smaller, underneath) ‚îÄ‚îÄ
    const bw=40,bd=28,bh=30;
    const boxVerts=[[-bw/2,-bd/2,0],[bw/2,-bd/2,0],[bw/2,bd/2,0],[-bw/2,bd/2,0],[-bw/2,-bd/2,bh],[bw/2,-bd/2,bh],[bw/2,bd/2,bh],[-bw/2,bd/2,bh]].map(v=>proj(...v));
    const boxFaces=[[0,1,5,4],[1,2,6,5],[2,3,7,6],[3,0,4,7],[4,5,6,7]];
    boxFaces.forEach(face=>{
      ctx.strokeStyle='rgba(255,107,53,.25)';ctx.fillStyle='rgba(255,107,53,.02)';ctx.lineWidth=1.2;
      ctx.beginPath();face.forEach((vi,i)=>{i===0?ctx.moveTo(...boxVerts[vi]):ctx.lineTo(...boxVerts[vi]);});ctx.closePath();ctx.fill();ctx.stroke();
    });

    // ‚îÄ‚îÄ SHAFT ‚îÄ‚îÄ
    const shZ=bh*0.5;
    const[sx1,sy1]=proj(0,-bd*0.85,shZ),[sx2,sy2]=proj(0,bd*0.85,shZ);
    ctx.strokeStyle='rgba(255,255,255,.15)';ctx.lineWidth=2.5;ctx.beginPath();ctx.moveTo(sx1,sy1);ctx.lineTo(sx2,sy2);ctx.stroke();

    // ‚îÄ‚îÄ CAM ‚îÄ‚îÄ
    const nCams=motions?motions.cam_count:1;
    for(let ci=0;ci<Math.min(nCams,4);ci++){
      const ca=camAngle+ci*Math.PI*0.6;
      const yOff=(ci-(Math.min(nCams,4)-1)/2)*(bd*0.4/Math.max(Math.min(nCams,4)-1,1));
      const baseR=13-ci;
      ctx.strokeStyle=['#ff6b35','#ff8c5a','#ffad85','#ffd0b5'][ci];ctx.fillStyle='rgba(255,107,53,.04)';ctx.lineWidth=2;
      ctx.beginPath();
      for(let i=0;i<=48;i++){const t=(i/48)*Math.PI*2;const r=baseR+4*Math.sin(t*2+ca)+1.5*Math.sin(t*3+ca*1.3);const[px,py]=proj(r*Math.cos(t),yOff+r*Math.sin(t)*0.3,shZ);i===0?ctx.moveTo(px,py):ctx.lineTo(px,py);}
      ctx.closePath();ctx.fill();ctx.stroke();

      // Follower
      const lift=4*Math.sin(ca)+1.5*Math.sin(ca*1.3);
      const[f1x,f1y]=proj(0,yOff,shZ+baseR);
      const[f2x,f2y]=proj(0,yOff,shZ+baseR+lift+10);
      ctx.strokeStyle='#fbbf24';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(f1x,f1y);ctx.lineTo(f2x,f2y);ctx.stroke();
    }

    // ‚îÄ‚îÄ DRIVE ‚îÄ‚îÄ
    if(drive===0){
      const cA=camAngle;const[hx,hy]=proj(0,-bd*0.85-6,shZ);
      const[hex,hey]=proj(12*Math.cos(cA),-bd*0.85-6+12*Math.sin(cA)*0.3,shZ);
      ctx.strokeStyle='rgba(96,165,250,.4)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(hx,hy);ctx.lineTo(hex,hey);ctx.stroke();
      ctx.fillStyle='rgba(96,165,250,.15)';ctx.beginPath();ctx.arc(hex,hey,3,0,Math.PI*2);ctx.fill();ctx.stroke();
    }else{
      const[mx,my]=proj(bw/2+10,-bd/3,bh*0.2);
      ctx.strokeStyle='rgba(255,107,53,.3)';ctx.fillStyle='rgba(255,107,53,.05)';ctx.lineWidth=1.5;
      ctx.beginPath();ctx.arc(mx,my,8,0,Math.PI*2);ctx.fill();ctx.stroke();
      ctx.fillStyle='rgba(255,107,53,.3)';ctx.font=`bold ${8}px 'DM Sans'`;ctx.textAlign='center';ctx.fillText('M',mx,my+3);
    }

    // ‚îÄ‚îÄ FIGURINE PIECES (assembled, true proportions in mm) ‚îÄ‚îÄ
    const figBaseZ=bh+12;
    const mmToPx=sc*1.4; // 1mm = this many pixels
    const explode=window._explode||false;

    // Build position map using ABSOLUTE positions from JSON (already correct)
    const posMap={};
    function getShapeSize(s){
      if(s.type==='circle') return{w:s.r*2,h:s.r*2};
      if(s.type==='ellipse') return{w:s.rx*2,h:s.ry*2};
      if(s.type==='rect') return{w:s.w,h:s.h};
      if(s.type==='square') return{w:s.s,h:s.s};
      if(s.type==='tri') return{w:s.base,h:s.h};
      if(s.type==='diamond') return{w:s.w,h:s.h};
      return{w:20,h:20};
    }

    figurine.pieces.forEach(p=>{
      const sz=getShapeSize(p.shape);
      let fx=p.position.x;
      let fy=p.position.y;
      // Explode: push outward from center
      if(explode){fx*=1.6;fy*=1.6;}
      posMap[p.id]={x:fx,y:fy,sz};
    });

    // Sort by layer for proper overlap
    const sortedPieces=[...figurine.pieces].sort((a,b)=>(a.layer||0)-(b.layer||0));

    sortedPieces.forEach((p)=>{
      const ci=figurine.pieces.indexOf(p);
      const c=COLORS[ci%COLORS.length];
      const isSel=p.id===selectedPiece;
      const pos=posMap[p.id];

      // Convert mm to 3D space
      const px3d=pos.x*mmToPx/sc;
      const pz3d=figBaseZ - pos.y*mmToPx/sc;

      // Animation offset
      let animOffZ=0, animOffX=0, animRot=0;
      if(motions){
        const m=motions.motions.find(mo=>mo.piece_id===p.id);
        if(m){
          const phaseRad=m.phase*Math.PI/180;
          const speed=m.speed==='slow'?0.5:m.speed==='fast'?2:1;
          const t=f*0.025*speed+phaseRad;
          const prof=m.cam_profile==='sharp'?Math.sign(Math.sin(t))*Math.pow(Math.abs(Math.sin(t)),0.5):m.cam_profile==='dwell'?Math.round(Math.sin(t)*3)/3:Math.sin(t);
          if(m.motion==='TRANSLATE_V') animOffZ=prof*m.amplitude*0.3;
          else if(m.motion==='TRANSLATE_H') animOffX=prof*m.amplitude*0.3;
          else if(m.motion==='OSCILLATE') animRot=prof*m.amplitude*Math.PI/180;
          else if(m.motion==='ROTATE') animRot=f*0.03*speed;
        }
      }

      const[sx,sy]=proj(px3d+animOffX,0,pz3d+animOffZ);
      const sz=pos.sz;

      // Real mm dimensions ‚Üí pixel dimensions
      const rw=sz.w*mmToPx;
      const rh=sz.h*mmToPx;

      // Colors
      ctx.strokeStyle=c;
      ctx.fillStyle=c+(isSel?'30':'15');
      ctx.lineWidth=isSel?2.8:1.6;
      if(isSel){ctx.shadowColor=c;ctx.shadowBlur=16;}

      ctx.save();
      ctx.translate(sx,sy);

      // Apply rotation
      const totalRot=(p.rotation||0)*Math.PI/180 + animRot;
      if(totalRot) ctx.rotate(totalRot);

      ctx.beginPath();
      if(sz.w<1&&sz.h<1){/* skip tiny */}
      else if(p.shape.type==='circle'){
        ctx.arc(0,0,rw/2,0,Math.PI*2);
      }else if(p.shape.type==='ellipse'){
        ctx.ellipse(0,0,rw/2,rh/2,0,0,Math.PI*2);
      }else if(p.shape.type==='rect'||p.shape.type==='square'){
        ctx.roundRect(-rw/2,-rh/2,rw,rh,1.5);
      }else if(p.shape.type==='tri'){
        ctx.moveTo(0,-rh/2);ctx.lineTo(rw/2,rh/2);ctx.lineTo(-rw/2,rh/2);
      }else if(p.shape.type==='diamond'){
        ctx.moveTo(0,-rh/2);ctx.lineTo(rw/2,0);ctx.lineTo(0,rh/2);ctx.lineTo(-rw/2,0);
      }
      ctx.closePath();ctx.fill();ctx.stroke();
      ctx.shadowBlur=0;

      // Label
      ctx.fillStyle=c+'BB';
      ctx.font=`600 ${Math.max(7,9*zoom)}px 'DM Sans'`;
      ctx.textAlign='center';
      ctx.fillText(p.name,0,-rh/2-5);

      if(p.movable){
        ctx.fillStyle=c+'70';
        ctx.font=`${7*zoom}px 'JetBrains Mono'`;
        ctx.fillText('‚ö°',rw/2+5,3);
      }

      ctx.restore();

      // Connection line to parent (when exploded)
      if(explode && p.parent!=='root'){
        const pp=posMap[p.parent];
        if(pp){
          const[ppx,ppy]=proj(pp.x*mmToPx/sc,0,figBaseZ-pp.y*mmToPx/sc);
          ctx.strokeStyle=c+'30';ctx.lineWidth=0.8;ctx.setLineDash([3,3]);
          ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(ppx,ppy);ctx.stroke();
          ctx.setLineDash([]);
        }
      }
    });

    // ‚îÄ‚îÄ LEGEND (bottom-left, compact) ‚îÄ‚îÄ
    const lx=8,ly=h-figurine.pieces.length*12-10,lh=12;
    ctx.font=`${8}px 'JetBrains Mono'`;ctx.textAlign='left';
    ctx.fillStyle='rgba(6,6,10,.8)';
    ctx.fillRect(lx-3,ly-4,95,figurine.pieces.length*lh+8);
    figurine.pieces.forEach((p,i)=>{
      const c=COLORS[i%COLORS.length];
      ctx.fillStyle=c;ctx.fillRect(lx,ly+i*lh,6,6);
      ctx.fillStyle='rgba(255,255,255,.45)';
      ctx.fillText(p.name,lx+10,ly+i*lh+6);
    });

    document.getElementById('statZoom').textContent='√ó'+zoom.toFixed(1);
    anim=requestAnimationFrame(draw);
  }

  if(anim) cancelAnimationFrame(anim);
  draw();
}

window._explode=false;
function toggleExplode(){
  window._explode=!window._explode;
  const btn=document.getElementById('btnExplode');
  btn.style.background=window._explode?'rgba(255,107,53,.2)':'';
  btn.style.borderColor=window._explode?'var(--ac)':'';
  btn.style.color=window._explode?'var(--ac)':'';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
goToStep(1);
</script>
</body>
</html>