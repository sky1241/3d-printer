<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üî© Automata Generator V7</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;0,9..40,900;1,9..40,400&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#06060a;--s1:#0c0c14;--s2:#13131f;--s3:#1e1e32;--s4:#2a2a44;
  --t1:#e8e6f0;--t2:#7a7894;--t3:#4a4866;
  --ac:#ff6b35;--ac2:#ff8c5a;--acg:rgba(255,107,53,.08);
  --ok:#34d399;--warn:#fbbf24;--err:#f87171;
  --blu:#60a5fa;--blug:rgba(96,165,250,.08);
  --r:10px
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;overflow:hidden;-webkit-font-smoothing:antialiased}
.mono{font-family:'JetBrains Mono',monospace}

/* ‚ïê‚ïê‚ïê LAYOUT 3 COLONNES ‚ïê‚ïê‚ïê */
.app{display:grid;grid-template-columns:280px 1fr 260px;grid-template-rows:52px 1fr;height:100vh;gap:0}

/* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
.topbar{grid-column:1/-1;display:flex;align-items:center;padding:0 16px;background:var(--s1);border-bottom:1px solid var(--s3)}
.topbar-icon{width:32px;height:32px;background:var(--ac);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 12px rgba(255,107,53,.2);margin-right:10px}
.topbar h1{font-size:.95rem;font-weight:900;letter-spacing:-.02em}
.topbar-tag{font-size:.55rem;color:var(--t3);margin-left:8px;padding:2px 6px;background:var(--s3);border-radius:4px}.topbar-tag.mono{letter-spacing:.04em}
.topbar-drive{margin-left:auto;display:flex;align-items:center;gap:8px}
.drive-chip{display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:6px;border:1px solid var(--s3);background:var(--s2);cursor:pointer;font-size:.7rem;font-weight:700;color:var(--t3);transition:all .15s;font-family:'DM Sans'}
.drive-chip.on{border-color:var(--ac);color:var(--ac);background:var(--acg)}
.drive-chip.on-b{border-color:var(--blu);color:var(--blu);background:var(--blug)}
.topbar-gen{margin-left:12px;padding:6px 16px;border-radius:7px;border:none;background:var(--ac);color:#fff;font-weight:800;font-size:.72rem;cursor:pointer;font-family:'DM Sans';letter-spacing:.02em;transition:all .15s;box-shadow:0 2px 12px rgba(255,107,53,.25)}
.topbar-gen:hover{background:var(--ac2);transform:translateY(-1px)}
.topbar-gen:disabled{opacity:.4;cursor:not-allowed;transform:none}

/* ‚îÄ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ‚îÄ */
.left{background:var(--s1);border-right:1px solid var(--s3);display:flex;flex-direction:column;overflow:hidden}
.panel-h{padding:10px 14px 8px;font-size:.65rem;font-weight:700;color:var(--t3);letter-spacing:.06em;text-transform:uppercase;display:flex;align-items:center;gap:6px;border-bottom:1px solid rgba(255,255,255,.03)}
.panel-h .dot{width:5px;height:5px;border-radius:50%;background:var(--ac)}
.panel-h .dot-b{width:5px;height:5px;border-radius:50%;background:var(--blu)}

/* AI Input */
.ai-input-wrap{padding:10px 12px}
.ai-input{width:100%;min-height:70px;max-height:140px;resize:vertical;background:var(--s2);border:1px solid var(--s3);border-radius:8px;color:var(--t1);padding:10px 12px;font-family:'DM Sans',sans-serif;font-size:.78rem;line-height:1.5;outline:none;transition:border-color .15s}
.ai-input::placeholder{color:var(--t3)}
.ai-input:focus{border-color:var(--ac)}
.ai-btn{width:100%;padding:9px;border:none;border-radius:7px;font-weight:800;font-size:.72rem;cursor:pointer;font-family:'DM Sans';letter-spacing:.02em;transition:all .15s;margin-top:6px}
.ai-btn.primary{background:var(--ac);color:#fff;box-shadow:0 2px 10px rgba(255,107,53,.2)}
.ai-btn.primary:hover{background:var(--ac2)}
.ai-btn.secondary{background:var(--s3);color:var(--t2)}
.ai-btn.secondary:hover{background:var(--s4);color:var(--t1)}
.ai-btn:disabled{opacity:.35;cursor:not-allowed}

/* Step indicator */
.steps{display:flex;padding:8px 12px;gap:4px}
.step{flex:1;height:3px;border-radius:2px;background:var(--s3);transition:background .3s}
.step.done{background:var(--ok)}
.step.active{background:var(--ac);box-shadow:0 0 8px rgba(255,107,53,.3)}

/* Pieces list */
.pieces-list{flex:1;overflow-y:auto;padding:4px 8px}
.piece-item{display:flex;align-items:center;gap:8px;padding:7px 8px;border-radius:7px;cursor:pointer;transition:all .12s;border:1px solid transparent;margin-bottom:2px}
.piece-item:hover{background:var(--s2);border-color:var(--s3)}
.piece-item.selected{background:var(--acg);border-color:rgba(255,107,53,.2)}
.piece-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.piece-name{font-size:.72rem;font-weight:600;flex:1}
.piece-shape{font-size:.58rem;color:var(--t3);font-family:'JetBrains Mono'}
.piece-movable{font-size:.65rem;cursor:pointer;opacity:.5;transition:opacity .15s}
.piece-movable.on{opacity:1}

/* ‚îÄ‚îÄ‚îÄ CENTER CANVAS ‚îÄ‚îÄ‚îÄ */
.center{position:relative;background:var(--bg);display:flex;flex-direction:column}
.canvas-wrap{flex:1;position:relative;overflow:hidden}
.canvas-wrap canvas{width:100%;height:100%;display:block}
.cv-badge{position:absolute;bottom:10px;left:10px;font-size:.55rem;padding:3px 8px;border-radius:5px;font-weight:700;letter-spacing:.02em}
.cv-badge.ok{background:rgba(52,211,153,.12);color:var(--ok);border:1px solid rgba(52,211,153,.15)}
.cv-badge.tag{background:rgba(255,107,53,.08);color:var(--ac);border:1px solid rgba(255,107,53,.12)}
.cv-hint{position:absolute;bottom:10px;right:10px;font-size:.52rem;color:var(--t3)}
.zoom-bar{position:absolute;top:10px;right:10px;display:flex;gap:3px}
.zoom-bar button{width:26px;height:26px;border:1px solid var(--s3);background:rgba(6,6,10,.85);color:var(--t2);border-radius:6px;font-size:.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s}
.zoom-bar button:hover{background:var(--s3);color:var(--t1)}
/* Status bar */
.status-bar{display:flex;align-items:center;padding:6px 12px;background:var(--s1);border-top:1px solid var(--s3);gap:8px}
.stat{font-size:.6rem;color:var(--t3);display:flex;align-items:center;gap:4px}
.stat .v{color:var(--ac);font-weight:700;font-family:'JetBrains Mono'}
.stat .v-b{color:var(--blu);font-weight:700;font-family:'JetBrains Mono'}

/* ‚îÄ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ‚îÄ */
.right{background:var(--s1);border-left:1px solid var(--s3);display:flex;flex-direction:column;overflow-y:auto}

/* Shape buttons */
.shape-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;padding:8px 10px}
.shape-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;border-radius:7px;border:1px solid var(--s3);background:var(--s2);cursor:pointer;transition:all .12s}
.shape-btn:hover{border-color:var(--ac);background:var(--acg)}
.shape-btn.active{border-color:var(--ac);background:var(--acg);box-shadow:0 0 8px rgba(255,107,53,.15)}
.shape-btn svg{width:24px;height:24px}
.shape-btn span{font-size:.55rem;font-weight:700;color:var(--t2)}

/* Motion buttons */
.motion-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:4px;padding:8px 10px}
.motion-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 4px;border-radius:7px;border:1px solid var(--s3);background:var(--s2);cursor:pointer;transition:all .12s}
.motion-btn:hover{border-color:var(--blu);background:var(--blug)}
.motion-btn.active{border-color:var(--blu);background:var(--blug);box-shadow:0 0 8px rgba(96,165,250,.15)}
.motion-btn .ico{font-size:1.1rem}
.motion-btn span{font-size:.55rem;font-weight:700;color:var(--t2)}

/* Sliders */
.slider-group{padding:6px 10px}
.slider-row{margin-bottom:8px}
.slider-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.slider-label span{font-size:.6rem;font-weight:600;color:var(--t2)}
.slider-label .val{font-family:'JetBrains Mono';color:var(--ac);font-weight:700;font-size:.6rem}
.slider-label .val-b{font-family:'JetBrains Mono';color:var(--blu);font-weight:700;font-size:.6rem}
input[type=range]{-webkit-appearance:none;width:100%;height:4px;background:var(--s3);border-radius:2px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--ac);border-radius:50%;cursor:pointer;box-shadow:0 1px 6px rgba(255,107,53,.3)}
input[type=range].blu::-webkit-slider-thumb{background:var(--blu);box-shadow:0 1px 6px rgba(96,165,250,.3)}

/* Phase selector */
.phase-row{display:flex;gap:3px;padding:4px 10px 8px}
.phase-btn{flex:1;padding:6px;border:1px solid var(--s3);background:var(--s2);border-radius:5px;font-size:.6rem;font-weight:700;color:var(--t3);cursor:pointer;text-align:center;font-family:'JetBrains Mono';transition:all .12s}
.phase-btn.on{border-color:var(--blu);color:var(--blu);background:var(--blug)}

/* Profile selector */
.profile-row{display:flex;gap:3px;padding:4px 10px 8px}
.prof-btn{flex:1;padding:6px 4px;border:1px solid var(--s3);background:var(--s2);border-radius:5px;font-size:.55rem;font-weight:700;color:var(--t3);cursor:pointer;text-align:center;transition:all .12s}
.prof-btn.on{border-color:var(--warn);color:var(--warn);background:rgba(251,191,36,.08)}

/* Divider */
.divider{height:1px;background:var(--s3);margin:4px 10px}

/* Loading */
.loading{display:flex;align-items:center;gap:6px;padding:8px 12px;font-size:.7rem;color:var(--ac)}
.loading .spin{width:14px;height:14px;border:2px solid var(--s3);border-top-color:var(--ac);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* AI Response preview */
.ai-response{padding:6px 10px;font-size:.6rem;color:var(--ok);font-family:'JetBrains Mono';background:rgba(52,211,153,.04);border-radius:6px;margin:4px 12px;max-height:60px;overflow-y:auto;border:1px solid rgba(52,211,153,.08)}

/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--s3);border-radius:2px}

/* Empty state */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:10px;padding:20px}
.empty-state .big{font-size:2.5rem}
.empty-state p{font-size:.75rem;color:var(--t3);text-align:center;line-height:1.5;max-width:280px}
.empty-state .hint{font-size:.65rem;color:var(--t3);font-style:italic}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê TOP BAR ‚ïê‚ïê‚ïê -->
<div class="app">
<div class="topbar">
  <div class="topbar-icon">üî©</div>
  <h1>Automata Generator</h1>
  <span class="topbar-tag mono">V7</span>
  <div class="topbar-drive">
    <div class="drive-chip on-b" id="dCrank" onclick="setDrive(0)"><span>üñêÔ∏è</span> Manivelle</div>
    <div class="drive-chip" id="dMotor" onclick="setDrive(1)"><span>‚ö°</span> Moteur</div>
    <button class="topbar-gen" id="btnGenerate" disabled onclick="doGenerate()">‚¨á G√âN√âRER STL</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LEFT PANEL ‚ïê‚ïê‚ïê -->
<div class="left">
  <!-- Steps -->
  <div class="steps">
    <div class="step active" id="s1"></div>
    <div class="step" id="s2"></div>
    <div class="step" id="s3"></div>
  </div>

  <!-- Step 1: Describe -->
  <div id="stepDescribe">
    <div class="panel-h"><div class="dot"></div> √âTAPE 1 ‚Äî D√âCRIS TA FIGURINE</div>
    <div class="ai-input-wrap">
      <textarea class="ai-input" id="aiInput" placeholder="Ex: un chien, un oiseau qui vole, un robot, un dinosaure..."></textarea>
      <button class="ai-btn primary" id="btnDecompose" onclick="doDecompose()">üß† D√©composer en formes</button>
    </div>
  </div>

  <!-- Step 2: Movement -->
  <div id="stepMovement" style="display:none">
    <div class="panel-h"><div class="dot-b"></div> √âTAPE 2 ‚Äî D√âCRIS LE MOUVEMENT</div>
    <div class="ai-input-wrap">
      <textarea class="ai-input" id="aiMotion" placeholder="Ex: il remue la queue, il bat des ailes, il marche..."></textarea>
      <button class="ai-btn primary" style="background:var(--blu);box-shadow:0 2px 10px rgba(96,165,250,.2)" id="btnMotion" onclick="doMotion()">‚öôÔ∏è Assigner les mouvements</button>
      <button class="ai-btn secondary" style="margin-top:4px" onclick="backToStep1()">‚Üê Modifier les formes</button>
    </div>
  </div>

  <!-- Pieces list -->
  <div class="panel-h" id="piecesHeader" style="display:none"><div class="dot"></div> PI√àCES <span id="pieceCount" style="margin-left:auto;font-size:.6rem;color:var(--ac)" class="mono"></span></div>
  <div class="pieces-list" id="piecesList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê CENTER CANVAS ‚ïê‚ïê‚ïê -->
<div class="center">
  <div class="canvas-wrap">
    <canvas id="mainCanvas"></canvas>
    <div id="mechView3D" style="position:absolute;bottom:0;left:0;right:0;height:42%;border-top:1px solid rgba(255,255,255,.06);display:none;background:#111;"></div>
    <div class="zoom-bar">
      <button onclick="toggleExplode()" id="btnExplode" title="Vue √©clat√©e">üí•</button>
      <button onclick="zoomIn()">Ôºã</button>
      <button onclick="zoomReset()">‚ü≥</button>
      <button onclick="zoomOut()">Ôºç</button>
    </div>
    <div class="cv-badge ok" id="badgeFDM" style="display:none">‚úì FDM valid√©</div>
    <div class="cv-badge tag" id="badgePieces" style="display:none"></div>
    <div class="cv-hint" id="cvHint">‚Üî glisse pour tourner ¬∑ scroll pour zoomer</div>

    <!-- Empty state -->
    <div class="empty-state" id="emptyState">
      <div class="big">üé®</div>
      <p><strong>D√©cris ce que tu veux</strong><br>Tape une description √† gauche et l'IA d√©compose ta figurine en formes g√©om√©triques</p>
      <span class="hint">"un chien qui remue la queue"</span>
    </div>
  </div>
  <div class="status-bar">
    <div class="stat">Pi√®ces <span class="v" id="statPieces">‚Äî</span></div>
    <div class="stat">Cames <span class="v" id="statCams">‚Äî</span></div>
    <div class="stat">Drive <span class="v-b" id="statDrive">Manivelle</span></div>
    <div class="stat" style="margin-left:auto">Zoom <span class="v mono" id="statZoom">√ó1.0</span></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê RIGHT PANEL ‚ïê‚ïê‚ïê -->
<div class="right">
  <!-- Shapes section -->
  <div class="panel-h"><div class="dot"></div> FORMES DE BASE</div>
  <div class="shape-grid">
    <div class="shape-btn" onclick="setShape('circle')" id="sh_circle">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><circle cx="12" cy="12" r="9"/></svg>
      <span>Cercle</span>
    </div>
    <div class="shape-btn" onclick="setShape('rect')" id="sh_rect">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><rect x="4" y="6" width="16" height="12" rx="1"/></svg>
      <span>Rectangle</span>
    </div>
    <div class="shape-btn" onclick="setShape('tri')" id="sh_tri">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><polygon points="12,3 22,21 2,21"/></svg>
      <span>Triangle</span>
    </div>
    <div class="shape-btn" onclick="setShape('square')" id="sh_square">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><rect x="5" y="5" width="14" height="14" rx="1"/></svg>
      <span>Carr√©</span>
    </div>
    <div class="shape-btn" onclick="setShape('ellipse')" id="sh_ellipse">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><ellipse cx="12" cy="12" rx="10" ry="6"/></svg>
      <span>Ellipse</span>
    </div>
    <div class="shape-btn" onclick="setShape('diamond')" id="sh_diamond">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><polygon points="12,2 22,12 12,22 2,12"/></svg>
      <span>Losange</span>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Movement section -->
  <div class="panel-h"><div class="dot-b"></div> MOUVEMENTS</div>
  <div class="motion-grid">
    <div class="motion-btn" onclick="setMotion('TRANSLATE_V')" id="mo_tv">
      <span class="ico">‚ÜïÔ∏è</span>
      <span>Monte/Descend</span>
    </div>
    <div class="motion-btn" onclick="setMotion('TRANSLATE_H')" id="mo_th">
      <span class="ico">‚ÜîÔ∏è</span>
      <span>Gauche/Droite</span>
    </div>
    <div class="motion-btn" onclick="setMotion('OSCILLATE')" id="mo_osc">
      <span class="ico">üîÑ</span>
      <span>Oscillation</span>
    </div>
    <div class="motion-btn" onclick="setMotion('ROTATE')" id="mo_rot">
      <span class="ico">‚ü≥</span>
      <span>Rotation</span>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Sliders -->
  <div class="panel-h"><div class="dot"></div> PARAM√àTRES</div>
  <div class="slider-group">
    <div class="slider-row">
      <div class="slider-label"><span>Amplitude</span><span class="val" id="valAmp">30¬∞</span></div>
      <input type="range" min="5" max="90" value="30" id="slAmp" oninput="updateParam()">
    </div>
    <div class="slider-row">
      <div class="slider-label"><span>Vitesse</span><span class="val-b" id="valSpeed">1.0 Hz</span></div>
      <input type="range" class="blu" min="1" max="6" value="2" step="1" id="slSpeed" oninput="updateParam()">
    </div>
    <div class="slider-row">
      <div class="slider-label"><span>Taille pi√®ce</span><span class="val" id="valSize">100%</span></div>
      <input type="range" min="50" max="200" value="100" id="slSize" oninput="updateParam()">
    </div>
  </div>

  <!-- Phase -->
  <div class="panel-h"><div class="dot-b"></div> PHASE</div>
  <div class="phase-row">
    <div class="phase-btn on" onclick="setPhase(0)">0¬∞</div>
    <div class="phase-btn" onclick="setPhase(90)">90¬∞</div>
    <div class="phase-btn" onclick="setPhase(180)">180¬∞</div>
    <div class="phase-btn" onclick="setPhase(270)">270¬∞</div>
  </div>

  <!-- Cam profile -->
  <div class="panel-h"><div class="dot"></div> PROFIL CAME</div>
  <div class="profile-row">
    <div class="prof-btn on" onclick="setProfile('smooth')">Smooth</div>
    <div class="prof-btn" onclick="setProfile('sharp')">Sharp</div>
    <div class="prof-btn" onclick="setProfile('dwell')">Dwell</div>
  </div>

  <div class="divider"></div>

  <!-- Pivot -->
  <div class="panel-h"><div class="dot-b"></div> PIVOT</div>
  <div class="phase-row">
    <div class="phase-btn" onclick="setPivot('top')">‚Üë Haut</div>
    <div class="phase-btn on" onclick="setPivot('center')">‚äï Centre</div>
    <div class="phase-btn" onclick="setPivot('bottom')">‚Üì Bas</div>
  </div>
  <div class="phase-row" style="padding-top:0">
    <div class="phase-btn" onclick="setPivot('left')">‚Üê Gauche</div>
    <div class="phase-btn" onclick="setPivot('right')">‚Üí Droite</div>
  </div>
</div>

</div><!-- /app -->

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let figurine = null;     // JSON from prompt 1
let motions = null;      // JSON from prompt 2
let drive = 0;           // 0=crank, 1=motor
let selectedPiece = null;
let currentStep = 1;
let zoom = 1, panX = 0, panY = 0, rotAngle = 0, autoRotate = true;
let anim = null;

// Piece colors
const COLORS = [
  '#34d399','#60a5fa','#f472b6','#fbbf24','#a78bfa',
  '#fb923c','#2dd4bf','#e879f9','#f87171','#94a3b8',
  '#4ade80','#38bdf8','#f9a8d4','#facc15','#c084fc'
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DRIVE TOGGLE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setDrive(d){
  drive=d;
  document.getElementById('dCrank').className='drive-chip'+(d===0?' on-b':'');
  document.getElementById('dMotor').className='drive-chip'+(d===1?' on':'');
  document.getElementById('statDrive').textContent=d===0?'Manivelle':'Moteur';
  document.getElementById('statDrive').className=d===0?'v-b':'v';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AI CALLS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* ‚ïê‚ïê‚ïê SMART LOCAL DECOMPOSER ‚ïê‚ïê‚ïê */
const TEMPLATES = {
  // ‚îÄ‚îÄ ANIMALS ‚îÄ‚îÄ
  chien:{name:"Chien",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:30,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:14},position:{x:-35,y:-8},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"museau",name:"Museau",shape:{type:"ellipse",rx:8,ry:5},position:{x:-50,y:-5},rotation:0,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"oreille_g",name:"Oreille G",shape:{type:"tri",base:10,h:14},position:{x:-38,y:-22},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oreille_d",name:"Oreille D",shape:{type:"tri",base:10,h:14},position:{x:-28,y:-22},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte avant G",shape:{type:"rect",w:6,h:22},position:{x:-18,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte avant D",shape:{type:"rect",w:6,h:22},position:{x:-8,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte arri√®re G",shape:{type:"rect",w:6,h:22},position:{x:18,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_ar_d",name:"Patte arri√®re D",shape:{type:"rect",w:6,h:22},position:{x:10,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"tri",base:8,h:24},position:{x:34,y:-6},rotation:120,parent:"corps",anchor:"right",layer:1,movable:true}
  ]},
  chat:{name:"Chat",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:24,ry:16},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:15},position:{x:-28,y:-10},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"oreille_g",name:"Oreille G",shape:{type:"tri",base:8,h:12},position:{x:-34,y:-26},rotation:-10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oreille_d",name:"Oreille D",shape:{type:"tri",base:8,h:12},position:{x:-22,y:-26},rotation:10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte avant G",shape:{type:"rect",w:5,h:18},position:{x:-14,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_av_d",name:"Patte avant D",shape:{type:"rect",w:5,h:18},position:{x:-6,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"patte_ar_g",name:"Patte arri√®re G",shape:{type:"rect",w:5,h:18},position:{x:14,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_ar_d",name:"Patte arri√®re D",shape:{type:"rect",w:5,h:18},position:{x:8,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"patte_wave",name:"Patte qui wave",shape:{type:"rect",w:5,h:18},position:{x:-18,y:8},rotation:-30,parent:"corps",anchor:"left",layer:2,movable:true},
    {id:"queue",name:"Queue",shape:{type:"ellipse",rx:4,ry:20},position:{x:28,y:-12},rotation:30,parent:"corps",anchor:"right",layer:1,movable:true}
  ]},
  oiseau:{name:"Oiseau",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:22,ry:14},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:10},position:{x:-26,y:-12},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bec",name:"Bec",shape:{type:"tri",base:8,h:14},position:{x:-40,y:-12},rotation:-90,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:2},position:{x:-28,y:-14},rotation:0,parent:"tete",anchor:"center",layer:3,movable:false},
    {id:"aile_g",name:"Aile gauche",shape:{type:"tri",base:30,h:18},position:{x:0,y:-18},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"aile_d",name:"Aile droite",shape:{type:"tri",base:30,h:18},position:{x:0,y:-18},rotation:180,parent:"corps",anchor:"top",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"tri",base:16,h:12},position:{x:24,y:-4},rotation:150,parent:"corps",anchor:"right",layer:1,movable:false},
    {id:"patte_g",name:"Patte G",shape:{type:"rect",w:3,h:14},position:{x:-6,y:14},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_d",name:"Patte D",shape:{type:"rect",w:3,h:14},position:{x:6,y:14},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false}
  ]},
  canard:{name:"Canard",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:26,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:true},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:12},position:{x:-28,y:-14},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"bec",name:"Bec",shape:{type:"rect",w:16,h:5},position:{x:-44,y:-12},rotation:0,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"aile",name:"Aile",shape:{type:"ellipse",rx:16,ry:10},position:{x:4,y:-6},rotation:-10,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"queue",name:"Queue",shape:{type:"tri",base:12,h:10},position:{x:28,y:-8},rotation:140,parent:"corps",anchor:"right",layer:1,movable:false}
  ]},
  poisson:{name:"Poisson",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:30,ry:14},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"queue",name:"Queue",shape:{type:"tri",base:22,h:16},position:{x:32,y:0},rotation:90,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"nageoire_d",name:"Nageoire dorsale",shape:{type:"tri",base:18,h:12},position:{x:-4,y:-16},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"nageoire_v",name:"Nageoire ventrale",shape:{type:"tri",base:10,h:8},position:{x:4,y:14},rotation:180,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:3},position:{x:-18,y:-3},rotation:0,parent:"corps",anchor:"left",layer:2,movable:false}
  ]},
  dinosaure:{name:"Dinosaure",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:28,ry:20},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:14,ry:10},position:{x:-34,y:-12},rotation:-15,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"machoire",name:"M√¢choire",shape:{type:"tri",base:12,h:8},position:{x:-46,y:-8},rotation:-90,parent:"tete",anchor:"left",layer:2,movable:true},
    {id:"patte_av_g",name:"Bras G",shape:{type:"rect",w:5,h:14},position:{x:-16,y:10},rotation:20,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Bras D",shape:{type:"rect",w:5,h:14},position:{x:-10,y:10},rotation:20,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte G",shape:{type:"rect",w:8,h:24},position:{x:14,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_ar_d",name:"Patte D",shape:{type:"rect",w:8,h:24},position:{x:22,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"queue",name:"Queue",shape:{type:"tri",base:10,h:35},position:{x:32,y:4},rotation:100,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"crete1",name:"Cr√™te 1",shape:{type:"tri",base:8,h:10},position:{x:-10,y:-22},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false},
    {id:"crete2",name:"Cr√™te 2",shape:{type:"tri",base:8,h:10},position:{x:0,y:-22},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false},
    {id:"crete3",name:"Cr√™te 3",shape:{type:"tri",base:8,h:10},position:{x:10,y:-22},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false}
  ]},
  robot:{name:"Robot",pieces:[
    {id:"corps",name:"Torse",shape:{type:"rect",w:30,h:36},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"square",s:22},position:{x:0,y:-30},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"antenne",name:"Antenne",shape:{type:"rect",w:3,h:12},position:{x:0,y:-44},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:4},position:{x:-6,y:-32},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:4},position:{x:6,y:-32},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:6,h:28},position:{x:-22,y:2},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D",shape:{type:"rect",w:6,h:28},position:{x:22,y:2},rotation:0,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"patte_g",name:"Jambe G",shape:{type:"rect",w:8,h:26},position:{x:-10,y:32},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_d",name:"Jambe D",shape:{type:"rect",w:8,h:26},position:{x:10,y:32},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  cheval:{name:"Cheval",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:34,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:12,ry:8},position:{x:-42,y:-16},rotation:-30,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"cou",name:"Cou",shape:{type:"rect",w:8,h:20},position:{x:-34,y:-8},rotation:-20,parent:"corps",anchor:"left",layer:0,movable:false},
    {id:"oreille_g",name:"Oreille G",shape:{type:"tri",base:5,h:10},position:{x:-44,y:-28},rotation:-10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oreille_d",name:"Oreille D",shape:{type:"tri",base:5,h:10},position:{x:-38,y:-28},rotation:10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"rect",w:5,h:28},position:{x:-20,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"rect",w:5,h:28},position:{x:-12,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"rect",w:5,h:28},position:{x:18,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"rect",w:5,h:28},position:{x:26,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"ellipse",rx:4,ry:18},position:{x:36,y:-8},rotation:20,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"criniere",name:"Crini√®re",shape:{type:"ellipse",rx:4,ry:14},position:{x:-32,y:-14},rotation:-20,parent:"cou",anchor:"top",layer:2,movable:false}
  ]},
  bonhomme:{name:"Bonhomme",pieces:[
    {id:"corps",name:"Torse",shape:{type:"rect",w:24,h:32},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:14},position:{x:0,y:-28},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:5,h:26},position:{x:-18,y:0},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D",shape:{type:"rect",w:5,h:26},position:{x:18,y:0},rotation:0,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"jambe_g",name:"Jambe G",shape:{type:"rect",w:7,h:28},position:{x:-8,y:30},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"jambe_d",name:"Jambe D",shape:{type:"rect",w:7,h:28},position:{x:8,y:30},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  papillon:{name:"Papillon",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:4,ry:16},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:6},position:{x:0,y:-20},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"antenne_g",name:"Antenne G",shape:{type:"rect",w:2,h:12},position:{x:-6,y:-30},rotation:-20,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"antenne_d",name:"Antenne D",shape:{type:"rect",w:2,h:12},position:{x:6,y:-30},rotation:20,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"aile_hg",name:"Aile haute G",shape:{type:"ellipse",rx:22,ry:16},position:{x:-22,y:-8},rotation:-10,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"aile_hd",name:"Aile haute D",shape:{type:"ellipse",rx:22,ry:16},position:{x:22,y:-8},rotation:10,parent:"corps",anchor:"right",layer:-1,movable:true},
    {id:"aile_bg",name:"Aile basse G",shape:{type:"ellipse",rx:16,ry:12},position:{x:-18,y:8},rotation:-20,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"aile_bd",name:"Aile basse D",shape:{type:"ellipse",rx:16,ry:12},position:{x:18,y:8},rotation:20,parent:"corps",anchor:"right",layer:-1,movable:true}
  ]},
  // ‚îÄ‚îÄ NEW ANIMALS ‚îÄ‚îÄ
  grenouille:{name:"Grenouille",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:24,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:20,ry:14},position:{x:0,y:-22},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:6},position:{x:-12,y:-32},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:6},position:{x:12,y:-32},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"bouche",name:"Bouche",shape:{type:"ellipse",rx:12,ry:3},position:{x:0,y:-14},rotation:0,parent:"tete",anchor:"bottom",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"rect",w:8,h:16},position:{x:-24,y:10},rotation:-30,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"rect",w:8,h:16},position:{x:24,y:10},rotation:30,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"rect",w:10,h:24},position:{x:-20,y:18},rotation:-15,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"rect",w:10,h:24},position:{x:20,y:18},rotation:15,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  tortue:{name:"Tortue",pieces:[
    {id:"carapace",name:"Carapace",shape:{type:"ellipse",rx:30,ry:22},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"motif",name:"Motif",shape:{type:"diamond",w:20,h:16},position:{x:0,y:0},rotation:0,parent:"carapace",anchor:"center",layer:1,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:10,ry:8},position:{x:-34,y:0},rotation:0,parent:"carapace",anchor:"left",layer:1,movable:true},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:2},position:{x:-38,y:-3},rotation:0,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"ellipse",rx:6,ry:10},position:{x:-18,y:18},rotation:-20,parent:"carapace",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"ellipse",rx:6,ry:10},position:{x:-18,y:-18},rotation:20,parent:"carapace",anchor:"top",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"ellipse",rx:6,ry:10},position:{x:18,y:18},rotation:20,parent:"carapace",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"ellipse",rx:6,ry:10},position:{x:18,y:-18},rotation:-20,parent:"carapace",anchor:"top",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"tri",base:6,h:14},position:{x:32,y:0},rotation:90,parent:"carapace",anchor:"right",layer:1,movable:false}
  ]},
  pingouin:{name:"Pingouin",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:18,ry:26},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"ventre",name:"Ventre",shape:{type:"ellipse",rx:12,ry:18},position:{x:0,y:3},rotation:0,parent:"corps",anchor:"center",layer:1,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:14},position:{x:0,y:-30},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"bec",name:"Bec",shape:{type:"tri",base:8,h:10},position:{x:0,y:-26},rotation:180,parent:"tete",anchor:"bottom",layer:2,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:3},position:{x:-6,y:-33},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:3},position:{x:6,y:-33},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"aile_g",name:"Aile G",shape:{type:"ellipse",rx:8,ry:18},position:{x:-22,y:0},rotation:-10,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"aile_d",name:"Aile D",shape:{type:"ellipse",rx:8,ry:18},position:{x:22,y:0},rotation:10,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"pied_g",name:"Pied G",shape:{type:"ellipse",rx:8,ry:5},position:{x:-10,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"pied_d",name:"Pied D",shape:{type:"ellipse",rx:8,ry:5},position:{x:10,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false}
  ]},
  lapin:{name:"Lapin",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:20,ry:24},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:16},position:{x:0,y:-30},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"oreille_g",name:"Oreille G",shape:{type:"ellipse",rx:5,ry:20},position:{x:-8,y:-54},rotation:-10,parent:"tete",anchor:"top",layer:2,movable:true},
    {id:"oreille_d",name:"Oreille D",shape:{type:"ellipse",rx:5,ry:20},position:{x:8,y:-54},rotation:10,parent:"tete",anchor:"top",layer:2,movable:true},
    {id:"museau",name:"Museau",shape:{type:"ellipse",rx:6,ry:4},position:{x:0,y:-24},rotation:0,parent:"tete",anchor:"bottom",layer:2,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:3},position:{x:-8,y:-34},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:3},position:{x:8,y:-34},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV",shape:{type:"rect",w:6,h:14},position:{x:-10,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_av_d",name:"Patte AV",shape:{type:"rect",w:6,h:14},position:{x:10,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"ellipse",rx:10,ry:8},position:{x:-16,y:22},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"ellipse",rx:10,ry:8},position:{x:16,y:22},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"circle",r:6},position:{x:0,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:2,movable:false}
  ]},
  serpent:{name:"Serpent",pieces:[
    {id:"corps1",name:"Corps 1",shape:{type:"ellipse",rx:16,ry:10},position:{x:-30,y:10},rotation:-20,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"corps2",name:"Corps 2",shape:{type:"ellipse",rx:16,ry:10},position:{x:-8,y:0},rotation:10,parent:"corps1",anchor:"right",layer:0,movable:true},
    {id:"corps3",name:"Corps 3",shape:{type:"ellipse",rx:16,ry:10},position:{x:16,y:8},rotation:-15,parent:"corps2",anchor:"right",layer:0,movable:true},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:10,ry:8},position:{x:-46,y:8},rotation:-10,parent:"corps1",anchor:"left",layer:1,movable:true},
    {id:"langue",name:"Langue",shape:{type:"tri",base:4,h:10},position:{x:-58,y:8},rotation:-90,parent:"tete",anchor:"left",layer:2,movable:true},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:2},position:{x:-48,y:4},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"queue",name:"Queue",shape:{type:"tri",base:8,h:16},position:{x:34,y:12},rotation:80,parent:"corps3",anchor:"right",layer:1,movable:true}
  ]},
  crabe:{name:"Crabe",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:28,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:4},position:{x:-10,y:-20},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:4},position:{x:10,y:-20},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false},
    {id:"tige_g",name:"Tige ≈íil G",shape:{type:"rect",w:2,h:8},position:{x:-10,y:-14},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"tige_d",name:"Tige ≈íil D",shape:{type:"rect",w:2,h:8},position:{x:10,y:-14},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"pince_g",name:"Pince G",shape:{type:"ellipse",rx:12,ry:8},position:{x:-40,y:-8},rotation:-20,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"pince_d",name:"Pince D",shape:{type:"ellipse",rx:12,ry:8},position:{x:40,y:-8},rotation:20,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"patte1_g",name:"Patte 1G",shape:{type:"rect",w:3,h:14},position:{x:-26,y:14},rotation:-30,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte2_g",name:"Patte 2G",shape:{type:"rect",w:3,h:14},position:{x:-18,y:16},rotation:-15,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte1_d",name:"Patte 1D",shape:{type:"rect",w:3,h:14},position:{x:26,y:14},rotation:30,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte2_d",name:"Patte 2D",shape:{type:"rect",w:3,h:14},position:{x:18,y:16},rotation:15,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  hibou:{name:"Hibou",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:20,ry:24},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:18},position:{x:0,y:-28},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:8},position:{x:-10,y:-30},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:8},position:{x:10,y:-30},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"pupille_g",name:"Pupille G",shape:{type:"circle",r:3},position:{x:-10,y:-30},rotation:0,parent:"oeil_g",anchor:"center",layer:3,movable:false},
    {id:"pupille_d",name:"Pupille D",shape:{type:"circle",r:3},position:{x:10,y:-30},rotation:0,parent:"oeil_d",anchor:"center",layer:3,movable:false},
    {id:"bec",name:"Bec",shape:{type:"tri",base:8,h:8},position:{x:0,y:-22},rotation:180,parent:"tete",anchor:"bottom",layer:2,movable:false},
    {id:"aigrette_g",name:"Aigrette G",shape:{type:"tri",base:8,h:12},position:{x:-14,y:-46},rotation:-10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"aigrette_d",name:"Aigrette D",shape:{type:"tri",base:8,h:12},position:{x:14,y:-46},rotation:10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"aile_g",name:"Aile G",shape:{type:"ellipse",rx:14,ry:20},position:{x:-26,y:0},rotation:-5,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"aile_d",name:"Aile D",shape:{type:"ellipse",rx:14,ry:20},position:{x:26,y:0},rotation:5,parent:"corps",anchor:"right",layer:-1,movable:true},
    {id:"patte_g",name:"Patte G",shape:{type:"rect",w:6,h:10},position:{x:-8,y:24},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"patte_d",name:"Patte D",shape:{type:"rect",w:6,h:10},position:{x:8,y:24},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false}
  ]},
  cochon:{name:"Cochon",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:30,ry:20},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:16},position:{x:-34,y:-6},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"groin",name:"Groin",shape:{type:"ellipse",rx:8,ry:6},position:{x:-48,y:-4},rotation:0,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"oreille_g",name:"Oreille G",shape:{type:"tri",base:10,h:12},position:{x:-38,y:-22},rotation:-20,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oreille_d",name:"Oreille D",shape:{type:"tri",base:10,h:12},position:{x:-28,y:-22},rotation:20,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:3},position:{x:-36,y:-10},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"rect",w:7,h:16},position:{x:-18,y:18},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"rect",w:7,h:16},position:{x:-8,y:18},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"rect",w:7,h:16},position:{x:16,y:18},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"rect",w:7,h:16},position:{x:24,y:18},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"circle",r:5},position:{x:32,y:-8},rotation:0,parent:"corps",anchor:"right",layer:1,movable:true}
  ]},
  elephant:{name:"√âl√©phant",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:36,ry:24},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:20},position:{x:-40,y:-8},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"trompe",name:"Trompe",shape:{type:"ellipse",rx:5,ry:22},position:{x:-56,y:8},rotation:10,parent:"tete",anchor:"bottom",layer:2,movable:true},
    {id:"oreille_g",name:"Oreille",shape:{type:"ellipse",rx:16,ry:20},position:{x:-36,y:-4},rotation:0,parent:"tete",anchor:"left",layer:-1,movable:true},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:3},position:{x:-42,y:-12},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"defense",name:"D√©fense",shape:{type:"rect",w:3,h:14},position:{x:-48,y:6},rotation:10,parent:"tete",anchor:"bottom",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"rect",w:10,h:24},position:{x:-20,y:22},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"rect",w:10,h:24},position:{x:-8,y:22},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"rect",w:10,h:24},position:{x:16,y:22},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"rect",w:10,h:24},position:{x:26,y:22},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"rect",w:3,h:18},position:{x:36,y:-4},rotation:15,parent:"corps",anchor:"right",layer:1,movable:true}
  ]},
  girafe:{name:"Girafe",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:26,ry:16},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"cou",name:"Cou",shape:{type:"rect",w:10,h:40},position:{x:-20,y:-28},rotation:-10,parent:"corps",anchor:"top",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:10,ry:7},position:{x:-24,y:-52},rotation:-10,parent:"cou",anchor:"top",layer:1,movable:true},
    {id:"corne_g",name:"Corne G",shape:{type:"rect",w:2,h:8},position:{x:-28,y:-60},rotation:-5,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"corne_d",name:"Corne D",shape:{type:"rect",w:2,h:8},position:{x:-20,y:-60},rotation:5,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"tache1",name:"Tache 1",shape:{type:"diamond",w:8,h:8},position:{x:-6,y:-4},rotation:0,parent:"corps",anchor:"center",layer:1,movable:false},
    {id:"tache2",name:"Tache 2",shape:{type:"diamond",w:6,h:6},position:{x:10,y:2},rotation:15,parent:"corps",anchor:"center",layer:1,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"rect",w:5,h:30},position:{x:-16,y:24},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"rect",w:5,h:30},position:{x:-8,y:24},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"rect",w:5,h:30},position:{x:14,y:24},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"rect",w:5,h:30},position:{x:22,y:24},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"rect",w:3,h:16},position:{x:28,y:-6},rotation:20,parent:"corps",anchor:"right",layer:1,movable:true}
  ]},
  // ‚îÄ‚îÄ PERSONNAGES ‚îÄ‚îÄ
  danseuse:{name:"Danseuse",pieces:[
    {id:"corps",name:"Torse",shape:{type:"rect",w:18,h:28},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:12},position:{x:0,y:-24},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"chignon",name:"Chignon",shape:{type:"circle",r:6},position:{x:0,y:-38},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:4,h:26},position:{x:-16,y:-6},rotation:-45,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D",shape:{type:"rect",w:4,h:26},position:{x:16,y:-6},rotation:45,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"jupe",name:"Jupe",shape:{type:"tri",base:40,h:22},position:{x:0,y:20},rotation:180,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"jambe_g",name:"Jambe G",shape:{type:"rect",w:5,h:28},position:{x:-8,y:36},rotation:-10,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"jambe_d",name:"Jambe D",shape:{type:"rect",w:5,h:28},position:{x:8,y:36},rotation:10,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  ninja:{name:"Ninja",pieces:[
    {id:"corps",name:"Torse",shape:{type:"rect",w:22,h:30},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:12},position:{x:0,y:-26},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"bandeau",name:"Bandeau",shape:{type:"rect",w:28,h:4},position:{x:0,y:-28},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"rect",w:6,h:2},position:{x:-5,y:-28},rotation:0,parent:"tete",anchor:"center",layer:3,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"rect",w:6,h:2},position:{x:5,y:-28},rotation:0,parent:"tete",anchor:"center",layer:3,movable:false},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:5,h:24},position:{x:-18,y:-2},rotation:-20,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D + Katana",shape:{type:"rect",w:4,h:36},position:{x:18,y:-10},rotation:30,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"jambe_g",name:"Jambe G",shape:{type:"rect",w:6,h:26},position:{x:-8,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"jambe_d",name:"Jambe D",shape:{type:"rect",w:6,h:26},position:{x:8,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  astronaute:{name:"Astronaute",pieces:[
    {id:"corps",name:"Combinaison",shape:{type:"rect",w:28,h:34},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"casque",name:"Casque",shape:{type:"circle",r:16},position:{x:0,y:-28},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"visiere",name:"Visi√®re",shape:{type:"ellipse",rx:10,ry:8},position:{x:0,y:-28},rotation:0,parent:"casque",anchor:"center",layer:2,movable:false},
    {id:"backpack",name:"Sac √† dos",shape:{type:"rect",w:16,h:24},position:{x:18,y:0},rotation:0,parent:"corps",anchor:"right",layer:-1,movable:false},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:8,h:26},position:{x:-22,y:0},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D",shape:{type:"rect",w:8,h:26},position:{x:30,y:0},rotation:0,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"jambe_g",name:"Jambe G",shape:{type:"rect",w:10,h:26},position:{x:-10,y:30},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"jambe_d",name:"Jambe D",shape:{type:"rect",w:10,h:26},position:{x:10,y:30},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"botte_g",name:"Botte G",shape:{type:"rect",w:12,h:8},position:{x:-10,y:48},rotation:0,parent:"jambe_g",anchor:"bottom",layer:1,movable:false},
    {id:"botte_d",name:"Botte D",shape:{type:"rect",w:12,h:8},position:{x:10,y:48},rotation:0,parent:"jambe_d",anchor:"bottom",layer:-1,movable:false}
  ]},
  pirate:{name:"Pirate",pieces:[
    {id:"corps",name:"Torse",shape:{type:"rect",w:24,h:30},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:13},position:{x:0,y:-26},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"chapeau",name:"Chapeau",shape:{type:"tri",base:32,h:18},position:{x:0,y:-42},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"cache_oeil",name:"Cache-≈ìil",shape:{type:"circle",r:4},position:{x:-6,y:-28},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"barbe",name:"Barbe",shape:{type:"tri",base:16,h:12},position:{x:0,y:-16},rotation:180,parent:"tete",anchor:"bottom",layer:2,movable:false},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:5,h:24},position:{x:-18,y:0},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D + √âp√©e",shape:{type:"rect",w:4,h:34},position:{x:18,y:-6},rotation:20,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"jambe_g",name:"Jambe G",shape:{type:"rect",w:7,h:26},position:{x:-8,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"pilon",name:"Jambe de bois",shape:{type:"rect",w:4,h:26},position:{x:8,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false}
  ]},
  // ‚îÄ‚îÄ OBJETS ‚îÄ‚îÄ
  moulin:{name:"Moulin √† vent",pieces:[
    {id:"corps",name:"Tour",shape:{type:"rect",w:20,h:50},position:{x:0,y:10},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"toit",name:"Toit",shape:{type:"tri",base:28,h:18},position:{x:0,y:-20},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"pale1",name:"Pale 1",shape:{type:"rect",w:8,h:36},position:{x:0,y:-12},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"pale2",name:"Pale 2",shape:{type:"rect",w:8,h:36},position:{x:0,y:-12},rotation:90,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"axe",name:"Axe",shape:{type:"circle",r:4},position:{x:0,y:-12},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false},
    {id:"porte",name:"Porte",shape:{type:"rect",w:10,h:16},position:{x:0,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"base",name:"Base",shape:{type:"rect",w:36,h:6},position:{x:0,y:36},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false}
  ]},
  fusee:{name:"Fus√©e",pieces:[
    {id:"corps",name:"Fuselage",shape:{type:"rect",w:18,h:50},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"nez",name:"Nez",shape:{type:"tri",base:18,h:20},position:{x:0,y:-35},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"hublot1",name:"Hublot 1",shape:{type:"circle",r:4},position:{x:0,y:-12},rotation:0,parent:"corps",anchor:"center",layer:1,movable:false},
    {id:"hublot2",name:"Hublot 2",shape:{type:"circle",r:3},position:{x:0,y:2},rotation:0,parent:"corps",anchor:"center",layer:1,movable:false},
    {id:"aileron_g",name:"Aileron G",shape:{type:"tri",base:14,h:18},position:{x:-16,y:20},rotation:30,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"aileron_d",name:"Aileron D",shape:{type:"tri",base:14,h:18},position:{x:16,y:20},rotation:-30,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"flamme1",name:"Flamme 1",shape:{type:"tri",base:12,h:20},position:{x:0,y:35},rotation:180,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"flamme2",name:"Flamme 2",shape:{type:"tri",base:8,h:14},position:{x:0,y:38},rotation:180,parent:"flamme1",anchor:"bottom",layer:-2,movable:true}
  ]},
  fleur:{name:"Fleur",pieces:[
    {id:"tige",name:"Tige",shape:{type:"rect",w:4,h:40},position:{x:0,y:20},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"feuille_g",name:"Feuille G",shape:{type:"ellipse",rx:12,ry:6},position:{x:-12,y:28},rotation:-30,parent:"tige",anchor:"left",layer:1,movable:true},
    {id:"feuille_d",name:"Feuille D",shape:{type:"ellipse",rx:12,ry:6},position:{x:12,y:18},rotation:30,parent:"tige",anchor:"right",layer:1,movable:true},
    {id:"petale1",name:"P√©tale haut",shape:{type:"ellipse",rx:10,ry:14},position:{x:0,y:-16},rotation:0,parent:"tige",anchor:"top",layer:1,movable:true},
    {id:"petale2",name:"P√©tale G",shape:{type:"ellipse",rx:10,ry:14},position:{x:-14,y:-4},rotation:-72,parent:"tige",anchor:"top",layer:1,movable:true},
    {id:"petale3",name:"P√©tale D",shape:{type:"ellipse",rx:10,ry:14},position:{x:14,y:-4},rotation:72,parent:"tige",anchor:"top",layer:1,movable:true},
    {id:"petale4",name:"P√©tale BG",shape:{type:"ellipse",rx:10,ry:14},position:{x:-8,y:6},rotation:-144,parent:"tige",anchor:"top",layer:1,movable:true},
    {id:"petale5",name:"P√©tale BD",shape:{type:"ellipse",rx:10,ry:14},position:{x:8,y:6},rotation:144,parent:"tige",anchor:"top",layer:1,movable:true},
    {id:"coeur",name:"C≈ìur",shape:{type:"circle",r:7},position:{x:0,y:-2},rotation:0,parent:"tige",anchor:"top",layer:2,movable:false}
  ]},
  avion:{name:"Avion",pieces:[
    {id:"fuselage",name:"Fuselage",shape:{type:"ellipse",rx:36,ry:8},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"cockpit",name:"Cockpit",shape:{type:"ellipse",rx:6,ry:5},position:{x:-30,y:-2},rotation:0,parent:"fuselage",anchor:"left",layer:1,movable:false},
    {id:"aile_g",name:"Aile G",shape:{type:"rect",w:50,h:10},position:{x:0,y:-14},rotation:0,parent:"fuselage",anchor:"top",layer:1,movable:true},
    {id:"aile_d",name:"Aile D",shape:{type:"rect",w:50,h:10},position:{x:0,y:14},rotation:0,parent:"fuselage",anchor:"bottom",layer:-1,movable:true},
    {id:"derive",name:"D√©rive",shape:{type:"tri",base:14,h:18},position:{x:30,y:-14},rotation:0,parent:"fuselage",anchor:"right",layer:1,movable:false},
    {id:"stab",name:"Stabilisateur",shape:{type:"rect",w:18,h:5},position:{x:30,y:0},rotation:0,parent:"fuselage",anchor:"right",layer:1,movable:false},
    {id:"helice",name:"H√©lice",shape:{type:"rect",w:3,h:24},position:{x:-38,y:0},rotation:0,parent:"fuselage",anchor:"left",layer:2,movable:true}
  ]},
  voiture:{name:"Voiture",pieces:[
    {id:"chassis",name:"Ch√¢ssis",shape:{type:"rect",w:60,h:16},position:{x:0,y:4},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"habitacle",name:"Habitacle",shape:{type:"rect",w:30,h:16},position:{x:-4,y:-12},rotation:0,parent:"chassis",anchor:"top",layer:1,movable:false},
    {id:"toit",name:"Toit",shape:{type:"rect",w:22,h:4},position:{x:-4,y:-22},rotation:0,parent:"habitacle",anchor:"top",layer:2,movable:false},
    {id:"pare_brise",name:"Pare-brise",shape:{type:"tri",base:8,h:12},position:{x:-18,y:-14},rotation:100,parent:"habitacle",anchor:"left",layer:2,movable:false},
    {id:"roue_av",name:"Roue AV",shape:{type:"circle",r:8},position:{x:-20,y:14},rotation:0,parent:"chassis",anchor:"bottom",layer:-1,movable:true},
    {id:"roue_ar",name:"Roue AR",shape:{type:"circle",r:8},position:{x:20,y:14},rotation:0,parent:"chassis",anchor:"bottom",layer:-1,movable:true},
    {id:"phare",name:"Phare",shape:{type:"circle",r:3},position:{x:-32,y:4},rotation:0,parent:"chassis",anchor:"left",layer:1,movable:false},
    {id:"feu",name:"Feu AR",shape:{type:"rect",w:3,h:5},position:{x:32,y:2},rotation:0,parent:"chassis",anchor:"right",layer:1,movable:false}
  ]},
  bateau:{name:"Bateau",pieces:[
    {id:"coque",name:"Coque",shape:{type:"tri",base:70,h:20},position:{x:0,y:10},rotation:180,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"pont",name:"Pont",shape:{type:"rect",w:60,h:6},position:{x:0,y:0},rotation:0,parent:"coque",anchor:"top",layer:1,movable:false},
    {id:"cabine",name:"Cabine",shape:{type:"rect",w:20,h:14},position:{x:8,y:-10},rotation:0,parent:"pont",anchor:"top",layer:1,movable:false},
    {id:"cheminee",name:"Chemin√©e",shape:{type:"rect",w:6,h:12},position:{x:12,y:-22},rotation:0,parent:"cabine",anchor:"top",layer:2,movable:false},
    {id:"mat",name:"M√¢t",shape:{type:"rect",w:3,h:36},position:{x:-12,y:-20},rotation:0,parent:"pont",anchor:"top",layer:1,movable:false},
    {id:"voile",name:"Voile",shape:{type:"tri",base:22,h:30},position:{x:-4,y:-28},rotation:90,parent:"mat",anchor:"right",layer:1,movable:true},
    {id:"drapeau",name:"Drapeau",shape:{type:"rect",w:10,h:6},position:{x:-12,y:-40},rotation:0,parent:"mat",anchor:"top",layer:2,movable:true}
  ]},
  etoile:{name:"√âtoile",pieces:[
    {id:"centre",name:"Centre",shape:{type:"circle",r:12},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"branche1",name:"Branche 1",shape:{type:"tri",base:14,h:22},position:{x:0,y:-22},rotation:0,parent:"centre",anchor:"top",layer:1,movable:true},
    {id:"branche2",name:"Branche 2",shape:{type:"tri",base:14,h:22},position:{x:21,y:-7},rotation:72,parent:"centre",anchor:"right",layer:1,movable:true},
    {id:"branche3",name:"Branche 3",shape:{type:"tri",base:14,h:22},position:{x:13,y:18},rotation:144,parent:"centre",anchor:"right",layer:1,movable:true},
    {id:"branche4",name:"Branche 4",shape:{type:"tri",base:14,h:22},position:{x:-13,y:18},rotation:-144,parent:"centre",anchor:"left",layer:1,movable:true},
    {id:"branche5",name:"Branche 5",shape:{type:"tri",base:14,h:22},position:{x:-21,y:-7},rotation:-72,parent:"centre",anchor:"left",layer:1,movable:true}
  ]},
  arbre:{name:"Arbre",pieces:[
    {id:"tronc",name:"Tronc",shape:{type:"rect",w:12,h:34},position:{x:0,y:16},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"racine_g",name:"Racine G",shape:{type:"tri",base:10,h:8},position:{x:-8,y:34},rotation:20,parent:"tronc",anchor:"bottom",layer:-1,movable:false},
    {id:"racine_d",name:"Racine D",shape:{type:"tri",base:10,h:8},position:{x:8,y:34},rotation:-20,parent:"tronc",anchor:"bottom",layer:-1,movable:false},
    {id:"feuillage1",name:"Feuillage bas",shape:{type:"ellipse",rx:28,ry:18},position:{x:0,y:-8},rotation:0,parent:"tronc",anchor:"top",layer:1,movable:true},
    {id:"feuillage2",name:"Feuillage milieu",shape:{type:"ellipse",rx:22,ry:16},position:{x:0,y:-22},rotation:0,parent:"feuillage1",anchor:"top",layer:2,movable:true},
    {id:"feuillage3",name:"Feuillage haut",shape:{type:"ellipse",rx:16,ry:14},position:{x:0,y:-36},rotation:0,parent:"feuillage2",anchor:"top",layer:3,movable:true}
  ]}
};

// Movement templates
const MOTION_TEMPLATES = {
  marche:{desc:"Marche altern√©e",cams:2,fn:(pieces)=>{
    const motions=[];const pattes=pieces.filter(p=>p.movable&&(p.id.includes('patte')||p.id.includes('jambe')));
    const av=pattes.filter(p=>p.id.includes('av')||p.id.includes('_g')&&!p.id.includes('ar'));
    pattes.forEach((p,i)=>{motions.push({piece_id:p.id,motion:"OSCILLATE",pivot:"top",amplitude:25,speed:"medium",phase:i%2===0?0:180,cam_profile:"smooth",cam_index:i%2});});
    return{motions,cam_count:2};
  }},
  queue:{desc:"Queue remuante",cams:1,fn:(pieces)=>{
    const q=pieces.find(p=>p.id==='queue');
    if(!q)return{motions:[],cam_count:0};
    return{motions:[{piece_id:"queue",motion:"OSCILLATE",pivot:"left",amplitude:40,speed:"medium",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  ailes:{desc:"Battement d'ailes",cams:1,fn:(pieces)=>{
    const ailes=pieces.filter(p=>p.id.includes('aile'));
    return{motions:ailes.map((a,i)=>({piece_id:a.id,motion:"OSCILLATE",pivot:"bottom",amplitude:35,speed:"medium",phase:i%2===0?0:180,cam_profile:"smooth",cam_index:0})),cam_count:1};
  }},
  tete:{desc:"Hochement de t√™te",cams:1,fn:(pieces)=>{
    const t=pieces.find(p=>p.id==='tete');
    if(!t)return{motions:[],cam_count:0};
    return{motions:[{piece_id:"tete",motion:"OSCILLATE",pivot:"bottom",amplitude:20,speed:"fast",phase:0,cam_profile:"sharp",cam_index:0}],cam_count:1};
  }},
  wave:{desc:"Bras/patte qui wave",cams:1,fn:(pieces)=>{
    const arm=pieces.find(p=>p.id.includes('bras_d')||p.id.includes('patte_wave'));
    if(!arm)return{motions:[],cam_count:0};
    return{motions:[{piece_id:arm.id,motion:"OSCILLATE",pivot:"top",amplitude:45,speed:"medium",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  nage:{desc:"Nage ‚Äî queue ondule",cams:1,fn:(pieces)=>{
    const q=pieces.find(p=>p.id==='queue');
    if(!q)return{motions:[],cam_count:0};
    return{motions:[{piece_id:"queue",motion:"OSCILLATE",pivot:"left",amplitude:30,speed:"fast",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  bob:{desc:"Corps qui plonge",cams:1,fn:(pieces)=>{
    const c=pieces.find(p=>p.id==='corps'||p.id==='centre');
    if(!c)return{motions:[],cam_count:0};
    return{motions:[{piece_id:c.id,motion:"TRANSLATE_V",pivot:"center",amplitude:15,speed:"medium",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  pince:{desc:"Pinces qui claquent",cams:1,fn:(pieces)=>{
    const pinces=pieces.filter(p=>p.id.includes('pince'));
    return{motions:pinces.map((p,i)=>({piece_id:p.id,motion:"OSCILLATE",pivot:i===0?"right":"left",amplitude:25,speed:"fast",phase:i===0?0:180,cam_profile:"sharp",cam_index:0})),cam_count:1};
  }},
  helice:{desc:"H√©lice qui tourne",cams:1,fn:(pieces)=>{
    const h=pieces.find(p=>p.id.includes('helice')||p.id.includes('pale'));
    if(!h)return{motions:[],cam_count:0};
    const pales=pieces.filter(p=>p.id.includes('pale')||p.id.includes('helice'));
    return{motions:pales.map(p=>({piece_id:p.id,motion:"ROTATE",pivot:"center",amplitude:360,speed:"fast",phase:0,cam_profile:"smooth",cam_index:0})),cam_count:1};
  }},
  ondule:{desc:"Ondulation serpent",cams:2,fn:(pieces)=>{
    const corps=pieces.filter(p=>p.id.includes('corps'));
    return{motions:corps.map((p,i)=>({piece_id:p.id,motion:"OSCILLATE",pivot:"center",amplitude:20,speed:"medium",phase:i*90,cam_profile:"smooth",cam_index:i%2})),cam_count:2};
  }},
  trompe:{desc:"Trompe qui bouge",cams:1,fn:(pieces)=>{
    const t=pieces.find(p=>p.id.includes('trompe'));
    if(!t)return{motions:[],cam_count:0};
    return{motions:[{piece_id:t.id,motion:"OSCILLATE",pivot:"top",amplitude:30,speed:"slow",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  roule:{desc:"Roues qui tournent",cams:1,fn:(pieces)=>{
    const roues=pieces.filter(p=>p.id.includes('roue'));
    return{motions:roues.map(p=>({piece_id:p.id,motion:"ROTATE",pivot:"center",amplitude:360,speed:"medium",phase:0,cam_profile:"smooth",cam_index:0})),cam_count:1};
  }},
  flamme:{desc:"Flamme qui vibre",cams:1,fn:(pieces)=>{
    const fl=pieces.filter(p=>p.id.includes('flamme'));
    return{motions:fl.map((p,i)=>({piece_id:p.id,motion:"OSCILLATE",pivot:"top",amplitude:15,speed:"fast",phase:i*90,cam_profile:"sharp",cam_index:0})),cam_count:1};
  }},
  balance:{desc:"Balancement doux",cams:1,fn:(pieces)=>{
    const movs=pieces.filter(p=>p.movable);
    return{motions:movs.slice(0,3).map((p,i)=>({piece_id:p.id,motion:"OSCILLATE",pivot:"top",amplitude:20,speed:"slow",phase:i*120,cam_profile:"smooth",cam_index:0})),cam_count:1};
  }}
};

function matchTemplate(input){
  const t=input.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  // Match animal/object
  const formKeys={
    chien:['chien','dog','toutou','chiot','puppy'],
    chat:['chat','cat','chaton','minou','kitty'],
    oiseau:['oiseau','bird','piaf','moineau'],
    canard:['canard','duck'],
    poisson:['poisson','fish','requin'],
    dinosaure:['dinosaure','dino','trex','t-rex','rex'],
    robot:['robot','mecha','androide','android'],
    cheval:['cheval','horse','poney','pony'],
    bonhomme:['bonhomme','personnage','humain','homme','femme','personne','figure','man','person'],
    papillon:['papillon','butterfly'],
    grenouille:['grenouille','frog','crapaud'],
    tortue:['tortue','turtle','tortoise'],
    pingouin:['pingouin','penguin','manchot'],
    lapin:['lapin','rabbit','bunny','lievre'],
    serpent:['serpent','snake','cobra','vipere'],
    crabe:['crabe','crab','homard'],
    hibou:['hibou','owl','chouette'],
    cochon:['cochon','pig','porc','porcelet'],
    elephant:['elephant','elephan'],
    girafe:['girafe','giraffe'],
    danseuse:['danseuse','danseur','dancer','ballerine','ballet'],
    ninja:['ninja','samourai','samurai','guerrier'],
    astronaute:['astronaute','astronaut','cosmonaute','spaceman'],
    pirate:['pirate','corsaire','boucanier'],
    moulin:['moulin','windmill','eolienne'],
    fusee:['fusee','rocket','navette','shuttle'],
    fleur:['fleur','flower','rose','tulipe','marguerite'],
    avion:['avion','airplane','plane','jet','aerien'],
    voiture:['voiture','car','auto','automobile','bagnole'],
    bateau:['bateau','boat','ship','navire','barque','voilier'],
    etoile:['etoile','star','astre'],
    arbre:['arbre','tree','sapin','chene']
  };
  let formKey=null;
  for(const[k,words]of Object.entries(formKeys)){if(words.some(w=>t.includes(w))){formKey=k;break;}}
  return formKey;
}

function matchMotions(input, pieces){
  const t=input.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  const allMotions=[];let totalCams=0;
  const motionKeys={marche:['marche','walk','avance','court','run'],queue:['queue','tail','remue'],ailes:['aile','bat','fly','vole','envol'],tete:['tete','head','hoche','nod','picore','peck'],wave:['wave','salue','bras','main','hand'],nage:['nage','swim'],bob:['plonge','bob','monte','descend','bounce','saute','jump'],pince:['pince','claque','claw','snap'],helice:['helice','tourne','spin','pale','propeller'],ondule:['serpente','ondule','wiggle','slither'],trompe:['trompe','trunk','barrit'],roule:['roule','roll','wheel','roue'],flamme:['flamme','flame','feu','fire','brule'],balance:['balance','swing','bercer','doux','gentle','vent','souffle']};

  for(const[k,words]of Object.entries(motionKeys)){
    if(words.some(w=>t.includes(w))){
      const tmpl=MOTION_TEMPLATES[k];
      if(tmpl){
        const result=tmpl.fn(pieces);
        result.motions.forEach(m=>{
          m.cam_index=m.cam_index+totalCams;
          if(!allMotions.find(em=>em.piece_id===m.piece_id)) allMotions.push(m);
        });
        totalCams+=result.cam_count;
      }
    }
  }

  // Handle "bouge" as generic ‚Äî if "bouge" + specific piece name, only move that piece
  if(allMotions.length===0 && t.includes('bouge')){
    const pieceMatch=pieces.find(p=>{
      const pn=p.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      const pid=p.id.toLowerCase();
      return t.includes(pn)||t.includes(pid);
    });
    if(pieceMatch){
      allMotions.push({
        piece_id:pieceMatch.id,
        motion:"OSCILLATE",
        pivot:pieceMatch.id.includes('patte')||pieceMatch.id.includes('jambe')?"top":pieceMatch.id.includes('queue')?"left":"bottom",
        amplitude:pieceMatch.id.includes('patte')?25:pieceMatch.id.includes('queue')?40:20,
        speed:"medium",phase:0,cam_profile:"smooth",cam_index:0
      });
      totalCams=1;
    }
  }

  // If no motion matched, try smart default based on movable pieces
  if(allMotions.length===0){
    const movables=pieces.filter(p=>p.movable);
    movables.forEach((p,i)=>{
      const isLeg=p.id.includes('patte')||p.id.includes('jambe');
      const isArm=p.id.includes('bras');
      const isWing=p.id.includes('aile');
      const isTail=p.id.includes('queue');
      const isHead=p.id==='tete';
      allMotions.push({
        piece_id:p.id,
        motion:isWing?"OSCILLATE":isLeg?"OSCILLATE":isArm?"OSCILLATE":isTail?"OSCILLATE":isHead?"OSCILLATE":"TRANSLATE_V",
        pivot:isLeg?"top":isArm?"top":isWing?"bottom":isTail?"left":"center",
        amplitude:isWing?35:isLeg?25:isTail?40:isHead?20:15,
        speed:"medium",
        phase:i%2===0?0:180,
        cam_profile:"smooth",
        cam_index:Math.min(i,3)
      });
    });
    totalCams=Math.min(movables.length,4);
  }

  // Cap at 4 cams
  allMotions.forEach(m=>{m.cam_index=Math.min(m.cam_index,3);});
  totalCams=Math.min(totalCams,4);

  // Build groups
  const groups=[];
  for(let ci=0;ci<=3;ci++){
    const gp=allMotions.filter(m=>m.cam_index===ci);
    if(gp.length>0) groups.push({cam_index:ci,pieces:gp.map(m=>m.piece_id),note:gp.map(m=>m.piece_id).join('+')});
  }

  return{description:t,cam_count:totalCams||1,drive:"crank",motions:allMotions,groups};
}

/* Prompts IA gard√©s dans PROMPTS_IA.md sur GitHub pour l'int√©gration backend future */

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STEP 1: DECOMPOSE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function doDecompose(){
  const input = document.getElementById('aiInput').value.trim();
  if(!input) return;
  const btn = document.getElementById('btnDecompose');
  btn.disabled=true; btn.textContent='üß† D√©composition...';

  // Simulate brief AI thinking
  await new Promise(r=>setTimeout(r,400));

  try{
    const key = matchTemplate(input);
    if(!key){
      alert("Je ne reconnais pas encore √ßa ! Essaie :\n\nüêæ Animaux: chien, chat, oiseau, canard, poisson, dinosaure, cheval, papillon, grenouille, tortue, pingouin, lapin, serpent, crabe, hibou, cochon, √©l√©phant, girafe\n\nüë§ Personnages: bonhomme, robot, danseuse, ninja, astronaute, pirate\n\nüîß Objets: moulin, fus√©e, fleur, avion, voiture, bateau, √©toile, arbre");
      btn.disabled=false; btn.textContent='üß† D√©composer en formes';
      return;
    }
    figurine = JSON.parse(JSON.stringify(TEMPLATES[key])); // deep clone
    motions = null;
    selectedPiece = null;
    goToStep(2);
    renderPiecesList();
    startRenderer();
    rebuildAll3D();
    document.getElementById('emptyState').style.display='none';
    document.getElementById('badgeFDM').style.display='';
    document.getElementById('piecesHeader').style.display='';
    document.getElementById('statPieces').textContent=figurine.pieces.length+'p';
    document.getElementById('badgePieces').textContent=figurine.pieces.length+'p ¬∑ '+figurine.name;
    document.getElementById('badgePieces').style.display='';
  }catch(e){
    console.error(e);
    alert("Erreur: "+e.message);
  }
  btn.disabled=false; btn.textContent='üß† D√©composer en formes';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STEP 2: MOVEMENT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function doMotion(){
  const input = document.getElementById('aiMotion').value.trim();
  if(!input || !figurine) return;
  const btn = document.getElementById('btnMotion');
  btn.disabled=true; btn.textContent='‚öôÔ∏è Analyse...';

  // Simulate brief thinking
  await new Promise(r=>setTimeout(r,400));

  try{
    motions = matchMotions(input, figurine.pieces);
    goToStep(3);
    document.getElementById('statCams').textContent=motions.cam_count;
    document.getElementById('btnGenerate').disabled=false;
    renderPiecesList();
    rebuildAll3D();
  }catch(e){
    console.error(e);
    alert("Erreur: "+e.message);
  }
  btn.disabled=false; btn.textContent='‚öôÔ∏è Assigner les mouvements';
}

function backToStep1(){
  goToStep(1);
  motions=null;
  document.getElementById('btnGenerate').disabled=true;
}

function goToStep(n){
  currentStep=n;
  document.getElementById('s1').className='step'+(n>=1?(n===1?' active':' done'):'');
  document.getElementById('s2').className='step'+(n>=2?(n===2?' active':' done'):'');
  document.getElementById('s3').className='step'+(n>=3?' active done':'');
  document.getElementById('stepDescribe').style.display=n===1?'':'none';
  document.getElementById('stepMovement').style.display=n>=2?'':'none';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PIECES LIST
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPiecesList(){
  if(!figurine) return;
  const el = document.getElementById('piecesList');
  document.getElementById('pieceCount').textContent=figurine.pieces.length+'p';
  el.innerHTML = figurine.pieces.map((p,i)=>{
    const c = COLORS[i%COLORS.length];
    const motionInfo = motions?.motions?.find(m=>m.piece_id===p.id);
    const motionIcon = motionInfo ? {TRANSLATE_V:'‚Üï',TRANSLATE_H:'‚Üî',OSCILLATE:'üîÑ',ROTATE:'‚ü≥'}[motionInfo.motion]||'' : '';
    return `<div class="piece-item${selectedPiece===p.id?' selected':''}" onclick="selectPiece('${p.id}')">
      <div class="piece-dot" style="background:${c}"></div>
      <span class="piece-name">${p.name}</span>
      <span class="piece-shape">${p.shape.type}</span>
      ${motionIcon?`<span style="font-size:.7rem">${motionIcon}</span>`:''}
      <span class="piece-movable${p.movable?' on':''}" onclick="event.stopPropagation();toggleMovable('${p.id}')">${p.movable?'‚ö°':'‚óã'}</span>
    </div>`;
  }).join('');
}


function selectPiece(id){
  selectedPiece=selectedPiece===id?null:id;
  renderPiecesList();
  if(selectedPiece && motions){
    const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m){
      // Sync motion type
      document.querySelectorAll('.motion-btn').forEach(b=>b.classList.remove('active'));
      const moId={TRANSLATE_V:'mo_tv',TRANSLATE_H:'mo_th',OSCILLATE:'mo_osc',ROTATE:'mo_rot'}[m.motion];
      if(moId) document.getElementById(moId)?.classList.add('active');

      // Sync amplitude
      document.getElementById('slAmp').value=m.amplitude||30;
      document.getElementById('valAmp').textContent=(m.amplitude||30)+'¬∞';

      // Sync speed
      const speeds=[0.25,0.5,1,1.5,2,3];
      const spdVal=m.speed==='slow'?2:m.speed==='fast'?5:3;
      document.getElementById('slSpeed').value=spdVal;
      document.getElementById('valSpeed').textContent=speeds[spdVal-1]+' Hz';

      // Sync profile
      document.querySelectorAll('.profile-row .prof-btn').forEach(b=>b.classList.remove('on'));
      document.querySelectorAll('.profile-row .prof-btn').forEach(b=>{
        if(b.textContent.toLowerCase()===m.cam_profile) b.classList.add('on');
      });

      // Sync phase
      document.querySelectorAll('.phase-row .phase-btn').forEach(b=>b.classList.remove('on'));
      document.querySelectorAll('.phase-row .phase-btn').forEach(b=>{
        if(b.textContent===m.phase+'¬∞') b.classList.add('on');
      });
    }
  }
  highlightSelected3D();
}
function toggleMovable(id){
  const p=figurine.pieces.find(p=>p.id===id);
  if(p){p.movable=!p.movable;renderPiecesList();rebuildAll3D();}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RIGHT PANEL CONTROLS ‚Äî all trigger 3D update
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setShape(type){
  document.querySelectorAll('.shape-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('sh_'+type)?.classList.add('active');
  if(selectedPiece && figurine){
    const p=figurine.pieces.find(pp=>pp.id===selectedPiece);
    if(p){
      const defaults={circle:{type:'circle',r:15},rect:{type:'rect',w:30,h:20},tri:{type:'tri',base:20,h:18},square:{type:'square',s:20},ellipse:{type:'ellipse',rx:25,ry:15},diamond:{type:'diamond',w:20,h:25}};
      p.shape=defaults[type]||p.shape;
      renderPiecesList();rebuildAll3D();
    }
  }
}
function setMotion(type){
  document.querySelectorAll('.motion-btn').forEach(b=>b.classList.remove('active'));
  const moId={TRANSLATE_V:'mo_tv',TRANSLATE_H:'mo_th',OSCILLATE:'mo_osc',ROTATE:'mo_rot'}[type];
  if(moId) document.getElementById(moId)?.classList.add('active');
  if(motions){
    if(selectedPiece){
      const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
      if(m) m.motion=type;
    } else {
      motions.motions.forEach(m=>m.motion=type);
    }
  }
  rebuildAll3D();
}
function setPhase(deg){
  document.querySelectorAll('.phase-row .phase-btn').forEach(b=>b.classList.remove('on'));
  event.target.classList.add('on');
  if(motions){
    if(selectedPiece){
      const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
      if(m) m.phase=deg;
    } else {
      motions.motions.forEach(m=>m.phase=deg);
    }
  }
}
function setProfile(prof){
  document.querySelectorAll('.profile-row .prof-btn').forEach(b=>b.classList.remove('on'));
  event.target.classList.add('on');
  if(motions){
    if(selectedPiece){
      const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
      if(m) m.cam_profile=prof;
    } else {
      // No piece selected ‚Üí apply to ALL
      motions.motions.forEach(m=>m.cam_profile=prof);
    }
  }
  rebuildAll3D();
}
function setPivot(piv){
  document.querySelectorAll('.pivot-row .phase-btn, .phase-row:last-of-type .phase-btn').forEach(b=>b.classList.remove('on'));
  if(event&&event.target) event.target.classList.add('on');
  if(motions){
    if(selectedPiece){
      const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
      if(m) m.pivot=piv;
    } else {
      motions.motions.forEach(m=>m.pivot=piv);
    }
  }
  rebuildAll3D();
}
function updateParam(){
  const amp=document.getElementById('slAmp').value;
  const spd=document.getElementById('slSpeed').value;
  const sz=document.getElementById('slSize').value;
  const speeds=[0.25,0.5,1,1.5,2,3];
  document.getElementById('valAmp').textContent=amp+'¬∞';
  document.getElementById('valSpeed').textContent=speeds[spd-1]+' Hz';
  document.getElementById('valSize').textContent=sz+'%';
  if(motions){
    const spdName=speeds[spd-1]<=0.5?'slow':speeds[spd-1]<=1.5?'medium':'fast';
    if(selectedPiece){
      const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
      if(m){m.amplitude=+amp;m.speed=spdName;}
    } else {
      motions.motions.forEach(m=>{m.amplitude=+amp;m.speed=spdName;});
    }
  }
  if(figurine){
    if(selectedPiece){
      const p=figurine.pieces.find(pp=>pp.id===selectedPiece);
      if(p) p._scale=(+sz)/100;
    } else {
      figurine.pieces.forEach(p=>p._scale=(+sz)/100);
    }
  }
  rebuildAll3D();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STL BINARY GENERATOR
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function vec3cross(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]];}
function vec3sub(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]];}
function vec3norm(v){const l=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]);return l>0?[v[0]/l,v[1]/l,v[2]/l]:[0,0,1];}
function triNormal(a,b,c){return vec3norm(vec3cross(vec3sub(b,a),vec3sub(c,a)));}
function buildSTL(triangles){
  const buf=new ArrayBuffer(84+triangles.length*50);
  const dv=new DataView(buf);
  const hdr='Automata Generator V7 - sky1241';
  for(let i=0;i<80;i++) dv.setUint8(i,i<hdr.length?hdr.charCodeAt(i):0);
  dv.setUint32(80,triangles.length,true);
  let off=84;
  triangles.forEach(tri=>{
    const n=triNormal(tri[0],tri[1],tri[2]);
    dv.setFloat32(off,n[0],true);dv.setFloat32(off+4,n[1],true);dv.setFloat32(off+8,n[2],true);off+=12;
    for(let v=0;v<3;v++){dv.setFloat32(off,tri[v][0],true);dv.setFloat32(off+4,tri[v][1],true);dv.setFloat32(off+8,tri[v][2],true);off+=12;}
    dv.setUint16(off,0,true);off+=2;
  });
  return new Blob([buf],{type:'application/octet-stream'});
}
function realCamRadiusSTL(angle,camData){
  const baseR=camData.base_radius_mm||4;
  const lift=camData.lift_mm||5;
  const theta=((angle)%(Math.PI*2)+Math.PI*2)%(Math.PI*2);
  let d=0;
  const prof=camData.profile||'smooth';
  if(prof==='smooth'){if(theta<Math.PI) d=lift*Math.sin(theta); else d=0;}
  else if(prof==='sharp'){if(theta<Math.PI/3) d=lift*(theta/(Math.PI/3));else if(theta<Math.PI*2/3) d=lift*(1-(theta-Math.PI/3)/(Math.PI/3));else d=0;}
  else{if(theta<Math.PI/4) d=lift*(theta/(Math.PI/4));else if(theta<Math.PI*3/4) d=lift;else if(theta<Math.PI) d=lift*(1-(theta-Math.PI*3/4)/(Math.PI/4));else d=0;}
  return baseR+d;
}

function doGenerate(){
  if(!figurine||!motions) return alert("Pas de figurine ou mouvements d√©finis");
  const boxW=70,boxD=40,boxH=30,wall=2,shaftR=2.5,shaftLen=boxD-4,shaftZ=boxH*0.5;
  let allTris=[];
  // Box
  const hw=boxW/2,hd=boxD/2;
  const o=[[-hw,-hd,0],[hw,-hd,0],[hw,hd,0],[-hw,hd,0],[-hw,-hd,boxH],[hw,-hd,boxH],[hw,hd,boxH],[-hw,hd,boxH]];
  allTris.push([o[0],o[2],o[1]],[o[0],o[3],o[2]]);
  [[0,1,5,4],[1,2,6,5],[2,3,7,6],[3,0,4,7]].forEach(f=>{allTris.push([o[f[0]],o[f[1]],o[f[2]]],[o[f[0]],o[f[2]],o[f[3]]]);});
  // Shaft
  for(let i=0;i<24;i++){
    const a1=(i/24)*Math.PI*2,a2=((i+1)/24)*Math.PI*2;
    const x1=shaftR*Math.cos(a1),z1=shaftR*Math.sin(a1)+shaftZ;
    const x2=shaftR*Math.cos(a2),z2=shaftR*Math.sin(a2)+shaftZ;
    allTris.push([[x1,-shaftLen/2,z1],[x2,-shaftLen/2,z2],[x2,shaftLen/2,z2]],[[x1,-shaftLen/2,z1],[x2,shaftLen/2,z2],[x1,shaftLen/2,z1]]);
  }
  // Cams
  const nCams=motions.cam_count;
  for(let ci=0;ci<nCams;ci++){
    const pieces=motions.motions.filter(m=>m.cam_index===ci);
    const maxAmp=pieces.length>0?Math.max(...pieces.map(m=>m.amplitude)):20;
    const prof=pieces.length>0?pieces[0].cam_profile:'smooth';
    const mot=pieces.length>0?pieces[0].motion:'OSCILLATE';
    let lift;
    if(mot==='ROTATE') lift=3;else if(mot==='TRANSLATE_V'||mot==='TRANSLATE_H') lift=maxAmp*0.4;else lift=15*Math.sin(maxAmp*Math.PI/180);
    lift=Math.max(2,Math.min(lift,8));
    const camD={base_radius_mm:4,lift_mm:lift,profile:prof};
    const yPos=(ci-(nCams-1)/2)*(shaftLen*0.6/Math.max(nCams-1,1));
    const thick=4,y1=yPos-thick/2,y2=yPos+thick/2;
    const pts=[];
    for(let i=0;i<72;i++){const a=(i/72)*Math.PI*2;const r=realCamRadiusSTL(a,camD);pts.push([r*Math.cos(a),r*Math.sin(a)]);}
    for(let i=0;i<72;i++){
      const j=(i+1)%72;const p1=pts[i],p2=pts[j];
      allTris.push([[0,y1,shaftZ],[p2[0],y1,p2[1]+shaftZ],[p1[0],y1,p1[1]+shaftZ]]);
      allTris.push([[0,y2,shaftZ],[p1[0],y2,p1[1]+shaftZ],[p2[0],y2,p2[1]+shaftZ]]);
      allTris.push([[p1[0],y1,p1[1]+shaftZ],[p2[0],y1,p2[1]+shaftZ],[p2[0],y2,p2[1]+shaftZ]]);
      allTris.push([[p1[0],y1,p1[1]+shaftZ],[p2[0],y2,p2[1]+shaftZ],[p1[0],y2,p1[1]+shaftZ]]);
    }
  }
  const stlBlob=buildSTL(allTris);
  const url=URL.createObjectURL(stlBlob);
  const a=document.createElement('a');a.href=url;a.download=`automata_${figurine.name.replace(/[^a-zA-Z0-9]/g,'_')}.stl`;a.click();URL.revokeObjectURL(url);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UNIFIED THREE.JS 3D SCENE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const COLORS3D=[0xFF6B35,0x60A5FA,0xF472B6,0xFBBF24,0xA78BFA,0x34D399,0xFF9F43,0xF87171,0x818CF8,0x2DD4BF,0xFB7185,0xC084FC];
let scene,camera,renderer,figGroup,mechGroup,clock;
let rotY=0.6,rotX=-0.3,isDrag=false,lmx=0,lmy=0;
let animFrame=0;

function startRenderer(){
  // Hide 2D canvas, show 3D
  document.getElementById('mainCanvas').style.display='none';
  const container=document.getElementById('mechView3D');
  container.style.display='block';
  container.style.height='100%';
  container.style.position='absolute';
  container.style.top='0';
  container.style.borderTop='none';
  container.style.background='#0a0a12';

  if(renderer) return; // already init

  const w=container.clientWidth||800,h=container.clientHeight||600;
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x0a0a12);
  scene.fog=new THREE.FogExp2(0x0a0a12,0.003);

  camera=new THREE.PerspectiveCamera(42,w/h,0.1,800);
  camera.position.set(90,80,110);
  camera.lookAt(0,25,0);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(w,h);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.shadowMap.enabled=true;
  container.appendChild(renderer.domElement);

  // Lights
  scene.add(new THREE.AmbientLight(0xffffff,0.35));
  const sun=new THREE.DirectionalLight(0xffffff,0.7);sun.position.set(60,100,80);sun.castShadow=true;scene.add(sun);
  const fill=new THREE.DirectionalLight(0x6688cc,0.3);fill.position.set(-50,40,-60);scene.add(fill);
  const rim=new THREE.DirectionalLight(0xff6b35,0.15);rim.position.set(0,-20,80);scene.add(rim);

  // Ground grid
  const grid=new THREE.GridHelper(200,40,0x222230,0x181820);scene.add(grid);

  // Ground plane (receives shadow)
  const ground=new THREE.Mesh(new THREE.PlaneGeometry(200,200),new THREE.MeshPhongMaterial({color:0x0c0c14,depthWrite:false}));
  ground.rotation.x=-Math.PI/2;ground.receiveShadow=true;scene.add(ground);

  figGroup=new THREE.Group();scene.add(figGroup);
  mechGroup=new THREE.Group();scene.add(mechGroup);

  clock=new THREE.Clock();

  // Orbit controls
  const el=renderer.domElement;
  el.addEventListener('mousedown',e=>{isDrag=true;lmx=e.clientX;lmy=e.clientY;});
  window.addEventListener('mousemove',e=>{
    if(!isDrag) return;
    rotY+=(e.clientX-lmx)*0.007;rotX+=(e.clientY-lmy)*0.005;
    rotX=Math.max(-0.8,Math.min(1.0,rotX));
    lmx=e.clientX;lmy=e.clientY;updateCamera();
  });
  window.addEventListener('mouseup',()=>isDrag=false);
  el.addEventListener('wheel',e=>{camera.position.multiplyScalar(e.deltaY>0?1.06:0.94);updateCamera();e.preventDefault();},{passive:false});
  // Touch
  el.addEventListener('touchstart',e=>{if(e.touches.length===1){isDrag=true;lmx=e.touches[0].clientX;lmy=e.touches[0].clientY;}},{passive:true});
  el.addEventListener('touchmove',e=>{
    if(!isDrag||e.touches.length!==1) return;
    rotY+=(e.touches[0].clientX-lmx)*0.007;rotX+=(e.touches[0].clientY-lmy)*0.005;
    rotX=Math.max(-0.8,Math.min(1.0,rotX));
    lmx=e.touches[0].clientX;lmy=e.touches[0].clientY;updateCamera();
  },{passive:true});
  el.addEventListener('touchend',()=>isDrag=false);

  updateCamera();

  // Resize
  new ResizeObserver(()=>{
    const w2=container.clientWidth,h2=container.clientHeight;
    if(w2>0&&h2>0){camera.aspect=w2/h2;camera.updateProjectionMatrix();renderer.setSize(w2,h2);}
  }).observe(container);

  window.zoomIn=()=>{camera.position.multiplyScalar(0.85);updateCamera();};
  window.zoomOut=()=>{camera.position.multiplyScalar(1.15);updateCamera();};
  window.zoomReset=()=>{camera.position.set(90,80,110);rotY=0.6;rotX=-0.3;updateCamera();};

  animate();
}

function updateCamera(){
  const d=camera.position.length();
  camera.position.set(d*Math.cos(rotX)*Math.sin(rotY),Math.max(8,d*Math.sin(rotX)+35),d*Math.cos(rotX)*Math.cos(rotY));
  camera.lookAt(0,20,0);
}

function animate(){
  requestAnimationFrame(animate);
  animFrame++;
  const t=animFrame*0.03;

  // ‚îÄ‚îÄ FIGURINE ANIMATION ‚îÄ‚îÄ
  if(figGroup && motions){
    figGroup.children.forEach(mesh=>{
      const pid=mesh.userData.pieceId;
      if(!pid) return;
      const m=motions.motions.find(mo=>mo.piece_id===pid);
      if(!m) return;
      const orig=mesh.userData.origPos;
      const origR=mesh.userData.origRot||0;
      if(!orig) return;

      const spd=m.speed==='slow'?0.5:m.speed==='fast'?2.5:1.2;
      const phase=(m.phase||0)*Math.PI/180;
      const cycle=(t*spd+phase)%(Math.PI*2);

      // PROFILE ‚Äî each one produces a COMPLETELY DIFFERENT wave shape
      let wave;
      if(m.cam_profile==='sharp'){
        // TRIANGLE WAVE: linear up then linear down, fast transitions
        const p=cycle/(Math.PI*2); // 0‚Üí1
        wave=p<0.25? p*4 : p<0.75? 2-p*4 : p*4-4; // -1 to +1 triangle
      } else if(m.cam_profile==='dwell'){
        // SQUARE WAVE: snap up, hold, snap down, hold
        const p=cycle/(Math.PI*2);
        if(p<0.05) wave=p*20; // quick rise
        else if(p<0.45) wave=1; // HOLD UP
        else if(p<0.55) wave=1-(p-0.45)*20; // quick fall
        else if(p<0.95) wave=-1; // HOLD DOWN 
        else wave=-1+(p-0.95)*20; // quick rise back
      } else {
        // SMOOTH: gentle sine
        wave=Math.sin(cycle);
      }

      const amp=Math.max(m.amplitude||30, 20);

      if(m.motion==='TRANSLATE_V'){
        mesh.position.y=orig.y + wave*amp*0.6;
      } else if(m.motion==='TRANSLATE_H'){
        mesh.position.x=orig.x + wave*amp*0.5;
      } else if(m.motion==='OSCILLATE'){
        mesh.rotation.z=origR + wave*(amp*Math.PI/100);
      } else if(m.motion==='ROTATE'){
        mesh.rotation.z=t*spd;
      }
    });
  }

  // ‚îÄ‚îÄ MECHANISM ANIMATION ‚îÄ‚îÄ
  if(mechGroup){
    mechGroup.children.forEach(mesh=>{
      if(mesh.userData.isCam){
        mesh.rotation.z=(mesh.userData.camRotOffset||0)+t*0.8;
      }
      if(mesh.userData.isFollower||mesh.userData.isTbar){
        const camData=mesh.userData.camData;
        if(camData){
          const rot=(mesh.userData.camRotOffset||0)+t*0.8;
          const angle=((rot+Math.PI*1.5)%(Math.PI*2)+Math.PI*2)%(Math.PI*2);
          const r=realCamRadiusSTL(angle,camData);
          const lift=(r-(camData.base_radius_mm||4));
          mesh.position.y=mesh.userData.baseY + lift*2.0; // big visible bounce
        }
      }
    });
  }

  renderer.render(scene,camera);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUILD 3D FIGURINE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getShapeSize(s){
  if(s.type==='circle') return{w:s.r*2,h:s.r*2};
  if(s.type==='ellipse') return{w:s.rx*2,h:s.ry*2};
  if(s.type==='rect') return{w:s.w,h:s.h};
  if(s.type==='square') return{w:s.s,h:s.s};
  if(s.type==='tri') return{w:s.base,h:s.h};
  if(s.type==='diamond') return{w:s.w,h:s.h};
  return{w:20,h:20};
}

function make3DShape(shape,scale=1){
  const s=getShapeSize(shape);
  const w=s.w*scale,h=s.h*scale;
  const depth=Math.max(w,h)*0.3; // extrusion depth
  let geo;
  if(shape.type==='circle'){
    geo=new THREE.CylinderGeometry(w/2,w/2,depth,24);
  } else if(shape.type==='ellipse'){
    // Use shape + extrude for ellipse
    const sh=new THREE.Shape();
    for(let i=0;i<=48;i++){
      const a=(i/48)*Math.PI*2;
      const px=w/2*Math.cos(a),py=h/2*Math.sin(a);
      i===0?sh.moveTo(px,py):sh.lineTo(px,py);
    }
    geo=new THREE.ExtrudeGeometry(sh,{depth,bevelEnabled:true,bevelThickness:0.5,bevelSize:0.5,bevelSegments:2});
  } else if(shape.type==='rect'||shape.type==='square'){
    geo=new THREE.BoxGeometry(w,h,depth);
  } else if(shape.type==='tri'){
    const sh=new THREE.Shape();
    sh.moveTo(0,h/2);sh.lineTo(w/2,-h/2);sh.lineTo(-w/2,-h/2);sh.closePath();
    geo=new THREE.ExtrudeGeometry(sh,{depth,bevelEnabled:true,bevelThickness:0.3,bevelSize:0.3,bevelSegments:1});
  } else if(shape.type==='diamond'){
    const sh=new THREE.Shape();
    sh.moveTo(0,h/2);sh.lineTo(w/2,0);sh.lineTo(0,-h/2);sh.lineTo(-w/2,0);sh.closePath();
    geo=new THREE.ExtrudeGeometry(sh,{depth,bevelEnabled:true,bevelThickness:0.3,bevelSize:0.3,bevelSegments:1});
  } else {
    geo=new THREE.BoxGeometry(w,h,depth);
  }
  return geo;
}

function buildFigurine3D(){
  while(figGroup.children.length) figGroup.remove(figGroup.children[0]);
  if(!figurine) return;

  const figBaseY=50;
  const meshMap={};

  // Sort: root pieces first, then children
  const sorted=[...figurine.pieces].sort((a,b)=>{
    if(a.parent==='root'&&b.parent!=='root') return -1;
    if(a.parent!=='root'&&b.parent==='root') return 1;
    return 0;
  });

  sorted.forEach((p,i)=>{
    const scale=p._scale||1;
    const s=getShapeSize(p.shape);
    const geo=make3DShape(p.shape,scale);
    const ci=figurine.pieces.indexOf(p);
    const color=COLORS3D[ci%COLORS3D.length];
    const mat=new THREE.MeshPhongMaterial({color,shininess:40,transparent:true,opacity:p.movable?1:0.7});

    // Offset geometry for pivot point (so rotation works from the right point)
    const m=motions?motions.motions.find(mo=>mo.piece_id===p.id):null;
    const pivot=m?m.pivot:'center';
    const h2=s.h*scale/2, w2=s.w*scale/2;
    if(pivot==='top') geo.translate(0,-h2,0);
    else if(pivot==='bottom') geo.translate(0,h2,0);
    else if(pivot==='left') geo.translate(w2,0,0);
    else if(pivot==='right') geo.translate(-w2,0,0);
    // center = no offset

    const mesh=new THREE.Mesh(geo,mat);
    mesh.castShadow=true;

    // Position in world
    let px=p.position.x*0.7;
    let py=-p.position.y*0.7+figBaseY;
    const pz=-(p.layer||0)*4;

    // Adjust pivot position
    if(pivot==='top') py+=h2*0.7;
    else if(pivot==='bottom') py-=h2*0.7;

    mesh.position.set(px,py,pz);
    if(p.rotation) mesh.rotation.z=p.rotation*Math.PI/180;

    mesh.userData={
      pieceId:p.id,
      origPos:new THREE.Vector3(px,py,pz),
      origRot:p.rotation?p.rotation*Math.PI/180:0,
      isMovable:p.movable,
      pivot
    };
    meshMap[p.id]=mesh;

    // Movable glow
    if(p.movable){
      const glowGeo=new THREE.SphereGeometry(Math.max(s.w,s.h)*scale*0.35,8,8);
      const glow=new THREE.Mesh(glowGeo,new THREE.MeshBasicMaterial({color:0xff6b35,transparent:true,opacity:0.08,side:THREE.DoubleSide}));
      glow.position.copy(mesh.position);
      figGroup.add(glow);
    }

    figGroup.add(mesh);
  });

  // Draw connection lines between parent-child
  sorted.forEach(p=>{
    if(p.parent==='root') return;
    const parentMesh=meshMap[p.parent];
    const childMesh=meshMap[p.id];
    if(parentMesh&&childMesh){
      const lineGeo=new THREE.BufferGeometry().setFromPoints([parentMesh.position,childMesh.position]);
      const line=new THREE.Line(lineGeo,new THREE.LineBasicMaterial({color:0x444466,transparent:true,opacity:0.3}));
      figGroup.add(line);
    }
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUILD 3D MECHANISM
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildMechanism3D(){
  while(mechGroup.children.length) mechGroup.remove(mechGroup.children[0]);

  const boxW=70,boxD=40,boxH=30,wall=2;
  const shR=2.5,shLen=boxD-4;
  const shZ=boxH*0.45;

  // Box
  const boxGeo=new THREE.BoxGeometry(boxW,boxH,boxD);
  const boxMat=new THREE.MeshPhongMaterial({color:0x6B5E52,transparent:true,opacity:0.12,side:THREE.DoubleSide,depthWrite:false});
  const box=new THREE.Mesh(boxGeo,boxMat);box.position.set(0,boxH/2,0);mechGroup.add(box);
  const edges=new THREE.LineSegments(new THREE.EdgesGeometry(boxGeo),new THREE.LineBasicMaterial({color:0x8A7A68,transparent:true,opacity:0.5}));
  edges.position.copy(box.position);mechGroup.add(edges);

  // Shaft
  const shGeo=new THREE.CylinderGeometry(shR,shR,shLen,20);
  const shMat=new THREE.MeshPhongMaterial({color:0xAAAAAA,shininess:80});
  const sh=new THREE.Mesh(shGeo,shMat);sh.rotation.x=Math.PI/2;sh.position.set(0,shZ,0);sh.castShadow=true;mechGroup.add(sh);

  // Bearings + pillars
  [-shLen/2,shLen/2].forEach(z=>{
    const b=new THREE.Mesh(new THREE.CylinderGeometry(5,5,3,20),new THREE.MeshPhongMaterial({color:0x6B5E52,shininess:20}));
    b.rotation.x=Math.PI/2;b.position.set(0,shZ,z);mechGroup.add(b);
    const p=new THREE.Mesh(new THREE.BoxGeometry(3,shZ,3),new THREE.MeshPhongMaterial({color:0x5A4E42}));
    p.position.set(0,shZ/2,z);mechGroup.add(p);
  });

  // Cams
  if(!motions) return;
  const nCams=motions.cam_count;
  const camColors=[0xD4652A,0xC85A22,0xBC4F1C,0xA84518];
  for(let ci=0;ci<Math.min(nCams,4);ci++){
    const pieces=motions.motions.filter(m=>m.cam_index===ci);
    const maxAmp=pieces.length>0?Math.max(...pieces.map(m=>m.amplitude)):20;
    const prof=pieces.length>0?pieces[0].cam_profile:'smooth';
    const mot=pieces.length>0?pieces[0].motion:'OSCILLATE';
    let lift;
    if(mot==='ROTATE') lift=3;else if(mot==='TRANSLATE_V'||mot==='TRANSLATE_H') lift=maxAmp*0.4;else lift=15*Math.sin(maxAmp*Math.PI/180);
    lift=Math.max(2,Math.min(lift,8));
    const camD={base_radius_mm:4,lift_mm:lift,profile:prof};
    const zPos=(ci-(nCams-1)/2)*(shLen*0.6/Math.max(nCams-1,1));
    const thick=4;

    // Cam shape
    const shape=new THREE.Shape();
    for(let i=0;i<=72;i++){
      const a=(i/72)*Math.PI*2;const r=realCamRadiusSTL(a,camD);
      const px=r*Math.cos(a),py=r*Math.sin(a);
      i===0?shape.moveTo(px,py):shape.lineTo(px,py);
    }
    const hole=new THREE.Path();
    for(let i=0;i<=24;i++){
      const a=(i/24)*Math.PI*2;
      i===0?hole.moveTo(shR*Math.cos(a),shR*Math.sin(a)):hole.lineTo(shR*Math.cos(a),shR*Math.sin(a));
    }
    shape.holes.push(hole);
    const camGeo=new THREE.ExtrudeGeometry(shape,{depth:thick,bevelEnabled:false});
    const camMat=new THREE.MeshPhongMaterial({color:camColors[ci],shininess:30});
    const camMesh=new THREE.Mesh(camGeo,camMat);
    camMesh.rotation.x=Math.PI/2;
    camMesh.position.set(0,shZ,zPos-thick/2);
    camMesh.userData={isCam:true,camRotOffset:ci*Math.PI*0.3};
    camMesh.castShadow=true;
    mechGroup.add(camMesh);

    // Follower
    const maxR=4+lift;
    const fLen=boxH-shZ-maxR+10;
    const fGeo=new THREE.CylinderGeometry(1.5,1.5,fLen,8);
    const fMat=new THREE.MeshPhongMaterial({color:0xC4A44A,shininess:50});
    const f=new THREE.Mesh(fGeo,fMat);
    f.position.set(0,shZ+maxR+fLen/2,zPos);
    f.userData={isFollower:true,camIndex:ci,camData:camD,baseY:shZ+maxR+fLen/2,camRotOffset:ci*Math.PI*0.3};
    mechGroup.add(f);

    // T-bar
    const tGeo=new THREE.BoxGeometry(16,1.5,3);
    const t=new THREE.Mesh(tGeo,fMat);
    const tbarY=shZ+maxR+fLen;
    t.position.set(0,tbarY,zPos);
    t.userData={isTbar:true,camData:camD,baseY:tbarY,camRotOffset:ci*Math.PI*0.3};
    mechGroup.add(t);

    // Cam label (sprite)
    const canvas2=document.createElement('canvas');canvas2.width=128;canvas2.height=32;
    const ctx2=canvas2.getContext('2d');
    ctx2.fillStyle='rgba(0,0,0,0)';ctx2.fillRect(0,0,128,32);
    ctx2.fillStyle='#D4652A';ctx2.font='bold 14px sans-serif';ctx2.textAlign='center';
    const profLabel=prof==='smooth'?'Harm.':prof==='sharp'?'Tri.':'Dwell';
    ctx2.fillText(`CAM ${ci+1} ¬∑ ${profLabel} ${Math.round(maxAmp)}¬∞`,64,20);
    const tex=new THREE.CanvasTexture(canvas2);
    const spMat=new THREE.SpriteMaterial({map:tex,transparent:true});
    const sp=new THREE.Sprite(spMat);sp.scale.set(20,5,1);sp.position.set(0,2,zPos);
    mechGroup.add(sp);
  }

  // Crank or motor
  if(drive===0){
    const crankMat=new THREE.MeshPhongMaterial({color:0x556B8A,shininess:40});
    const arm=new THREE.Mesh(new THREE.CylinderGeometry(1,1,14,8),crankMat);
    arm.rotation.z=Math.PI/2;arm.position.set(7,shZ,-shLen/2-5);mechGroup.add(arm);
    const ball=new THREE.Mesh(new THREE.SphereGeometry(3,12,12),crankMat);
    ball.position.set(14,shZ,-shLen/2-5);mechGroup.add(ball);
  } else {
    const motor=new THREE.Mesh(new THREE.BoxGeometry(10,10,14),new THREE.MeshPhongMaterial({color:0x4A4038}));
    motor.position.set(0,shZ,shLen/2+10);mechGroup.add(motor);
  }
}

function rebuildAll3D(){
  if(!scene) return;
  buildFigurine3D();
  buildMechanism3D();
}

function highlightSelected3D(){
  if(!figGroup) return;
  figGroup.children.forEach(mesh=>{
    if(!mesh.material||!mesh.userData.pieceId) return;
    mesh.material.emissive=mesh.userData.pieceId===selectedPiece?new THREE.Color(0x333333):new THREE.Color(0x000000);
  });
}

window._explode=false;
function toggleExplode(){
  window._explode=!window._explode;
  const btn=document.getElementById('btnExplode');
  btn.style.background=window._explode?'rgba(255,107,53,.2)':'';
  btn.style.borderColor=window._explode?'var(--ac)':'';
  btn.style.color=window._explode?'var(--ac)':'';
  // Explode/implode figurine pieces
  if(figGroup && figurine){
    figGroup.children.forEach(mesh=>{
      if(!mesh.userData.pieceId) return;
      const orig=mesh.userData.origPos;
      if(orig){
        const factor=window._explode?1.6:1;
        mesh.position.set(orig.x*factor,orig.y+(window._explode?(orig.y-50)*0.3:0),orig.z*factor);
      }
    });
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
goToStep(1);

</script>
</body>
</html>
