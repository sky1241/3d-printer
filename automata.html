<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üî© Automata Generator V5</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;0,9..40,900;1,9..40,400&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#06060a;--s1:#0c0c14;--s2:#13131f;--s3:#1e1e32;--s4:#2a2a44;
  --t1:#e8e6f0;--t2:#7a7894;--t3:#4a4866;
  --ac:#ff6b35;--ac2:#ff8c5a;--acg:rgba(255,107,53,.08);
  --ok:#34d399;--warn:#fbbf24;--err:#f87171;
  --blu:#60a5fa;--blug:rgba(96,165,250,.08);
  --r:10px
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;overflow:hidden;-webkit-font-smoothing:antialiased}
.mono{font-family:'JetBrains Mono',monospace}

/* ‚ïê‚ïê‚ïê LAYOUT 3 COLONNES ‚ïê‚ïê‚ïê */
.app{display:grid;grid-template-columns:280px 1fr 260px;grid-template-rows:52px 1fr;height:100vh;gap:0}

/* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
.topbar{grid-column:1/-1;display:flex;align-items:center;padding:0 16px;background:var(--s1);border-bottom:1px solid var(--s3)}
.topbar-icon{width:32px;height:32px;background:var(--ac);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 12px rgba(255,107,53,.2);margin-right:10px}
.topbar h1{font-size:.95rem;font-weight:900;letter-spacing:-.02em}
.topbar-tag{font-size:.55rem;color:var(--t3);margin-left:8px;padding:2px 6px;background:var(--s3);border-radius:4px}.topbar-tag.mono{letter-spacing:.04em}
.topbar-drive{margin-left:auto;display:flex;align-items:center;gap:8px}
.drive-chip{display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:6px;border:1px solid var(--s3);background:var(--s2);cursor:pointer;font-size:.7rem;font-weight:700;color:var(--t3);transition:all .15s;font-family:'DM Sans'}
.drive-chip.on{border-color:var(--ac);color:var(--ac);background:var(--acg)}
.drive-chip.on-b{border-color:var(--blu);color:var(--blu);background:var(--blug)}
.topbar-gen{margin-left:12px;padding:6px 16px;border-radius:7px;border:none;background:var(--ac);color:#fff;font-weight:800;font-size:.72rem;cursor:pointer;font-family:'DM Sans';letter-spacing:.02em;transition:all .15s;box-shadow:0 2px 12px rgba(255,107,53,.25)}
.topbar-gen:hover{background:var(--ac2);transform:translateY(-1px)}
.topbar-gen:disabled{opacity:.4;cursor:not-allowed;transform:none}

/* ‚îÄ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ‚îÄ */
.left{background:var(--s1);border-right:1px solid var(--s3);display:flex;flex-direction:column;overflow:hidden}
.panel-h{padding:10px 14px 8px;font-size:.65rem;font-weight:700;color:var(--t3);letter-spacing:.06em;text-transform:uppercase;display:flex;align-items:center;gap:6px;border-bottom:1px solid rgba(255,255,255,.03)}
.panel-h .dot{width:5px;height:5px;border-radius:50%;background:var(--ac)}
.panel-h .dot-b{width:5px;height:5px;border-radius:50%;background:var(--blu)}

/* AI Input */
.ai-input-wrap{padding:10px 12px}
.ai-input{width:100%;min-height:70px;max-height:140px;resize:vertical;background:var(--s2);border:1px solid var(--s3);border-radius:8px;color:var(--t1);padding:10px 12px;font-family:'DM Sans',sans-serif;font-size:.78rem;line-height:1.5;outline:none;transition:border-color .15s}
.ai-input::placeholder{color:var(--t3)}
.ai-input:focus{border-color:var(--ac)}
.ai-btn{width:100%;padding:9px;border:none;border-radius:7px;font-weight:800;font-size:.72rem;cursor:pointer;font-family:'DM Sans';letter-spacing:.02em;transition:all .15s;margin-top:6px}
.ai-btn.primary{background:var(--ac);color:#fff;box-shadow:0 2px 10px rgba(255,107,53,.2)}
.ai-btn.primary:hover{background:var(--ac2)}
.ai-btn.secondary{background:var(--s3);color:var(--t2)}
.ai-btn.secondary:hover{background:var(--s4);color:var(--t1)}
.ai-btn:disabled{opacity:.35;cursor:not-allowed}

/* Step indicator */
.steps{display:flex;padding:8px 12px;gap:4px}
.step{flex:1;height:3px;border-radius:2px;background:var(--s3);transition:background .3s}
.step.done{background:var(--ok)}
.step.active{background:var(--ac);box-shadow:0 0 8px rgba(255,107,53,.3)}

/* Pieces list */
.pieces-list{flex:1;overflow-y:auto;padding:4px 8px}
.piece-item{display:flex;align-items:center;gap:8px;padding:7px 8px;border-radius:7px;cursor:pointer;transition:all .12s;border:1px solid transparent;margin-bottom:2px}
.piece-item:hover{background:var(--s2);border-color:var(--s3)}
.piece-item.selected{background:var(--acg);border-color:rgba(255,107,53,.2)}
.piece-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.piece-name{font-size:.72rem;font-weight:600;flex:1}
.piece-shape{font-size:.58rem;color:var(--t3);font-family:'JetBrains Mono'}
.piece-movable{font-size:.65rem;cursor:pointer;opacity:.5;transition:opacity .15s}
.piece-movable.on{opacity:1}

/* ‚îÄ‚îÄ‚îÄ CENTER CANVAS ‚îÄ‚îÄ‚îÄ */
.center{position:relative;background:var(--bg);display:flex;flex-direction:column}
.canvas-wrap{flex:1;position:relative;overflow:hidden}
.canvas-wrap canvas{width:100%;height:100%;display:block}
.cv-badge{position:absolute;bottom:10px;left:10px;font-size:.55rem;padding:3px 8px;border-radius:5px;font-weight:700;letter-spacing:.02em}
.cv-badge.ok{background:rgba(52,211,153,.12);color:var(--ok);border:1px solid rgba(52,211,153,.15)}
.cv-badge.tag{background:rgba(255,107,53,.08);color:var(--ac);border:1px solid rgba(255,107,53,.12)}
.cv-hint{position:absolute;bottom:10px;right:10px;font-size:.52rem;color:var(--t3)}
.zoom-bar{position:absolute;top:10px;right:10px;display:flex;gap:3px}
.zoom-bar button{width:26px;height:26px;border:1px solid var(--s3);background:rgba(6,6,10,.85);color:var(--t2);border-radius:6px;font-size:.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s}
.zoom-bar button:hover{background:var(--s3);color:var(--t1)}
/* Status bar */
.status-bar{display:flex;align-items:center;padding:6px 12px;background:var(--s1);border-top:1px solid var(--s3);gap:8px}
.stat{font-size:.6rem;color:var(--t3);display:flex;align-items:center;gap:4px}
.stat .v{color:var(--ac);font-weight:700;font-family:'JetBrains Mono'}
.stat .v-b{color:var(--blu);font-weight:700;font-family:'JetBrains Mono'}

/* ‚îÄ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ‚îÄ */
.right{background:var(--s1);border-left:1px solid var(--s3);display:flex;flex-direction:column;overflow-y:auto}

/* Shape buttons */
.shape-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;padding:8px 10px}
.shape-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;border-radius:7px;border:1px solid var(--s3);background:var(--s2);cursor:pointer;transition:all .12s}
.shape-btn:hover{border-color:var(--ac);background:var(--acg)}
.shape-btn.active{border-color:var(--ac);background:var(--acg);box-shadow:0 0 8px rgba(255,107,53,.15)}
.shape-btn svg{width:24px;height:24px}
.shape-btn span{font-size:.55rem;font-weight:700;color:var(--t2)}

/* Motion buttons */
.motion-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:4px;padding:8px 10px}
.motion-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 4px;border-radius:7px;border:1px solid var(--s3);background:var(--s2);cursor:pointer;transition:all .12s}
.motion-btn:hover{border-color:var(--blu);background:var(--blug)}
.motion-btn.active{border-color:var(--blu);background:var(--blug);box-shadow:0 0 8px rgba(96,165,250,.15)}
.motion-btn .ico{font-size:1.1rem}
.motion-btn span{font-size:.55rem;font-weight:700;color:var(--t2)}

/* Sliders */
.slider-group{padding:6px 10px}
.slider-row{margin-bottom:8px}
.slider-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.slider-label span{font-size:.6rem;font-weight:600;color:var(--t2)}
.slider-label .val{font-family:'JetBrains Mono';color:var(--ac);font-weight:700;font-size:.6rem}
.slider-label .val-b{font-family:'JetBrains Mono';color:var(--blu);font-weight:700;font-size:.6rem}
input[type=range]{-webkit-appearance:none;width:100%;height:4px;background:var(--s3);border-radius:2px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--ac);border-radius:50%;cursor:pointer;box-shadow:0 1px 6px rgba(255,107,53,.3)}
input[type=range].blu::-webkit-slider-thumb{background:var(--blu);box-shadow:0 1px 6px rgba(96,165,250,.3)}

/* Phase selector */
.phase-row{display:flex;gap:3px;padding:4px 10px 8px}
.phase-btn{flex:1;padding:6px;border:1px solid var(--s3);background:var(--s2);border-radius:5px;font-size:.6rem;font-weight:700;color:var(--t3);cursor:pointer;text-align:center;font-family:'JetBrains Mono';transition:all .12s}
.phase-btn.on{border-color:var(--blu);color:var(--blu);background:var(--blug)}

/* Profile selector */
.profile-row{display:flex;gap:3px;padding:4px 10px 8px}
.prof-btn{flex:1;padding:6px 4px;border:1px solid var(--s3);background:var(--s2);border-radius:5px;font-size:.55rem;font-weight:700;color:var(--t3);cursor:pointer;text-align:center;transition:all .12s}
.prof-btn.on{border-color:var(--warn);color:var(--warn);background:rgba(251,191,36,.08)}

/* Divider */
.divider{height:1px;background:var(--s3);margin:4px 10px}

/* Loading */
.loading{display:flex;align-items:center;gap:6px;padding:8px 12px;font-size:.7rem;color:var(--ac)}
.loading .spin{width:14px;height:14px;border:2px solid var(--s3);border-top-color:var(--ac);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* AI Response preview */
.ai-response{padding:6px 10px;font-size:.6rem;color:var(--ok);font-family:'JetBrains Mono';background:rgba(52,211,153,.04);border-radius:6px;margin:4px 12px;max-height:60px;overflow-y:auto;border:1px solid rgba(52,211,153,.08)}

/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--s3);border-radius:2px}

/* Empty state */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:10px;padding:20px}
.empty-state .big{font-size:2.5rem}
.empty-state p{font-size:.75rem;color:var(--t3);text-align:center;line-height:1.5;max-width:280px}
.empty-state .hint{font-size:.65rem;color:var(--t3);font-style:italic}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê TOP BAR ‚ïê‚ïê‚ïê -->
<div class="app">
<div class="topbar">
  <div class="topbar-icon">üî©</div>
  <h1>Automata Generator</h1>
  <span class="topbar-tag mono">V5</span>
  <div class="topbar-drive">
    <div class="drive-chip on-b" id="dCrank" onclick="setDrive(0)"><span>üñêÔ∏è</span> Manivelle</div>
    <div class="drive-chip" id="dMotor" onclick="setDrive(1)"><span>‚ö°</span> Moteur</div>
    <button class="topbar-gen" id="btnGenerate" disabled onclick="doGenerate()">‚¨á G√âN√âRER STL</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LEFT PANEL ‚ïê‚ïê‚ïê -->
<div class="left">
  <!-- Steps -->
  <div class="steps">
    <div class="step active" id="s1"></div>
    <div class="step" id="s2"></div>
    <div class="step" id="s3"></div>
  </div>

  <!-- Step 1: Describe -->
  <div id="stepDescribe">
    <div class="panel-h"><div class="dot"></div> √âTAPE 1 ‚Äî D√âCRIS TA FIGURINE</div>
    <div class="ai-input-wrap">
      <textarea class="ai-input" id="aiInput" placeholder="Ex: un chien, un oiseau qui vole, un robot, un dinosaure..."></textarea>
      <button class="ai-btn primary" id="btnDecompose" onclick="doDecompose()">üß† D√©composer en formes</button>
    </div>
  </div>

  <!-- Step 2: Movement -->
  <div id="stepMovement" style="display:none">
    <div class="panel-h"><div class="dot-b"></div> √âTAPE 2 ‚Äî D√âCRIS LE MOUVEMENT</div>
    <div class="ai-input-wrap">
      <textarea class="ai-input" id="aiMotion" placeholder="Ex: il remue la queue, il bat des ailes, il marche..."></textarea>
      <button class="ai-btn primary" style="background:var(--blu);box-shadow:0 2px 10px rgba(96,165,250,.2)" id="btnMotion" onclick="doMotion()">‚öôÔ∏è Assigner les mouvements</button>
      <button class="ai-btn secondary" style="margin-top:4px" onclick="backToStep1()">‚Üê Modifier les formes</button>
    </div>
  </div>

  <!-- Pieces list -->
  <div class="panel-h" id="piecesHeader" style="display:none"><div class="dot"></div> PI√àCES <span id="pieceCount" style="margin-left:auto;font-size:.6rem;color:var(--ac)" class="mono"></span></div>
  <div class="pieces-list" id="piecesList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê CENTER CANVAS ‚ïê‚ïê‚ïê -->
<div class="center">
  <div class="canvas-wrap">
    <canvas id="mainCanvas"></canvas>
    <div class="zoom-bar">
      <button onclick="toggleExplode()" id="btnExplode" title="Vue √©clat√©e">üí•</button>
      <button onclick="zoomIn()">Ôºã</button>
      <button onclick="zoomReset()">‚ü≥</button>
      <button onclick="zoomOut()">Ôºç</button>
    </div>
    <div class="cv-badge ok" id="badgeFDM" style="display:none">‚úì FDM valid√©</div>
    <div class="cv-badge tag" id="badgePieces" style="display:none"></div>
    <div class="cv-hint" id="cvHint">‚Üî glisse pour tourner ¬∑ scroll pour zoomer</div>

    <!-- Empty state -->
    <div class="empty-state" id="emptyState">
      <div class="big">üé®</div>
      <p><strong>D√©cris ce que tu veux</strong><br>Tape une description √† gauche et l'IA d√©compose ta figurine en formes g√©om√©triques</p>
      <span class="hint">"un chien qui remue la queue"</span>
    </div>
  </div>
  <div class="status-bar">
    <div class="stat">Pi√®ces <span class="v" id="statPieces">‚Äî</span></div>
    <div class="stat">Cames <span class="v" id="statCams">‚Äî</span></div>
    <div class="stat">Drive <span class="v-b" id="statDrive">Manivelle</span></div>
    <div class="stat" style="margin-left:auto">Zoom <span class="v mono" id="statZoom">√ó1.0</span></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê RIGHT PANEL ‚ïê‚ïê‚ïê -->
<div class="right">
  <!-- Shapes section -->
  <div class="panel-h"><div class="dot"></div> FORMES DE BASE</div>
  <div class="shape-grid">
    <div class="shape-btn" onclick="setShape('circle')" id="sh_circle">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><circle cx="12" cy="12" r="9"/></svg>
      <span>Cercle</span>
    </div>
    <div class="shape-btn" onclick="setShape('rect')" id="sh_rect">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><rect x="4" y="6" width="16" height="12" rx="1"/></svg>
      <span>Rectangle</span>
    </div>
    <div class="shape-btn" onclick="setShape('tri')" id="sh_tri">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><polygon points="12,3 22,21 2,21"/></svg>
      <span>Triangle</span>
    </div>
    <div class="shape-btn" onclick="setShape('square')" id="sh_square">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><rect x="5" y="5" width="14" height="14" rx="1"/></svg>
      <span>Carr√©</span>
    </div>
    <div class="shape-btn" onclick="setShape('ellipse')" id="sh_ellipse">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><ellipse cx="12" cy="12" rx="10" ry="6"/></svg>
      <span>Ellipse</span>
    </div>
    <div class="shape-btn" onclick="setShape('diamond')" id="sh_diamond">
      <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5"><polygon points="12,2 22,12 12,22 2,12"/></svg>
      <span>Losange</span>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Movement section -->
  <div class="panel-h"><div class="dot-b"></div> MOUVEMENTS</div>
  <div class="motion-grid">
    <div class="motion-btn" onclick="setMotion('TRANSLATE_V')" id="mo_tv">
      <span class="ico">‚ÜïÔ∏è</span>
      <span>Monte/Descend</span>
    </div>
    <div class="motion-btn" onclick="setMotion('TRANSLATE_H')" id="mo_th">
      <span class="ico">‚ÜîÔ∏è</span>
      <span>Gauche/Droite</span>
    </div>
    <div class="motion-btn" onclick="setMotion('OSCILLATE')" id="mo_osc">
      <span class="ico">üîÑ</span>
      <span>Oscillation</span>
    </div>
    <div class="motion-btn" onclick="setMotion('ROTATE')" id="mo_rot">
      <span class="ico">‚ü≥</span>
      <span>Rotation</span>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Sliders -->
  <div class="panel-h"><div class="dot"></div> PARAM√àTRES</div>
  <div class="slider-group">
    <div class="slider-row">
      <div class="slider-label"><span>Amplitude</span><span class="val" id="valAmp">30¬∞</span></div>
      <input type="range" min="5" max="90" value="30" id="slAmp" oninput="updateParam()">
    </div>
    <div class="slider-row">
      <div class="slider-label"><span>Vitesse</span><span class="val-b" id="valSpeed">1.0 Hz</span></div>
      <input type="range" class="blu" min="1" max="6" value="2" step="1" id="slSpeed" oninput="updateParam()">
    </div>
    <div class="slider-row">
      <div class="slider-label"><span>Taille pi√®ce</span><span class="val" id="valSize">100%</span></div>
      <input type="range" min="50" max="200" value="100" id="slSize" oninput="updateParam()">
    </div>
  </div>

  <!-- Phase -->
  <div class="panel-h"><div class="dot-b"></div> PHASE</div>
  <div class="phase-row">
    <div class="phase-btn on" onclick="setPhase(0)">0¬∞</div>
    <div class="phase-btn" onclick="setPhase(90)">90¬∞</div>
    <div class="phase-btn" onclick="setPhase(180)">180¬∞</div>
    <div class="phase-btn" onclick="setPhase(270)">270¬∞</div>
  </div>

  <!-- Cam profile -->
  <div class="panel-h"><div class="dot"></div> PROFIL CAME</div>
  <div class="profile-row">
    <div class="prof-btn on" onclick="setProfile('smooth')">Smooth</div>
    <div class="prof-btn" onclick="setProfile('sharp')">Sharp</div>
    <div class="prof-btn" onclick="setProfile('dwell')">Dwell</div>
  </div>

  <div class="divider"></div>

  <!-- Pivot -->
  <div class="panel-h"><div class="dot-b"></div> PIVOT</div>
  <div class="phase-row">
    <div class="phase-btn" onclick="setPivot('top')">‚Üë Haut</div>
    <div class="phase-btn on" onclick="setPivot('center')">‚äï Centre</div>
    <div class="phase-btn" onclick="setPivot('bottom')">‚Üì Bas</div>
  </div>
  <div class="phase-row" style="padding-top:0">
    <div class="phase-btn" onclick="setPivot('left')">‚Üê Gauche</div>
    <div class="phase-btn" onclick="setPivot('right')">‚Üí Droite</div>
  </div>
</div>

</div><!-- /app -->

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let figurine = null;     // JSON from prompt 1
let motions = null;      // JSON from prompt 2
let drive = 0;           // 0=crank, 1=motor
let selectedPiece = null;
let currentStep = 1;
let zoom = 1, panX = 0, panY = 0, rotAngle = 0, autoRotate = true;
let anim = null;

// Piece colors
const COLORS = [
  '#34d399','#60a5fa','#f472b6','#fbbf24','#a78bfa',
  '#fb923c','#2dd4bf','#e879f9','#f87171','#94a3b8',
  '#4ade80','#38bdf8','#f9a8d4','#facc15','#c084fc'
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DRIVE TOGGLE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setDrive(d){
  drive=d;
  document.getElementById('dCrank').className='drive-chip'+(d===0?' on-b':'');
  document.getElementById('dMotor').className='drive-chip'+(d===1?' on':'');
  document.getElementById('statDrive').textContent=d===0?'Manivelle':'Moteur';
  document.getElementById('statDrive').className=d===0?'v-b':'v';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AI CALLS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* ‚ïê‚ïê‚ïê SMART LOCAL DECOMPOSER ‚ïê‚ïê‚ïê */
const TEMPLATES = {
  // ‚îÄ‚îÄ ANIMALS ‚îÄ‚îÄ
  chien:{name:"Chien",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:30,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:14},position:{x:-35,y:-8},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"museau",name:"Museau",shape:{type:"ellipse",rx:8,ry:5},position:{x:-50,y:-5},rotation:0,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"oreille_g",name:"Oreille G",shape:{type:"tri",base:10,h:14},position:{x:-38,y:-22},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oreille_d",name:"Oreille D",shape:{type:"tri",base:10,h:14},position:{x:-28,y:-22},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte avant G",shape:{type:"rect",w:6,h:22},position:{x:-18,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte avant D",shape:{type:"rect",w:6,h:22},position:{x:-8,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte arri√®re G",shape:{type:"rect",w:6,h:22},position:{x:18,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_ar_d",name:"Patte arri√®re D",shape:{type:"rect",w:6,h:22},position:{x:10,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"tri",base:8,h:24},position:{x:34,y:-6},rotation:120,parent:"corps",anchor:"right",layer:1,movable:true}
  ]},
  chat:{name:"Chat",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:24,ry:16},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:15},position:{x:-28,y:-10},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"oreille_g",name:"Oreille G",shape:{type:"tri",base:8,h:12},position:{x:-34,y:-26},rotation:-10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oreille_d",name:"Oreille D",shape:{type:"tri",base:8,h:12},position:{x:-22,y:-26},rotation:10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte avant G",shape:{type:"rect",w:5,h:18},position:{x:-14,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_av_d",name:"Patte avant D",shape:{type:"rect",w:5,h:18},position:{x:-6,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"patte_ar_g",name:"Patte arri√®re G",shape:{type:"rect",w:5,h:18},position:{x:14,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_ar_d",name:"Patte arri√®re D",shape:{type:"rect",w:5,h:18},position:{x:8,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"patte_wave",name:"Patte qui wave",shape:{type:"rect",w:5,h:18},position:{x:-18,y:8},rotation:-30,parent:"corps",anchor:"left",layer:2,movable:true},
    {id:"queue",name:"Queue",shape:{type:"ellipse",rx:4,ry:20},position:{x:28,y:-12},rotation:30,parent:"corps",anchor:"right",layer:1,movable:true}
  ]},
  oiseau:{name:"Oiseau",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:22,ry:14},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:10},position:{x:-26,y:-12},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bec",name:"Bec",shape:{type:"tri",base:8,h:14},position:{x:-40,y:-12},rotation:-90,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:2},position:{x:-28,y:-14},rotation:0,parent:"tete",anchor:"center",layer:3,movable:false},
    {id:"aile_g",name:"Aile gauche",shape:{type:"tri",base:30,h:18},position:{x:0,y:-18},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"aile_d",name:"Aile droite",shape:{type:"tri",base:30,h:18},position:{x:0,y:-18},rotation:180,parent:"corps",anchor:"top",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"tri",base:16,h:12},position:{x:24,y:-4},rotation:150,parent:"corps",anchor:"right",layer:1,movable:false},
    {id:"patte_g",name:"Patte G",shape:{type:"rect",w:3,h:14},position:{x:-6,y:14},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_d",name:"Patte D",shape:{type:"rect",w:3,h:14},position:{x:6,y:14},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false}
  ]},
  canard:{name:"Canard",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:26,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:true},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:12},position:{x:-28,y:-14},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"bec",name:"Bec",shape:{type:"rect",w:16,h:5},position:{x:-44,y:-12},rotation:0,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"aile",name:"Aile",shape:{type:"ellipse",rx:16,ry:10},position:{x:4,y:-6},rotation:-10,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"queue",name:"Queue",shape:{type:"tri",base:12,h:10},position:{x:28,y:-8},rotation:140,parent:"corps",anchor:"right",layer:1,movable:false}
  ]},
  poisson:{name:"Poisson",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:30,ry:14},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"queue",name:"Queue",shape:{type:"tri",base:22,h:16},position:{x:32,y:0},rotation:90,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"nageoire_d",name:"Nageoire dorsale",shape:{type:"tri",base:18,h:12},position:{x:-4,y:-16},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"nageoire_v",name:"Nageoire ventrale",shape:{type:"tri",base:10,h:8},position:{x:4,y:14},rotation:180,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:3},position:{x:-18,y:-3},rotation:0,parent:"corps",anchor:"left",layer:2,movable:false}
  ]},
  dinosaure:{name:"Dinosaure",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:28,ry:20},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:14,ry:10},position:{x:-34,y:-12},rotation:-15,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"machoire",name:"M√¢choire",shape:{type:"tri",base:12,h:8},position:{x:-46,y:-8},rotation:-90,parent:"tete",anchor:"left",layer:2,movable:true},
    {id:"patte_av_g",name:"Bras G",shape:{type:"rect",w:5,h:14},position:{x:-16,y:10},rotation:20,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Bras D",shape:{type:"rect",w:5,h:14},position:{x:-10,y:10},rotation:20,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte G",shape:{type:"rect",w:8,h:24},position:{x:14,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_ar_d",name:"Patte D",shape:{type:"rect",w:8,h:24},position:{x:22,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"queue",name:"Queue",shape:{type:"tri",base:10,h:35},position:{x:32,y:4},rotation:100,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"crete1",name:"Cr√™te 1",shape:{type:"tri",base:8,h:10},position:{x:-10,y:-22},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false},
    {id:"crete2",name:"Cr√™te 2",shape:{type:"tri",base:8,h:10},position:{x:0,y:-22},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false},
    {id:"crete3",name:"Cr√™te 3",shape:{type:"tri",base:8,h:10},position:{x:10,y:-22},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false}
  ]},
  robot:{name:"Robot",pieces:[
    {id:"corps",name:"Torse",shape:{type:"rect",w:30,h:36},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"square",s:22},position:{x:0,y:-30},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"antenne",name:"Antenne",shape:{type:"rect",w:3,h:12},position:{x:0,y:-44},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:4},position:{x:-6,y:-32},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:4},position:{x:6,y:-32},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:6,h:28},position:{x:-22,y:2},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D",shape:{type:"rect",w:6,h:28},position:{x:22,y:2},rotation:0,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"patte_g",name:"Jambe G",shape:{type:"rect",w:8,h:26},position:{x:-10,y:32},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_d",name:"Jambe D",shape:{type:"rect",w:8,h:26},position:{x:10,y:32},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  cheval:{name:"Cheval",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:34,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:12,ry:8},position:{x:-42,y:-16},rotation:-30,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"cou",name:"Cou",shape:{type:"rect",w:8,h:20},position:{x:-34,y:-8},rotation:-20,parent:"corps",anchor:"left",layer:0,movable:false},
    {id:"oreille_g",name:"Oreille G",shape:{type:"tri",base:5,h:10},position:{x:-44,y:-28},rotation:-10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oreille_d",name:"Oreille D",shape:{type:"tri",base:5,h:10},position:{x:-38,y:-28},rotation:10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"rect",w:5,h:28},position:{x:-20,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"rect",w:5,h:28},position:{x:-12,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"rect",w:5,h:28},position:{x:18,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"rect",w:5,h:28},position:{x:26,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"ellipse",rx:4,ry:18},position:{x:36,y:-8},rotation:20,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"criniere",name:"Crini√®re",shape:{type:"ellipse",rx:4,ry:14},position:{x:-32,y:-14},rotation:-20,parent:"cou",anchor:"top",layer:2,movable:false}
  ]},
  bonhomme:{name:"Bonhomme",pieces:[
    {id:"corps",name:"Torse",shape:{type:"rect",w:24,h:32},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:14},position:{x:0,y:-28},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:5,h:26},position:{x:-18,y:0},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D",shape:{type:"rect",w:5,h:26},position:{x:18,y:0},rotation:0,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"jambe_g",name:"Jambe G",shape:{type:"rect",w:7,h:28},position:{x:-8,y:30},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"jambe_d",name:"Jambe D",shape:{type:"rect",w:7,h:28},position:{x:8,y:30},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  papillon:{name:"Papillon",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:4,ry:16},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:6},position:{x:0,y:-20},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"antenne_g",name:"Antenne G",shape:{type:"rect",w:2,h:12},position:{x:-6,y:-30},rotation:-20,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"antenne_d",name:"Antenne D",shape:{type:"rect",w:2,h:12},position:{x:6,y:-30},rotation:20,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"aile_hg",name:"Aile haute G",shape:{type:"ellipse",rx:22,ry:16},position:{x:-22,y:-8},rotation:-10,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"aile_hd",name:"Aile haute D",shape:{type:"ellipse",rx:22,ry:16},position:{x:22,y:-8},rotation:10,parent:"corps",anchor:"right",layer:-1,movable:true},
    {id:"aile_bg",name:"Aile basse G",shape:{type:"ellipse",rx:16,ry:12},position:{x:-18,y:8},rotation:-20,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"aile_bd",name:"Aile basse D",shape:{type:"ellipse",rx:16,ry:12},position:{x:18,y:8},rotation:20,parent:"corps",anchor:"right",layer:-1,movable:true}
  ]},
  // ‚îÄ‚îÄ NEW ANIMALS ‚îÄ‚îÄ
  grenouille:{name:"Grenouille",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:24,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:20,ry:14},position:{x:0,y:-22},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:6},position:{x:-12,y:-32},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:6},position:{x:12,y:-32},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"bouche",name:"Bouche",shape:{type:"ellipse",rx:12,ry:3},position:{x:0,y:-14},rotation:0,parent:"tete",anchor:"bottom",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"rect",w:8,h:16},position:{x:-24,y:10},rotation:-30,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"rect",w:8,h:16},position:{x:24,y:10},rotation:30,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"rect",w:10,h:24},position:{x:-20,y:18},rotation:-15,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"rect",w:10,h:24},position:{x:20,y:18},rotation:15,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  tortue:{name:"Tortue",pieces:[
    {id:"carapace",name:"Carapace",shape:{type:"ellipse",rx:30,ry:22},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"motif",name:"Motif",shape:{type:"diamond",w:20,h:16},position:{x:0,y:0},rotation:0,parent:"carapace",anchor:"center",layer:1,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:10,ry:8},position:{x:-34,y:0},rotation:0,parent:"carapace",anchor:"left",layer:1,movable:true},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:2},position:{x:-38,y:-3},rotation:0,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"ellipse",rx:6,ry:10},position:{x:-18,y:18},rotation:-20,parent:"carapace",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"ellipse",rx:6,ry:10},position:{x:-18,y:-18},rotation:20,parent:"carapace",anchor:"top",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"ellipse",rx:6,ry:10},position:{x:18,y:18},rotation:20,parent:"carapace",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"ellipse",rx:6,ry:10},position:{x:18,y:-18},rotation:-20,parent:"carapace",anchor:"top",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"tri",base:6,h:14},position:{x:32,y:0},rotation:90,parent:"carapace",anchor:"right",layer:1,movable:false}
  ]},
  pingouin:{name:"Pingouin",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:18,ry:26},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"ventre",name:"Ventre",shape:{type:"ellipse",rx:12,ry:18},position:{x:0,y:3},rotation:0,parent:"corps",anchor:"center",layer:1,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:14},position:{x:0,y:-30},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"bec",name:"Bec",shape:{type:"tri",base:8,h:10},position:{x:0,y:-26},rotation:180,parent:"tete",anchor:"bottom",layer:2,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:3},position:{x:-6,y:-33},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:3},position:{x:6,y:-33},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"aile_g",name:"Aile G",shape:{type:"ellipse",rx:8,ry:18},position:{x:-22,y:0},rotation:-10,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"aile_d",name:"Aile D",shape:{type:"ellipse",rx:8,ry:18},position:{x:22,y:0},rotation:10,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"pied_g",name:"Pied G",shape:{type:"ellipse",rx:8,ry:5},position:{x:-10,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"pied_d",name:"Pied D",shape:{type:"ellipse",rx:8,ry:5},position:{x:10,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false}
  ]},
  lapin:{name:"Lapin",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:20,ry:24},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:16},position:{x:0,y:-30},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"oreille_g",name:"Oreille G",shape:{type:"ellipse",rx:5,ry:20},position:{x:-8,y:-54},rotation:-10,parent:"tete",anchor:"top",layer:2,movable:true},
    {id:"oreille_d",name:"Oreille D",shape:{type:"ellipse",rx:5,ry:20},position:{x:8,y:-54},rotation:10,parent:"tete",anchor:"top",layer:2,movable:true},
    {id:"museau",name:"Museau",shape:{type:"ellipse",rx:6,ry:4},position:{x:0,y:-24},rotation:0,parent:"tete",anchor:"bottom",layer:2,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:3},position:{x:-8,y:-34},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:3},position:{x:8,y:-34},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV",shape:{type:"rect",w:6,h:14},position:{x:-10,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"patte_av_d",name:"Patte AV",shape:{type:"rect",w:6,h:14},position:{x:10,y:16},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"ellipse",rx:10,ry:8},position:{x:-16,y:22},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"ellipse",rx:10,ry:8},position:{x:16,y:22},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"circle",r:6},position:{x:0,y:20},rotation:0,parent:"corps",anchor:"bottom",layer:2,movable:false}
  ]},
  serpent:{name:"Serpent",pieces:[
    {id:"corps1",name:"Corps 1",shape:{type:"ellipse",rx:16,ry:10},position:{x:-30,y:10},rotation:-20,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"corps2",name:"Corps 2",shape:{type:"ellipse",rx:16,ry:10},position:{x:-8,y:0},rotation:10,parent:"corps1",anchor:"right",layer:0,movable:true},
    {id:"corps3",name:"Corps 3",shape:{type:"ellipse",rx:16,ry:10},position:{x:16,y:8},rotation:-15,parent:"corps2",anchor:"right",layer:0,movable:true},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:10,ry:8},position:{x:-46,y:8},rotation:-10,parent:"corps1",anchor:"left",layer:1,movable:true},
    {id:"langue",name:"Langue",shape:{type:"tri",base:4,h:10},position:{x:-58,y:8},rotation:-90,parent:"tete",anchor:"left",layer:2,movable:true},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:2},position:{x:-48,y:4},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"queue",name:"Queue",shape:{type:"tri",base:8,h:16},position:{x:34,y:12},rotation:80,parent:"corps3",anchor:"right",layer:1,movable:true}
  ]},
  crabe:{name:"Crabe",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:28,ry:18},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:4},position:{x:-10,y:-20},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:4},position:{x:10,y:-20},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false},
    {id:"tige_g",name:"Tige ≈íil G",shape:{type:"rect",w:2,h:8},position:{x:-10,y:-14},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"tige_d",name:"Tige ≈íil D",shape:{type:"rect",w:2,h:8},position:{x:10,y:-14},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"pince_g",name:"Pince G",shape:{type:"ellipse",rx:12,ry:8},position:{x:-40,y:-8},rotation:-20,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"pince_d",name:"Pince D",shape:{type:"ellipse",rx:12,ry:8},position:{x:40,y:-8},rotation:20,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"patte1_g",name:"Patte 1G",shape:{type:"rect",w:3,h:14},position:{x:-26,y:14},rotation:-30,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte2_g",name:"Patte 2G",shape:{type:"rect",w:3,h:14},position:{x:-18,y:16},rotation:-15,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte1_d",name:"Patte 1D",shape:{type:"rect",w:3,h:14},position:{x:26,y:14},rotation:30,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte2_d",name:"Patte 2D",shape:{type:"rect",w:3,h:14},position:{x:18,y:16},rotation:15,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  hibou:{name:"Hibou",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:20,ry:24},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:18},position:{x:0,y:-28},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"oeil_g",name:"≈íil G",shape:{type:"circle",r:8},position:{x:-10,y:-30},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"circle",r:8},position:{x:10,y:-30},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"pupille_g",name:"Pupille G",shape:{type:"circle",r:3},position:{x:-10,y:-30},rotation:0,parent:"oeil_g",anchor:"center",layer:3,movable:false},
    {id:"pupille_d",name:"Pupille D",shape:{type:"circle",r:3},position:{x:10,y:-30},rotation:0,parent:"oeil_d",anchor:"center",layer:3,movable:false},
    {id:"bec",name:"Bec",shape:{type:"tri",base:8,h:8},position:{x:0,y:-22},rotation:180,parent:"tete",anchor:"bottom",layer:2,movable:false},
    {id:"aigrette_g",name:"Aigrette G",shape:{type:"tri",base:8,h:12},position:{x:-14,y:-46},rotation:-10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"aigrette_d",name:"Aigrette D",shape:{type:"tri",base:8,h:12},position:{x:14,y:-46},rotation:10,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"aile_g",name:"Aile G",shape:{type:"ellipse",rx:14,ry:20},position:{x:-26,y:0},rotation:-5,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"aile_d",name:"Aile D",shape:{type:"ellipse",rx:14,ry:20},position:{x:26,y:0},rotation:5,parent:"corps",anchor:"right",layer:-1,movable:true},
    {id:"patte_g",name:"Patte G",shape:{type:"rect",w:6,h:10},position:{x:-8,y:24},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"patte_d",name:"Patte D",shape:{type:"rect",w:6,h:10},position:{x:8,y:24},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false}
  ]},
  cochon:{name:"Cochon",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:30,ry:20},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:16},position:{x:-34,y:-6},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"groin",name:"Groin",shape:{type:"ellipse",rx:8,ry:6},position:{x:-48,y:-4},rotation:0,parent:"tete",anchor:"left",layer:2,movable:false},
    {id:"oreille_g",name:"Oreille G",shape:{type:"tri",base:10,h:12},position:{x:-38,y:-22},rotation:-20,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oreille_d",name:"Oreille D",shape:{type:"tri",base:10,h:12},position:{x:-28,y:-22},rotation:20,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:3},position:{x:-36,y:-10},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"rect",w:7,h:16},position:{x:-18,y:18},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"rect",w:7,h:16},position:{x:-8,y:18},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"rect",w:7,h:16},position:{x:16,y:18},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"rect",w:7,h:16},position:{x:24,y:18},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"circle",r:5},position:{x:32,y:-8},rotation:0,parent:"corps",anchor:"right",layer:1,movable:true}
  ]},
  elephant:{name:"√âl√©phant",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:36,ry:24},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:20},position:{x:-40,y:-8},rotation:0,parent:"corps",anchor:"left",layer:1,movable:false},
    {id:"trompe",name:"Trompe",shape:{type:"ellipse",rx:5,ry:22},position:{x:-56,y:8},rotation:10,parent:"tete",anchor:"bottom",layer:2,movable:true},
    {id:"oreille_g",name:"Oreille",shape:{type:"ellipse",rx:16,ry:20},position:{x:-36,y:-4},rotation:0,parent:"tete",anchor:"left",layer:-1,movable:true},
    {id:"oeil",name:"≈íil",shape:{type:"circle",r:3},position:{x:-42,y:-12},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"defense",name:"D√©fense",shape:{type:"rect",w:3,h:14},position:{x:-48,y:6},rotation:10,parent:"tete",anchor:"bottom",layer:2,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"rect",w:10,h:24},position:{x:-20,y:22},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"rect",w:10,h:24},position:{x:-8,y:22},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"rect",w:10,h:24},position:{x:16,y:22},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"rect",w:10,h:24},position:{x:26,y:22},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"rect",w:3,h:18},position:{x:36,y:-4},rotation:15,parent:"corps",anchor:"right",layer:1,movable:true}
  ]},
  girafe:{name:"Girafe",pieces:[
    {id:"corps",name:"Corps",shape:{type:"ellipse",rx:26,ry:16},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"cou",name:"Cou",shape:{type:"rect",w:10,h:40},position:{x:-20,y:-28},rotation:-10,parent:"corps",anchor:"top",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"ellipse",rx:10,ry:7},position:{x:-24,y:-52},rotation:-10,parent:"cou",anchor:"top",layer:1,movable:true},
    {id:"corne_g",name:"Corne G",shape:{type:"rect",w:2,h:8},position:{x:-28,y:-60},rotation:-5,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"corne_d",name:"Corne D",shape:{type:"rect",w:2,h:8},position:{x:-20,y:-60},rotation:5,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"tache1",name:"Tache 1",shape:{type:"diamond",w:8,h:8},position:{x:-6,y:-4},rotation:0,parent:"corps",anchor:"center",layer:1,movable:false},
    {id:"tache2",name:"Tache 2",shape:{type:"diamond",w:6,h:6},position:{x:10,y:2},rotation:15,parent:"corps",anchor:"center",layer:1,movable:false},
    {id:"patte_av_g",name:"Patte AV-G",shape:{type:"rect",w:5,h:30},position:{x:-16,y:24},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_av_d",name:"Patte AV-D",shape:{type:"rect",w:5,h:30},position:{x:-8,y:24},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"patte_ar_g",name:"Patte AR-G",shape:{type:"rect",w:5,h:30},position:{x:14,y:24},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"patte_ar_d",name:"Patte AR-D",shape:{type:"rect",w:5,h:30},position:{x:22,y:24},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"queue",name:"Queue",shape:{type:"rect",w:3,h:16},position:{x:28,y:-6},rotation:20,parent:"corps",anchor:"right",layer:1,movable:true}
  ]},
  // ‚îÄ‚îÄ PERSONNAGES ‚îÄ‚îÄ
  danseuse:{name:"Danseuse",pieces:[
    {id:"corps",name:"Torse",shape:{type:"rect",w:18,h:28},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:12},position:{x:0,y:-24},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"chignon",name:"Chignon",shape:{type:"circle",r:6},position:{x:0,y:-38},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:4,h:26},position:{x:-16,y:-6},rotation:-45,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D",shape:{type:"rect",w:4,h:26},position:{x:16,y:-6},rotation:45,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"jupe",name:"Jupe",shape:{type:"tri",base:40,h:22},position:{x:0,y:20},rotation:180,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"jambe_g",name:"Jambe G",shape:{type:"rect",w:5,h:28},position:{x:-8,y:36},rotation:-10,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"jambe_d",name:"Jambe D",shape:{type:"rect",w:5,h:28},position:{x:8,y:36},rotation:10,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  ninja:{name:"Ninja",pieces:[
    {id:"corps",name:"Torse",shape:{type:"rect",w:22,h:30},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:12},position:{x:0,y:-26},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"bandeau",name:"Bandeau",shape:{type:"rect",w:28,h:4},position:{x:0,y:-28},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"oeil_g",name:"≈íil G",shape:{type:"rect",w:6,h:2},position:{x:-5,y:-28},rotation:0,parent:"tete",anchor:"center",layer:3,movable:false},
    {id:"oeil_d",name:"≈íil D",shape:{type:"rect",w:6,h:2},position:{x:5,y:-28},rotation:0,parent:"tete",anchor:"center",layer:3,movable:false},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:5,h:24},position:{x:-18,y:-2},rotation:-20,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D + Katana",shape:{type:"rect",w:4,h:36},position:{x:18,y:-10},rotation:30,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"jambe_g",name:"Jambe G",shape:{type:"rect",w:6,h:26},position:{x:-8,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"jambe_d",name:"Jambe D",shape:{type:"rect",w:6,h:26},position:{x:8,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true}
  ]},
  astronaute:{name:"Astronaute",pieces:[
    {id:"corps",name:"Combinaison",shape:{type:"rect",w:28,h:34},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"casque",name:"Casque",shape:{type:"circle",r:16},position:{x:0,y:-28},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"visiere",name:"Visi√®re",shape:{type:"ellipse",rx:10,ry:8},position:{x:0,y:-28},rotation:0,parent:"casque",anchor:"center",layer:2,movable:false},
    {id:"backpack",name:"Sac √† dos",shape:{type:"rect",w:16,h:24},position:{x:18,y:0},rotation:0,parent:"corps",anchor:"right",layer:-1,movable:false},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:8,h:26},position:{x:-22,y:0},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D",shape:{type:"rect",w:8,h:26},position:{x:30,y:0},rotation:0,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"jambe_g",name:"Jambe G",shape:{type:"rect",w:10,h:26},position:{x:-10,y:30},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"jambe_d",name:"Jambe D",shape:{type:"rect",w:10,h:26},position:{x:10,y:30},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"botte_g",name:"Botte G",shape:{type:"rect",w:12,h:8},position:{x:-10,y:48},rotation:0,parent:"jambe_g",anchor:"bottom",layer:1,movable:false},
    {id:"botte_d",name:"Botte D",shape:{type:"rect",w:12,h:8},position:{x:10,y:48},rotation:0,parent:"jambe_d",anchor:"bottom",layer:-1,movable:false}
  ]},
  pirate:{name:"Pirate",pieces:[
    {id:"corps",name:"Torse",shape:{type:"rect",w:24,h:30},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"tete",name:"T√™te",shape:{type:"circle",r:13},position:{x:0,y:-26},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"chapeau",name:"Chapeau",shape:{type:"tri",base:32,h:18},position:{x:0,y:-42},rotation:0,parent:"tete",anchor:"top",layer:2,movable:false},
    {id:"cache_oeil",name:"Cache-≈ìil",shape:{type:"circle",r:4},position:{x:-6,y:-28},rotation:0,parent:"tete",anchor:"center",layer:2,movable:false},
    {id:"barbe",name:"Barbe",shape:{type:"tri",base:16,h:12},position:{x:0,y:-16},rotation:180,parent:"tete",anchor:"bottom",layer:2,movable:false},
    {id:"bras_g",name:"Bras G",shape:{type:"rect",w:5,h:24},position:{x:-18,y:0},rotation:0,parent:"corps",anchor:"left",layer:1,movable:true},
    {id:"bras_d",name:"Bras D + √âp√©e",shape:{type:"rect",w:4,h:34},position:{x:18,y:-6},rotation:20,parent:"corps",anchor:"right",layer:1,movable:true},
    {id:"jambe_g",name:"Jambe G",shape:{type:"rect",w:7,h:26},position:{x:-8,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:true},
    {id:"pilon",name:"Jambe de bois",shape:{type:"rect",w:4,h:26},position:{x:8,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false}
  ]},
  // ‚îÄ‚îÄ OBJETS ‚îÄ‚îÄ
  moulin:{name:"Moulin √† vent",pieces:[
    {id:"corps",name:"Tour",shape:{type:"rect",w:20,h:50},position:{x:0,y:10},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"toit",name:"Toit",shape:{type:"tri",base:28,h:18},position:{x:0,y:-20},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"pale1",name:"Pale 1",shape:{type:"rect",w:8,h:36},position:{x:0,y:-12},rotation:0,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"pale2",name:"Pale 2",shape:{type:"rect",w:8,h:36},position:{x:0,y:-12},rotation:90,parent:"corps",anchor:"top",layer:1,movable:true},
    {id:"axe",name:"Axe",shape:{type:"circle",r:4},position:{x:0,y:-12},rotation:0,parent:"corps",anchor:"top",layer:2,movable:false},
    {id:"porte",name:"Porte",shape:{type:"rect",w:10,h:16},position:{x:0,y:28},rotation:0,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"base",name:"Base",shape:{type:"rect",w:36,h:6},position:{x:0,y:36},rotation:0,parent:"corps",anchor:"bottom",layer:-1,movable:false}
  ]},
  fusee:{name:"Fus√©e",pieces:[
    {id:"corps",name:"Fuselage",shape:{type:"rect",w:18,h:50},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"nez",name:"Nez",shape:{type:"tri",base:18,h:20},position:{x:0,y:-35},rotation:0,parent:"corps",anchor:"top",layer:1,movable:false},
    {id:"hublot1",name:"Hublot 1",shape:{type:"circle",r:4},position:{x:0,y:-12},rotation:0,parent:"corps",anchor:"center",layer:1,movable:false},
    {id:"hublot2",name:"Hublot 2",shape:{type:"circle",r:3},position:{x:0,y:2},rotation:0,parent:"corps",anchor:"center",layer:1,movable:false},
    {id:"aileron_g",name:"Aileron G",shape:{type:"tri",base:14,h:18},position:{x:-16,y:20},rotation:30,parent:"corps",anchor:"bottom",layer:1,movable:false},
    {id:"aileron_d",name:"Aileron D",shape:{type:"tri",base:14,h:18},position:{x:16,y:20},rotation:-30,parent:"corps",anchor:"bottom",layer:-1,movable:false},
    {id:"flamme1",name:"Flamme 1",shape:{type:"tri",base:12,h:20},position:{x:0,y:35},rotation:180,parent:"corps",anchor:"bottom",layer:-1,movable:true},
    {id:"flamme2",name:"Flamme 2",shape:{type:"tri",base:8,h:14},position:{x:0,y:38},rotation:180,parent:"flamme1",anchor:"bottom",layer:-2,movable:true}
  ]},
  fleur:{name:"Fleur",pieces:[
    {id:"tige",name:"Tige",shape:{type:"rect",w:4,h:40},position:{x:0,y:20},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"feuille_g",name:"Feuille G",shape:{type:"ellipse",rx:12,ry:6},position:{x:-12,y:28},rotation:-30,parent:"tige",anchor:"left",layer:1,movable:true},
    {id:"feuille_d",name:"Feuille D",shape:{type:"ellipse",rx:12,ry:6},position:{x:12,y:18},rotation:30,parent:"tige",anchor:"right",layer:1,movable:true},
    {id:"petale1",name:"P√©tale haut",shape:{type:"ellipse",rx:10,ry:14},position:{x:0,y:-16},rotation:0,parent:"tige",anchor:"top",layer:1,movable:true},
    {id:"petale2",name:"P√©tale G",shape:{type:"ellipse",rx:10,ry:14},position:{x:-14,y:-4},rotation:-72,parent:"tige",anchor:"top",layer:1,movable:true},
    {id:"petale3",name:"P√©tale D",shape:{type:"ellipse",rx:10,ry:14},position:{x:14,y:-4},rotation:72,parent:"tige",anchor:"top",layer:1,movable:true},
    {id:"petale4",name:"P√©tale BG",shape:{type:"ellipse",rx:10,ry:14},position:{x:-8,y:6},rotation:-144,parent:"tige",anchor:"top",layer:1,movable:true},
    {id:"petale5",name:"P√©tale BD",shape:{type:"ellipse",rx:10,ry:14},position:{x:8,y:6},rotation:144,parent:"tige",anchor:"top",layer:1,movable:true},
    {id:"coeur",name:"C≈ìur",shape:{type:"circle",r:7},position:{x:0,y:-2},rotation:0,parent:"tige",anchor:"top",layer:2,movable:false}
  ]},
  avion:{name:"Avion",pieces:[
    {id:"fuselage",name:"Fuselage",shape:{type:"ellipse",rx:36,ry:8},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"cockpit",name:"Cockpit",shape:{type:"ellipse",rx:6,ry:5},position:{x:-30,y:-2},rotation:0,parent:"fuselage",anchor:"left",layer:1,movable:false},
    {id:"aile_g",name:"Aile G",shape:{type:"rect",w:50,h:10},position:{x:0,y:-14},rotation:0,parent:"fuselage",anchor:"top",layer:1,movable:true},
    {id:"aile_d",name:"Aile D",shape:{type:"rect",w:50,h:10},position:{x:0,y:14},rotation:0,parent:"fuselage",anchor:"bottom",layer:-1,movable:true},
    {id:"derive",name:"D√©rive",shape:{type:"tri",base:14,h:18},position:{x:30,y:-14},rotation:0,parent:"fuselage",anchor:"right",layer:1,movable:false},
    {id:"stab",name:"Stabilisateur",shape:{type:"rect",w:18,h:5},position:{x:30,y:0},rotation:0,parent:"fuselage",anchor:"right",layer:1,movable:false},
    {id:"helice",name:"H√©lice",shape:{type:"rect",w:3,h:24},position:{x:-38,y:0},rotation:0,parent:"fuselage",anchor:"left",layer:2,movable:true}
  ]},
  voiture:{name:"Voiture",pieces:[
    {id:"chassis",name:"Ch√¢ssis",shape:{type:"rect",w:60,h:16},position:{x:0,y:4},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"habitacle",name:"Habitacle",shape:{type:"rect",w:30,h:16},position:{x:-4,y:-12},rotation:0,parent:"chassis",anchor:"top",layer:1,movable:false},
    {id:"toit",name:"Toit",shape:{type:"rect",w:22,h:4},position:{x:-4,y:-22},rotation:0,parent:"habitacle",anchor:"top",layer:2,movable:false},
    {id:"pare_brise",name:"Pare-brise",shape:{type:"tri",base:8,h:12},position:{x:-18,y:-14},rotation:100,parent:"habitacle",anchor:"left",layer:2,movable:false},
    {id:"roue_av",name:"Roue AV",shape:{type:"circle",r:8},position:{x:-20,y:14},rotation:0,parent:"chassis",anchor:"bottom",layer:-1,movable:true},
    {id:"roue_ar",name:"Roue AR",shape:{type:"circle",r:8},position:{x:20,y:14},rotation:0,parent:"chassis",anchor:"bottom",layer:-1,movable:true},
    {id:"phare",name:"Phare",shape:{type:"circle",r:3},position:{x:-32,y:4},rotation:0,parent:"chassis",anchor:"left",layer:1,movable:false},
    {id:"feu",name:"Feu AR",shape:{type:"rect",w:3,h:5},position:{x:32,y:2},rotation:0,parent:"chassis",anchor:"right",layer:1,movable:false}
  ]},
  bateau:{name:"Bateau",pieces:[
    {id:"coque",name:"Coque",shape:{type:"tri",base:70,h:20},position:{x:0,y:10},rotation:180,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"pont",name:"Pont",shape:{type:"rect",w:60,h:6},position:{x:0,y:0},rotation:0,parent:"coque",anchor:"top",layer:1,movable:false},
    {id:"cabine",name:"Cabine",shape:{type:"rect",w:20,h:14},position:{x:8,y:-10},rotation:0,parent:"pont",anchor:"top",layer:1,movable:false},
    {id:"cheminee",name:"Chemin√©e",shape:{type:"rect",w:6,h:12},position:{x:12,y:-22},rotation:0,parent:"cabine",anchor:"top",layer:2,movable:false},
    {id:"mat",name:"M√¢t",shape:{type:"rect",w:3,h:36},position:{x:-12,y:-20},rotation:0,parent:"pont",anchor:"top",layer:1,movable:false},
    {id:"voile",name:"Voile",shape:{type:"tri",base:22,h:30},position:{x:-4,y:-28},rotation:90,parent:"mat",anchor:"right",layer:1,movable:true},
    {id:"drapeau",name:"Drapeau",shape:{type:"rect",w:10,h:6},position:{x:-12,y:-40},rotation:0,parent:"mat",anchor:"top",layer:2,movable:true}
  ]},
  etoile:{name:"√âtoile",pieces:[
    {id:"centre",name:"Centre",shape:{type:"circle",r:12},position:{x:0,y:0},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"branche1",name:"Branche 1",shape:{type:"tri",base:14,h:22},position:{x:0,y:-22},rotation:0,parent:"centre",anchor:"top",layer:1,movable:true},
    {id:"branche2",name:"Branche 2",shape:{type:"tri",base:14,h:22},position:{x:21,y:-7},rotation:72,parent:"centre",anchor:"right",layer:1,movable:true},
    {id:"branche3",name:"Branche 3",shape:{type:"tri",base:14,h:22},position:{x:13,y:18},rotation:144,parent:"centre",anchor:"right",layer:1,movable:true},
    {id:"branche4",name:"Branche 4",shape:{type:"tri",base:14,h:22},position:{x:-13,y:18},rotation:-144,parent:"centre",anchor:"left",layer:1,movable:true},
    {id:"branche5",name:"Branche 5",shape:{type:"tri",base:14,h:22},position:{x:-21,y:-7},rotation:-72,parent:"centre",anchor:"left",layer:1,movable:true}
  ]},
  arbre:{name:"Arbre",pieces:[
    {id:"tronc",name:"Tronc",shape:{type:"rect",w:12,h:34},position:{x:0,y:16},rotation:0,parent:"root",anchor:"center",layer:0,movable:false},
    {id:"racine_g",name:"Racine G",shape:{type:"tri",base:10,h:8},position:{x:-8,y:34},rotation:20,parent:"tronc",anchor:"bottom",layer:-1,movable:false},
    {id:"racine_d",name:"Racine D",shape:{type:"tri",base:10,h:8},position:{x:8,y:34},rotation:-20,parent:"tronc",anchor:"bottom",layer:-1,movable:false},
    {id:"feuillage1",name:"Feuillage bas",shape:{type:"ellipse",rx:28,ry:18},position:{x:0,y:-8},rotation:0,parent:"tronc",anchor:"top",layer:1,movable:true},
    {id:"feuillage2",name:"Feuillage milieu",shape:{type:"ellipse",rx:22,ry:16},position:{x:0,y:-22},rotation:0,parent:"feuillage1",anchor:"top",layer:2,movable:true},
    {id:"feuillage3",name:"Feuillage haut",shape:{type:"ellipse",rx:16,ry:14},position:{x:0,y:-36},rotation:0,parent:"feuillage2",anchor:"top",layer:3,movable:true}
  ]}
};

// Movement templates
const MOTION_TEMPLATES = {
  marche:{desc:"Marche altern√©e",cams:2,fn:(pieces)=>{
    const motions=[];const pattes=pieces.filter(p=>p.movable&&(p.id.includes('patte')||p.id.includes('jambe')));
    const av=pattes.filter(p=>p.id.includes('av')||p.id.includes('_g')&&!p.id.includes('ar'));
    pattes.forEach((p,i)=>{motions.push({piece_id:p.id,motion:"OSCILLATE",pivot:"top",amplitude:25,speed:"medium",phase:i%2===0?0:180,cam_profile:"smooth",cam_index:i%2});});
    return{motions,cam_count:2};
  }},
  queue:{desc:"Queue remuante",cams:1,fn:(pieces)=>{
    const q=pieces.find(p=>p.id==='queue');
    if(!q)return{motions:[],cam_count:0};
    return{motions:[{piece_id:"queue",motion:"OSCILLATE",pivot:"left",amplitude:40,speed:"medium",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  ailes:{desc:"Battement d'ailes",cams:1,fn:(pieces)=>{
    const ailes=pieces.filter(p=>p.id.includes('aile'));
    return{motions:ailes.map((a,i)=>({piece_id:a.id,motion:"OSCILLATE",pivot:"bottom",amplitude:35,speed:"medium",phase:i%2===0?0:180,cam_profile:"smooth",cam_index:0})),cam_count:1};
  }},
  tete:{desc:"Hochement de t√™te",cams:1,fn:(pieces)=>{
    const t=pieces.find(p=>p.id==='tete');
    if(!t)return{motions:[],cam_count:0};
    return{motions:[{piece_id:"tete",motion:"OSCILLATE",pivot:"bottom",amplitude:20,speed:"fast",phase:0,cam_profile:"sharp",cam_index:0}],cam_count:1};
  }},
  wave:{desc:"Bras/patte qui wave",cams:1,fn:(pieces)=>{
    const arm=pieces.find(p=>p.id.includes('bras_d')||p.id.includes('patte_wave'));
    if(!arm)return{motions:[],cam_count:0};
    return{motions:[{piece_id:arm.id,motion:"OSCILLATE",pivot:"top",amplitude:45,speed:"medium",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  nage:{desc:"Nage ‚Äî queue ondule",cams:1,fn:(pieces)=>{
    const q=pieces.find(p=>p.id==='queue');
    if(!q)return{motions:[],cam_count:0};
    return{motions:[{piece_id:"queue",motion:"OSCILLATE",pivot:"left",amplitude:30,speed:"fast",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  bob:{desc:"Corps qui plonge",cams:1,fn:(pieces)=>{
    const c=pieces.find(p=>p.id==='corps'||p.id==='centre');
    if(!c)return{motions:[],cam_count:0};
    return{motions:[{piece_id:c.id,motion:"TRANSLATE_V",pivot:"center",amplitude:15,speed:"medium",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  pince:{desc:"Pinces qui claquent",cams:1,fn:(pieces)=>{
    const pinces=pieces.filter(p=>p.id.includes('pince'));
    return{motions:pinces.map((p,i)=>({piece_id:p.id,motion:"OSCILLATE",pivot:i===0?"right":"left",amplitude:25,speed:"fast",phase:i===0?0:180,cam_profile:"sharp",cam_index:0})),cam_count:1};
  }},
  helice:{desc:"H√©lice qui tourne",cams:1,fn:(pieces)=>{
    const h=pieces.find(p=>p.id.includes('helice')||p.id.includes('pale'));
    if(!h)return{motions:[],cam_count:0};
    const pales=pieces.filter(p=>p.id.includes('pale')||p.id.includes('helice'));
    return{motions:pales.map(p=>({piece_id:p.id,motion:"ROTATE",pivot:"center",amplitude:360,speed:"fast",phase:0,cam_profile:"smooth",cam_index:0})),cam_count:1};
  }},
  ondule:{desc:"Ondulation serpent",cams:2,fn:(pieces)=>{
    const corps=pieces.filter(p=>p.id.includes('corps'));
    return{motions:corps.map((p,i)=>({piece_id:p.id,motion:"OSCILLATE",pivot:"center",amplitude:20,speed:"medium",phase:i*90,cam_profile:"smooth",cam_index:i%2})),cam_count:2};
  }},
  trompe:{desc:"Trompe qui bouge",cams:1,fn:(pieces)=>{
    const t=pieces.find(p=>p.id.includes('trompe'));
    if(!t)return{motions:[],cam_count:0};
    return{motions:[{piece_id:t.id,motion:"OSCILLATE",pivot:"top",amplitude:30,speed:"slow",phase:0,cam_profile:"smooth",cam_index:0}],cam_count:1};
  }},
  roule:{desc:"Roues qui tournent",cams:1,fn:(pieces)=>{
    const roues=pieces.filter(p=>p.id.includes('roue'));
    return{motions:roues.map(p=>({piece_id:p.id,motion:"ROTATE",pivot:"center",amplitude:360,speed:"medium",phase:0,cam_profile:"smooth",cam_index:0})),cam_count:1};
  }},
  flamme:{desc:"Flamme qui vibre",cams:1,fn:(pieces)=>{
    const fl=pieces.filter(p=>p.id.includes('flamme'));
    return{motions:fl.map((p,i)=>({piece_id:p.id,motion:"OSCILLATE",pivot:"top",amplitude:15,speed:"fast",phase:i*90,cam_profile:"sharp",cam_index:0})),cam_count:1};
  }},
  balance:{desc:"Balancement doux",cams:1,fn:(pieces)=>{
    const movs=pieces.filter(p=>p.movable);
    return{motions:movs.slice(0,3).map((p,i)=>({piece_id:p.id,motion:"OSCILLATE",pivot:"top",amplitude:20,speed:"slow",phase:i*120,cam_profile:"smooth",cam_index:0})),cam_count:1};
  }}
};

function matchTemplate(input){
  const t=input.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  // Match animal/object
  const formKeys={
    chien:['chien','dog','toutou','chiot','puppy'],
    chat:['chat','cat','chaton','minou','kitty'],
    oiseau:['oiseau','bird','piaf','moineau'],
    canard:['canard','duck'],
    poisson:['poisson','fish','requin'],
    dinosaure:['dinosaure','dino','trex','t-rex','rex'],
    robot:['robot','mecha','androide','android'],
    cheval:['cheval','horse','poney','pony'],
    bonhomme:['bonhomme','personnage','humain','homme','femme','personne','figure','man','person'],
    papillon:['papillon','butterfly'],
    grenouille:['grenouille','frog','crapaud'],
    tortue:['tortue','turtle','tortoise'],
    pingouin:['pingouin','penguin','manchot'],
    lapin:['lapin','rabbit','bunny','lievre'],
    serpent:['serpent','snake','cobra','vipere'],
    crabe:['crabe','crab','homard'],
    hibou:['hibou','owl','chouette'],
    cochon:['cochon','pig','porc','porcelet'],
    elephant:['elephant','elephan'],
    girafe:['girafe','giraffe'],
    danseuse:['danseuse','danseur','dancer','ballerine','ballet'],
    ninja:['ninja','samourai','samurai','guerrier'],
    astronaute:['astronaute','astronaut','cosmonaute','spaceman'],
    pirate:['pirate','corsaire','boucanier'],
    moulin:['moulin','windmill','eolienne'],
    fusee:['fusee','rocket','navette','shuttle'],
    fleur:['fleur','flower','rose','tulipe','marguerite'],
    avion:['avion','airplane','plane','jet','aerien'],
    voiture:['voiture','car','auto','automobile','bagnole'],
    bateau:['bateau','boat','ship','navire','barque','voilier'],
    etoile:['etoile','star','astre'],
    arbre:['arbre','tree','sapin','chene']
  };
  let formKey=null;
  for(const[k,words]of Object.entries(formKeys)){if(words.some(w=>t.includes(w))){formKey=k;break;}}
  return formKey;
}

function matchMotions(input, pieces){
  const t=input.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  const allMotions=[];let totalCams=0;
  const motionKeys={marche:['marche','walk','avance','court','run'],queue:['queue','tail','remue'],ailes:['aile','bat','fly','vole','envol'],tete:['tete','head','hoche','nod','picore','peck'],wave:['wave','salue','bras','patte','main','hand'],nage:['nage','swim','ondule'],bob:['plonge','bob','monte','descend','bounce','saute','jump'],pince:['pince','claque','claw','snap'],helice:['helice','tourne','spin','pale','propeller'],ondule:['serpente','ondule','wiggle','slither'],trompe:['trompe','trunk','barrit'],roule:['roule','roll','wheel','roue','avance'],flamme:['flamme','flame','feu','fire','brule'],balance:['balance','swing','bercer','doux','gentle','bouge','vent','souffle']};

  for(const[k,words]of Object.entries(motionKeys)){
    if(words.some(w=>t.includes(w))){
      const tmpl=MOTION_TEMPLATES[k];
      if(tmpl){
        const result=tmpl.fn(pieces);
        result.motions.forEach(m=>{
          m.cam_index=m.cam_index+totalCams;
          if(!allMotions.find(em=>em.piece_id===m.piece_id)) allMotions.push(m);
        });
        totalCams+=result.cam_count;
      }
    }
  }

  // If no motion matched, try smart default based on movable pieces
  if(allMotions.length===0){
    const movables=pieces.filter(p=>p.movable);
    movables.forEach((p,i)=>{
      const isLeg=p.id.includes('patte')||p.id.includes('jambe');
      const isArm=p.id.includes('bras');
      const isWing=p.id.includes('aile');
      const isTail=p.id.includes('queue');
      const isHead=p.id==='tete';
      allMotions.push({
        piece_id:p.id,
        motion:isWing?"OSCILLATE":isLeg?"OSCILLATE":isArm?"OSCILLATE":isTail?"OSCILLATE":isHead?"OSCILLATE":"TRANSLATE_V",
        pivot:isLeg?"top":isArm?"top":isWing?"bottom":isTail?"left":"center",
        amplitude:isWing?35:isLeg?25:isTail?40:isHead?20:15,
        speed:"medium",
        phase:i%2===0?0:180,
        cam_profile:"smooth",
        cam_index:Math.min(i,3)
      });
    });
    totalCams=Math.min(movables.length,4);
  }

  // Cap at 4 cams
  allMotions.forEach(m=>{m.cam_index=Math.min(m.cam_index,3);});
  totalCams=Math.min(totalCams,4);

  // Build groups
  const groups=[];
  for(let ci=0;ci<=3;ci++){
    const gp=allMotions.filter(m=>m.cam_index===ci);
    if(gp.length>0) groups.push({cam_index:ci,pieces:gp.map(m=>m.piece_id),note:gp.map(m=>m.piece_id).join('+')});
  }

  return{description:t,cam_count:totalCams||1,drive:"crank",motions:allMotions,groups};
}

/* Prompts IA gard√©s dans PROMPTS_IA.md sur GitHub pour l'int√©gration backend future */

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STEP 1: DECOMPOSE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function doDecompose(){
  const input = document.getElementById('aiInput').value.trim();
  if(!input) return;
  const btn = document.getElementById('btnDecompose');
  btn.disabled=true; btn.textContent='üß† D√©composition...';

  // Simulate brief AI thinking
  await new Promise(r=>setTimeout(r,400));

  try{
    const key = matchTemplate(input);
    if(!key){
      alert("Je ne reconnais pas encore √ßa ! Essaie :\n\nüêæ Animaux: chien, chat, oiseau, canard, poisson, dinosaure, cheval, papillon, grenouille, tortue, pingouin, lapin, serpent, crabe, hibou, cochon, √©l√©phant, girafe\n\nüë§ Personnages: bonhomme, robot, danseuse, ninja, astronaute, pirate\n\nüîß Objets: moulin, fus√©e, fleur, avion, voiture, bateau, √©toile, arbre");
      btn.disabled=false; btn.textContent='üß† D√©composer en formes';
      return;
    }
    figurine = JSON.parse(JSON.stringify(TEMPLATES[key])); // deep clone
    motions = null;
    selectedPiece = null;
    goToStep(2);
    renderPiecesList();
    startRenderer();
    document.getElementById('emptyState').style.display='none';
    document.getElementById('badgeFDM').style.display='';
    document.getElementById('piecesHeader').style.display='';
    document.getElementById('statPieces').textContent=figurine.pieces.length+'p';
    document.getElementById('badgePieces').textContent=figurine.pieces.length+'p ¬∑ '+figurine.name;
    document.getElementById('badgePieces').style.display='';
  }catch(e){
    console.error(e);
    alert("Erreur: "+e.message);
  }
  btn.disabled=false; btn.textContent='üß† D√©composer en formes';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STEP 2: MOVEMENT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function doMotion(){
  const input = document.getElementById('aiMotion').value.trim();
  if(!input || !figurine) return;
  const btn = document.getElementById('btnMotion');
  btn.disabled=true; btn.textContent='‚öôÔ∏è Analyse...';

  // Simulate brief thinking
  await new Promise(r=>setTimeout(r,400));

  try{
    motions = matchMotions(input, figurine.pieces);
    goToStep(3);
    document.getElementById('statCams').textContent=motions.cam_count;
    document.getElementById('btnGenerate').disabled=false;
    renderPiecesList();
  }catch(e){
    console.error(e);
    alert("Erreur: "+e.message);
  }
  btn.disabled=false; btn.textContent='‚öôÔ∏è Assigner les mouvements';
}

function backToStep1(){
  goToStep(1);
  motions=null;
  document.getElementById('btnGenerate').disabled=true;
}

function goToStep(n){
  currentStep=n;
  document.getElementById('s1').className='step'+(n>=1?(n===1?' active':' done'):'');
  document.getElementById('s2').className='step'+(n>=2?(n===2?' active':' done'):'');
  document.getElementById('s3').className='step'+(n>=3?' active done':'');
  document.getElementById('stepDescribe').style.display=n===1?'':'none';
  document.getElementById('stepMovement').style.display=n>=2?'':'none';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PIECES LIST
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPiecesList(){
  if(!figurine) return;
  const el = document.getElementById('piecesList');
  document.getElementById('pieceCount').textContent=figurine.pieces.length+'p';
  el.innerHTML = figurine.pieces.map((p,i)=>{
    const c = COLORS[i%COLORS.length];
    const motionInfo = motions?.motions?.find(m=>m.piece_id===p.id);
    const motionIcon = motionInfo ? {TRANSLATE_V:'‚Üï',TRANSLATE_H:'‚Üî',OSCILLATE:'üîÑ',ROTATE:'‚ü≥'}[motionInfo.motion]||'' : '';
    return `<div class="piece-item${selectedPiece===p.id?' selected':''}" onclick="selectPiece('${p.id}')">
      <div class="piece-dot" style="background:${c}"></div>
      <span class="piece-name">${p.name}</span>
      <span class="piece-shape">${p.shape.type}</span>
      ${motionIcon?`<span style="font-size:.7rem">${motionIcon}</span>`:''}
      <span class="piece-movable${p.movable?' on':''}" onclick="event.stopPropagation();toggleMovable('${p.id}')">${p.movable?'‚ö°':'‚óã'}</span>
    </div>`;
  }).join('');
}

function selectPiece(id){
  selectedPiece=selectedPiece===id?null:id;
  renderPiecesList();
  // Update right panel to reflect selected piece's params
  if(selectedPiece && motions){
    const m = motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m){
      document.querySelectorAll('.motion-btn').forEach(b=>b.classList.remove('active'));
      const moId={TRANSLATE_V:'mo_tv',TRANSLATE_H:'mo_th',OSCILLATE:'mo_osc',ROTATE:'mo_rot'}[m.motion];
      if(moId)document.getElementById(moId)?.classList.add('active');
      document.getElementById('slAmp').value=m.amplitude;
      updateParam();
    }
  }
}
function toggleMovable(id){
  const p=figurine.pieces.find(p=>p.id===id);
  if(p){p.movable=!p.movable;renderPiecesList();}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RIGHT PANEL CONTROLS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setShape(type){
  document.querySelectorAll('.shape-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('sh_'+type)?.classList.add('active');
  if(selectedPiece && figurine){
    const p=figurine.pieces.find(pp=>pp.id===selectedPiece);
    if(p){
      const defaults={circle:{type:'circle',r:15},rect:{type:'rect',w:30,h:20},tri:{type:'tri',base:20,h:18},square:{type:'square',s:20},ellipse:{type:'ellipse',rx:25,ry:15},diamond:{type:'diamond',w:20,h:25}};
      p.shape=defaults[type]||p.shape;
      renderPiecesList();
    }
  }
}

function setMotion(type){
  document.querySelectorAll('.motion-btn').forEach(b=>b.classList.remove('active'));
  const moId={TRANSLATE_V:'mo_tv',TRANSLATE_H:'mo_th',OSCILLATE:'mo_osc',ROTATE:'mo_rot'}[type];
  if(moId) document.getElementById(moId)?.classList.add('active');
  if(selectedPiece && motions){
    const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m) m.motion=type;
  }
}

function setPhase(deg){
  document.querySelectorAll('.phase-row .phase-btn').forEach(b=>b.classList.remove('on'));
  event.target.classList.add('on');
  if(selectedPiece && motions){
    const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m) m.phase=deg;
  }
}
function setProfile(prof){
  document.querySelectorAll('.profile-row .prof-btn').forEach(b=>b.classList.remove('on'));
  event.target.classList.add('on');
  if(selectedPiece && motions){
    const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m) m.cam_profile=prof;
  }
}
function setPivot(piv){
  // handled by onclick, update motion
  if(selectedPiece && motions){
    const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m) m.pivot=piv;
  }
}

function updateParam(){
  const amp=document.getElementById('slAmp').value;
  const spd=document.getElementById('slSpeed').value;
  const sz=document.getElementById('slSize').value;
  const speeds=[0.25,0.5,1,1.5,2,3];
  document.getElementById('valAmp').textContent=amp+'¬∞';
  document.getElementById('valSpeed').textContent=speeds[spd-1]+' Hz';
  document.getElementById('valSize').textContent=sz+'%';
  if(selectedPiece && motions){
    const m=motions.motions.find(mo=>mo.piece_id===selectedPiece);
    if(m){m.amplitude=+amp;m.speed=speeds[spd-1]<=0.5?'slow':speeds[spd-1]<=1.5?'medium':'fast';}
  }
}

function doGenerate(){
  if(!figurine||!motions) return alert("Pas de figurine ou mouvements d√©finis");
  
  // Build complete automata config for the Python engine
  const config = {
    version: "6.3",
    figurine: {
      name: figurine.name,
      pieces: figurine.pieces.map(p=>({
        id: p.id,
        name: p.name,
        shape: p.shape,
        position: p.position,
        rotation: p.rotation||0,
        movable: p.movable||false,
        parent: p.parent
      }))
    },
    mechanism: {
      drive: drive===0?"crank":"motor",
      cam_count: motions.cam_count,
      cams: Array.from({length:motions.cam_count},(_, ci)=>{
        const pieces=motions.motions.filter(m=>m.cam_index===ci);
        const maxAmp=pieces.length>0?Math.max(...pieces.map(m=>m.amplitude)):20;
        const profile=pieces.length>0?pieces[0].cam_profile:'smooth';
        const motion=pieces.length>0?pieces[0].motion:'OSCILLATE';
        let lift_mm;
        if(motion==='ROTATE') lift_mm=3;
        else if(motion==='TRANSLATE_V'||motion==='TRANSLATE_H') lift_mm=maxAmp*0.4;
        else lift_mm=15*Math.sin(maxAmp*Math.PI/180);
        lift_mm=Math.max(2,Math.min(lift_mm,10));
        return{
          cam_index:ci,
          profile,
          lift_mm:Math.round(lift_mm*10)/10,
          base_radius_mm:4,
          shaft_bore_mm:5,
          thickness_mm:4,
          pieces:pieces.map(p=>p.piece_id)
        };
      }),
      shaft:{diameter_mm:5,length_mm:50},
      box:{width_mm:70,depth_mm:40,height_mm:30,wall_mm:2}
    },
    motions: motions.motions.map(m=>({
      piece_id:m.piece_id,
      motion:m.motion,
      pivot:m.pivot,
      amplitude:m.amplitude,
      speed:m.speed,
      phase:m.phase,
      cam_profile:m.cam_profile,
      cam_index:m.cam_index
    })),
    printer:{
      model:"ender3",
      material:"PLA",
      nozzle_mm:0.4,
      layer_mm:0.2
    }
  };

  const json=JSON.stringify(config,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`automata_${figurine.name.replace(/\s/g,'_')}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   3D RENDERER
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startRenderer(){
  const cv=document.getElementById('mainCanvas');
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const ctx=cv.getContext('2d');
  let f=0, dragging=false, lastX=0, pinchDist=0;

  function resize(){cv.width=cv.parentElement.offsetWidth*dpr;cv.height=cv.parentElement.offsetHeight*dpr;}
  resize(); window.addEventListener('resize',resize);

  // Controls
  cv.onmousedown=e=>{dragging=true;lastX=e.clientX;autoRotate=false;};
  cv.onmousemove=e=>{if(dragging){rotAngle+=(e.clientX-lastX)*0.008;lastX=e.clientX;}};
  cv.onmouseup=cv.onmouseleave=()=>{dragging=false;};
  cv.onwheel=e=>{e.preventDefault();zoom*=e.deltaY>0?0.92:1.08;zoom=Math.max(0.4,Math.min(4,zoom));};
  cv.ontouchstart=e=>{if(e.touches.length===2){const dx=e.touches[0].clientX-e.touches[1].clientX;const dy=e.touches[0].clientY-e.touches[1].clientY;pinchDist=Math.sqrt(dx*dx+dy*dy);}else{dragging=true;lastX=e.touches[0].clientX;autoRotate=false;}};
  cv.ontouchmove=e=>{e.preventDefault();if(e.touches.length===2){const dx=e.touches[0].clientX-e.touches[1].clientX;const dy=e.touches[0].clientY-e.touches[1].clientY;const d=Math.sqrt(dx*dx+dy*dy);if(pinchDist>0){zoom*=d/pinchDist;zoom=Math.max(0.4,Math.min(4,zoom));}pinchDist=d;}else if(dragging){rotAngle+=(e.touches[0].clientX-lastX)*0.008;lastX=e.touches[0].clientX;}};
  cv.ontouchend=()=>{dragging=false;pinchDist=0;};

  window.zoomIn=()=>{zoom=Math.min(zoom*1.25,4);};
  window.zoomOut=()=>{zoom=Math.max(zoom/1.25,0.4);};
  window.zoomReset=()=>{zoom=1;panX=0;panY=0;autoRotate=true;};

  function draw(){
    f++;
    if(autoRotate) rotAngle=f*0.004;
    const w=cv.width, h=cv.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle='#08080f';ctx.fillRect(0,0,w,h);
    if(!figurine){anim=requestAnimationFrame(draw);return;}

    const cx=w/2+panX, cy=h/2+panY;
    const sc=Math.min(w,h)/300*zoom;
    const cr=Math.cos(rotAngle), sr=Math.sin(rotAngle);

    // 3D projection
    function proj(x,y,z){
      return[cx+(x*cr-y*sr*0.55)*sc, cy+(-z*0.82+x*sr*0.32+y*cr*0.32)*sc];
    }

    // 2D Grid for figurine area
    const mechY=h*0.58;
    ctx.globalAlpha=0.04;ctx.strokeStyle='#60a5fa';ctx.lineWidth=0.5;
    for(let gx=-8;gx<=8;gx++){
      const x=w/2+gx*30*zoom;
      ctx.beginPath();ctx.moveTo(x,20);ctx.lineTo(x,mechY-20);ctx.stroke();
    }
    for(let gy=-6;gy<=6;gy++){
      const y=h*0.36+gy*30*zoom;
      if(y>20&&y<mechY-20){ctx.beginPath();ctx.moveTo(40,y);ctx.lineTo(w-40,y);ctx.stroke();}
    }
    ctx.globalAlpha=1;

    // Cam animation
    const camAngle=f*0.02;
    const camLift=9*Math.sin(camAngle)+4*Math.sin(camAngle*1.3);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FIGURINE ‚Äî 2D flat view (top 70%)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const figCX=w/2, figCY=h*0.30;
    const mmPx=Math.min(w,h)/280*zoom;
    const explode=window._explode||false;

    function getShapeSize(s){
      if(s.type==='circle') return{w:s.r*2,h:s.r*2};
      if(s.type==='ellipse') return{w:s.rx*2,h:s.ry*2};
      if(s.type==='rect') return{w:s.w,h:s.h};
      if(s.type==='square') return{w:s.s,h:s.s};
      if(s.type==='tri') return{w:s.base,h:s.h};
      if(s.type==='diamond') return{w:s.w,h:s.h};
      return{w:20,h:20};
    }

    const sortedPieces=[...figurine.pieces].sort((a,b)=>(a.layer||0)-(b.layer||0));

    // Separator
    // Separator
    ctx.strokeStyle='rgba(255,255,255,.04)';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(40,mechY-16);ctx.lineTo(w-40,mechY-16);ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,.06)';ctx.font='600 7px DM Sans';ctx.textAlign='center';
    ctx.fillText('M√âCANISME',w/2,mechY-8);

    sortedPieces.forEach((p)=>{
      const ci=figurine.pieces.indexOf(p);
      const c=COLORS[ci%COLORS.length];
      const isSel=p.id===selectedPiece;
      const sz=getShapeSize(p.shape);

      let px=p.position.x*mmPx;
      let py=p.position.y*mmPx;
      if(explode){px*=1.5;py*=1.5;}

      let animX=0,animY=0,animRot=0;
      if(motions){
        const m=motions.motions.find(mo=>mo.piece_id===p.id);
        if(m){
          const phaseRad=m.phase*Math.PI/180;
          const speed=m.speed==='slow'?0.5:m.speed==='fast'?2:1;
          const t=f*0.03*speed+phaseRad;
          const prof=m.cam_profile==='sharp'?Math.sign(Math.sin(t))*Math.pow(Math.abs(Math.sin(t)),0.5):m.cam_profile==='dwell'?Math.round(Math.sin(t)*3)/3:Math.sin(t);
          if(m.motion==='TRANSLATE_V') animY=prof*m.amplitude*0.35*mmPx/2;
          else if(m.motion==='TRANSLATE_H') animX=prof*m.amplitude*0.35*mmPx/2;
          else if(m.motion==='OSCILLATE') animRot=prof*m.amplitude*Math.PI/180;
          else if(m.motion==='ROTATE') animRot=f*0.04*speed;
        }
      }

      const sx=figCX+px+animX, sy=figCY+py+animY;
      const rw=sz.w*mmPx, rh=sz.h*mmPx;

      ctx.strokeStyle=c;ctx.fillStyle=c+(isSel?'28':'12');ctx.lineWidth=isSel?2.5:1.5;
      if(isSel){ctx.shadowColor=c;ctx.shadowBlur=14;}

      ctx.save();ctx.translate(sx,sy);
      const totalRot=(p.rotation||0)*Math.PI/180+animRot;
      if(totalRot) ctx.rotate(totalRot);

      ctx.beginPath();
      if(p.shape.type==='circle') ctx.arc(0,0,rw/2,0,Math.PI*2);
      else if(p.shape.type==='ellipse') ctx.ellipse(0,0,rw/2,rh/2,0,0,Math.PI*2);
      else if(p.shape.type==='rect'||p.shape.type==='square') ctx.roundRect(-rw/2,-rh/2,rw,rh,1.5);
      else if(p.shape.type==='tri'){ctx.moveTo(0,-rh/2);ctx.lineTo(rw/2,rh/2);ctx.lineTo(-rw/2,rh/2);}
      else if(p.shape.type==='diamond'){ctx.moveTo(0,-rh/2);ctx.lineTo(rw/2,0);ctx.lineTo(0,rh/2);ctx.lineTo(-rw/2,0);}
      ctx.closePath();ctx.fill();ctx.stroke();ctx.shadowBlur=0;

      // Label
      ctx.fillStyle=c+'BB';ctx.font=`600 ${Math.max(7,8*zoom)}px 'DM Sans'`;ctx.textAlign='center';
      ctx.fillText(p.name,0,-rh/2-4);
      if(p.movable){ctx.fillStyle=c+'70';ctx.font=`${7*zoom}px 'JetBrains Mono'`;ctx.fillText('‚ö°',rw/2+4,3);}
      ctx.restore();

      if(explode&&p.parent!=='root'){
        const pp=figurine.pieces.find(pi=>pi.id===p.parent);
        if(pp){ctx.strokeStyle=c+'25';ctx.lineWidth=0.8;ctx.setLineDash([3,3]);ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(figCX+pp.position.x*mmPx*1.5,figCY+pp.position.y*mmPx*1.5);ctx.stroke();ctx.setLineDash([]);}
      }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MECHANISM ‚Äî SOLID opaque (like real printed parts)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const mechCX=w/2,mechCY=mechY+(h-mechY)*0.5;
    const msc=Math.min(w,h)/180*zoom;

    function mproj(x,y,z){
      return[mechCX + x*msc - y*msc*0.4, mechCY - z*msc*0.7 + y*msc*0.35];
    }

    const bw=70,bd=30,bh=28;
    const bv=[[-bw/2,-bd/2,0],[bw/2,-bd/2,0],[bw/2,bd/2,0],[-bw/2,bd/2,0],[-bw/2,-bd/2,bh],[bw/2,-bd/2,bh],[bw/2,bd/2,bh],[-bw/2,bd/2,bh]].map(v=>mproj(...v));

    // Shadow
    ctx.fillStyle='rgba(0,0,0,.2)';
    ctx.beginPath();[0,1,2,3].forEach((vi,i)=>{const ox=bv[vi][0]+5,oy=bv[vi][1]+6;i===0?ctx.moveTo(ox,oy):ctx.lineTo(ox,oy);});ctx.closePath();ctx.fill();

    // SOLID box faces ‚Äî wood/PLA colors
    // Floor
    ctx.fillStyle='#2A2520';ctx.strokeStyle='#3D3530';ctx.lineWidth=1;
    ctx.beginPath();[0,1,2,3].forEach((vi,i)=>{i===0?ctx.moveTo(...bv[vi]):ctx.lineTo(...bv[vi]);});ctx.closePath();ctx.fill();ctx.stroke();
    // Back wall
    ctx.fillStyle='#332E28';ctx.strokeStyle='#443D35';ctx.lineWidth=1;
    ctx.beginPath();[3,0,4,7].forEach((vi,i)=>{i===0?ctx.moveTo(...bv[vi]):ctx.lineTo(...bv[vi]);});ctx.closePath();ctx.fill();ctx.stroke();
    // Left wall
    ctx.fillStyle='#3A342D';ctx.strokeStyle='#4A433A';ctx.lineWidth=1;
    ctx.beginPath();[0,1,5,4].forEach((vi,i)=>{i===0?ctx.moveTo(...bv[vi]):ctx.lineTo(...bv[vi]);});ctx.closePath();ctx.fill();ctx.stroke();
    // Front walls (transparent ‚Äî see inside)
    ctx.strokeStyle='#4A433A';ctx.lineWidth=0.6;ctx.setLineDash([4,3]);
    ctx.beginPath();[1,2,6,5].forEach((vi,i)=>{i===0?ctx.moveTo(...bv[vi]):ctx.lineTo(...bv[vi]);});ctx.closePath();ctx.stroke();
    ctx.beginPath();[2,3,7,6].forEach((vi,i)=>{i===0?ctx.moveTo(...bv[vi]):ctx.lineTo(...bv[vi]);});ctx.closePath();ctx.stroke();
    ctx.setLineDash([]);
    // Top rim
    ctx.strokeStyle='#55493E';ctx.lineWidth=1.2;
    ctx.beginPath();[4,5,6,7].forEach((vi,i)=>{i===0?ctx.moveTo(...bv[vi]):ctx.lineTo(...bv[vi]);});ctx.closePath();ctx.stroke();

    // ‚îÄ‚îÄ SHAFT ‚Äî solid metallic cylinder ‚îÄ‚îÄ
    const shZ=bh*0.45;
    const shLen=bw*0.75;
    const[shx1,shy1]=mproj(-shLen/2,0,shZ),[shx2,shy2]=mproj(shLen/2,0,shZ);
    // Shadow
    ctx.strokeStyle='rgba(0,0,0,.25)';ctx.lineWidth=6;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(shx1+1,shy1+2);ctx.lineTo(shx2+1,shy2+2);ctx.stroke();
    // Body ‚Äî solid gray
    ctx.strokeStyle='#787878';ctx.lineWidth=5;ctx.beginPath();ctx.moveTo(shx1,shy1);ctx.lineTo(shx2,shy2);ctx.stroke();
    // Highlight
    ctx.strokeStyle='#999';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(shx1,shy1);ctx.lineTo(shx2,shy2);ctx.stroke();
    ctx.strokeStyle='#AAA';ctx.lineWidth=0.8;ctx.beginPath();ctx.moveTo(shx1,shy1-1);ctx.lineTo(shx2,shy2-1);ctx.stroke();
    ctx.lineCap='butt';

    // ‚îÄ‚îÄ Bearings ‚Äî solid ‚îÄ‚îÄ
    [[-shLen/2-1,0,shZ],[shLen/2+1,0,shZ]].forEach(pos=>{
      const[bx,by]=mproj(...pos);
      // Pillar supports
      const[l1x,l1y]=mproj(pos[0]-2.5,pos[1],1);const[l2x,l2y]=mproj(pos[0]-2.5,pos[1],shZ-1);
      const[l3x,l3y]=mproj(pos[0]+2.5,pos[1],1);const[l4x,l4y]=mproj(pos[0]+2.5,pos[1],shZ-1);
      ctx.strokeStyle='#5A4E42';ctx.lineWidth=2.5;
      ctx.beginPath();ctx.moveTo(l1x,l1y);ctx.lineTo(l2x,l2y);ctx.stroke();
      ctx.beginPath();ctx.moveTo(l3x,l3y);ctx.lineTo(l4x,l4y);ctx.stroke();
      // Housing
      ctx.fillStyle='#6B5E52';ctx.strokeStyle='#7D6E60';ctx.lineWidth=1;
      ctx.beginPath();ctx.arc(bx,by,4*msc,0,Math.PI*2);ctx.fill();ctx.stroke();
      // Inner
      ctx.fillStyle='#555';ctx.strokeStyle='#666';ctx.lineWidth=0.8;
      ctx.beginPath();ctx.arc(bx,by,2*msc,0,Math.PI*2);ctx.fill();ctx.stroke();
    });

    // ‚îÄ‚îÄ CAMS ‚Äî REAL profiles from motion data ‚îÄ‚îÄ
    const nCams=motions?motions.cam_count:1;
    
    // Pre-compute real cam profiles from motion assignments
    function buildCamProfile(camIdx){
      if(!motions) return {lift:4,profile:'smooth',pieces:[]};
      const pieces=motions.motions.filter(m=>m.cam_index===camIdx);
      if(pieces.length===0) return {lift:4,profile:'smooth',pieces:[]};
      // Take max amplitude among pieces on this cam
      const maxAmp=Math.max(...pieces.map(m=>m.amplitude));
      const profile=pieces[0].cam_profile||'smooth';
      const motion=pieces[0].motion||'OSCILLATE';
      // Convert amplitude to real mm lift
      // OSCILLATE: degrees ‚Üí mm via ~15mm lever arm: lift = 15*sin(amp¬∞)
      // TRANSLATE: direct mm, scaled
      let lift;
      if(motion==='ROTATE') lift=3; // eccentric for rotation
      else if(motion==='TRANSLATE_V'||motion==='TRANSLATE_H') lift=maxAmp*0.4;
      else lift=15*Math.sin(maxAmp*Math.PI/180); // OSCILLATE
      lift=Math.max(2,Math.min(lift,10)); // clamp 2-10mm
      return {lift,profile,motion,pieces,amplitude:maxAmp};
    }

    // Real cam radius: CONCENTRATED LOBE ‚Äî bump over ~120¬∞ then flat base
    function realCamRadius(angle,camData,rotOffset){
      const baseR=camData.baseR||3;
      const theta=((angle-rotOffset)%(Math.PI*2)+Math.PI*2)%(Math.PI*2);
      let displacement=0;
      const lift=camData.lift;
      if(camData.profile==='smooth'){
        // Lobe concentrated 0‚ÜíœÄ (180¬∞), smooth sine, rest is base
        if(theta<Math.PI) displacement=lift*Math.sin(theta);
        else displacement=0;
      } else if(camData.profile==='sharp'){
        // Triangle lobe: 0‚ÜíœÄ/3 rise, œÄ/3‚Üí2œÄ/3 fall, rest flat
        if(theta<Math.PI/3) displacement=lift*(theta/(Math.PI/3));
        else if(theta<Math.PI*2/3) displacement=lift*(1-(theta-Math.PI/3)/(Math.PI/3));
        else displacement=0;
      } else if(camData.profile==='dwell'){
        // Rise 0‚ÜíœÄ/4, dwell œÄ/4‚Üí3œÄ/4, fall 3œÄ/4‚ÜíœÄ, rest flat
        if(theta<Math.PI/4) displacement=lift*(theta/(Math.PI/4));
        else if(theta<Math.PI*3/4) displacement=lift;
        else if(theta<Math.PI) displacement=lift*(1-(theta-Math.PI*3/4)/(Math.PI/4));
        else displacement=0;
      }
      return baseR+displacement;
    }

    for(let ci=0;ci<Math.min(nCams,4);ci++){
      const ca=camAngle+ci*Math.PI*0.6;
      const xOff=(ci-(Math.min(nCams,4)-1)/2)*(shLen*0.5/Math.max(Math.min(nCams,4)-1,1));
      const camData=buildCamProfile(ci);
      // FORCE visible lobe: base=3mm, lift=min 7mm so ratio is always >3:1
      const baseR=3;
      const realLift=Math.max(7,camData.lift*1.5);
      const visCamData={...camData,lift:realLift,baseR};

      const camFill=['#D4652A','#C85A22','#BC4F1C','#A84518'][ci];
      const camEdge=['#E87840','#D96C35','#CC602B','#BB5520'][ci];
      const camDark=['#A04A1A','#944016','#883812','#7C3010'][ci];

      const[gcx,gcy]=mproj(xOff,0,shZ);
      const camThick=3*msc;

      // Bottom edge
      ctx.fillStyle=camDark;ctx.strokeStyle=camDark;ctx.lineWidth=1;
      ctx.beginPath();
      for(let i=0;i<=72;i++){const t=(i/72)*Math.PI*2;const r=realCamRadius(t,visCamData,ca);const px=gcx+r*Math.cos(t)*msc;const py=gcy+r*Math.sin(t)*msc*0.6+camThick;i===0?ctx.moveTo(px,py):ctx.lineTo(px,py);}
      ctx.closePath();ctx.fill();ctx.stroke();

      // Side rim
      for(let i=0;i<=72;i++){
        const t=(i/72)*Math.PI*2;
        if(Math.sin(t)>-0.2){
          const r=realCamRadius(t,visCamData,ca);
          const px=gcx+r*Math.cos(t)*msc;
          const pyTop=gcy+r*Math.sin(t)*msc*0.6;
          const pyBot=pyTop+camThick;
          ctx.strokeStyle=camDark;ctx.lineWidth=1.2;
          ctx.beginPath();ctx.moveTo(px,pyTop);ctx.lineTo(px,pyBot);ctx.stroke();
        }
      }

      // Top face
      ctx.fillStyle=camFill;ctx.strokeStyle=camEdge;ctx.lineWidth=1.5;
      ctx.beginPath();
      for(let i=0;i<=72;i++){const t=(i/72)*Math.PI*2;const r=realCamRadius(t,visCamData,ca);const px=gcx+r*Math.cos(t)*msc;const py=gcy+r*Math.sin(t)*msc*0.6;i===0?ctx.moveTo(px,py):ctx.lineTo(px,py);}
      ctx.closePath();ctx.fill();ctx.stroke();

      // Center bore
      ctx.fillStyle='#222';ctx.strokeStyle='#444';ctx.lineWidth=0.8;
      ctx.beginPath();ctx.ellipse(gcx,gcy,1.5*msc,1.5*msc*0.6,0,0,Math.PI*2);ctx.fill();ctx.stroke();

      // ‚îÄ‚îÄ Follower ‚Äî driven by REAL cam ‚îÄ‚îÄ
      const topAngle=Math.PI*1.5; // follower sits on top
      const contactR=realCamRadius(topAngle,visCamData,ca);
      const lift=contactR-baseR;

      const[f1x,f1y]=mproj(xOff,0,shZ+contactR);
      const[f2x,f2y]=mproj(xOff,0,shZ+baseR+visCamData.lift+10+lift);
      ctx.strokeStyle='rgba(0,0,0,.2)';ctx.lineWidth=4;ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(f1x+1,f1y+1);ctx.lineTo(f2x+1,f2y+1);ctx.stroke();
      ctx.strokeStyle='#C4A44A';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(f1x,f1y);ctx.lineTo(f2x,f2y);ctx.stroke();
      ctx.strokeStyle='#D4B85A';ctx.lineWidth=1.2;ctx.beginPath();ctx.moveTo(f1x,f1y);ctx.lineTo(f2x,f2y);ctx.stroke();
      ctx.lineCap='butt';

      // Roller
      const[rlx,rly]=mproj(xOff,0,shZ+contactR);
      ctx.fillStyle='#B89838';ctx.strokeStyle='#C8A848';ctx.lineWidth=1;
      ctx.beginPath();ctx.arc(rlx,rly,2.2*msc,0,Math.PI*2);ctx.fill();ctx.stroke();

      // T-bar
      const platW=5;
      const[pt1x,pt1y]=mproj(xOff-platW,0,shZ+baseR+visCamData.lift+10+lift);
      const[pt2x,pt2y]=mproj(xOff+platW,0,shZ+baseR+visCamData.lift+10+lift);
      ctx.strokeStyle='#C4A44A';ctx.lineWidth=2;ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(pt1x,pt1y);ctx.lineTo(pt2x,pt2y);ctx.stroke();ctx.lineCap='butt';

      // Label ‚Äî show real data
      const profileLabel=camData.profile==='smooth'?'Harm.':camData.profile==='sharp'?'Tri.':'Dwell';
      const ampLabel=camData.amplitude?Math.round(camData.amplitude)+'¬∞':'';
      ctx.fillStyle='rgba(255,180,80,.5)';ctx.font='600 6px DM Sans';ctx.textAlign='center';
      const maxR=baseR+visCamData.lift;
      ctx.fillText(`CAM ${ci+1} ¬∑ ${profileLabel} ${ampLabel}`,gcx,gcy+maxR*msc*0.6+camThick+9);
    }

    // ‚îÄ‚îÄ Drive ‚Äî solid ‚îÄ‚îÄ
    if(drive===0){
      const cA=camAngle;
      const[hx,hy]=mproj(-shLen/2-6,0,shZ);
      const crankR=10;
      const cx2=hx+crankR*Math.cos(cA), cy2=hy+crankR*Math.sin(cA);
      // Arm
      ctx.strokeStyle='#556B8A';ctx.lineWidth=3;ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(hx,hy);ctx.lineTo(cx2,cy2);ctx.stroke();
      ctx.strokeStyle='#6B82A5';ctx.lineWidth=1.5;
      ctx.beginPath();ctx.moveTo(hx,hy);ctx.lineTo(cx2,cy2);ctx.stroke();
      // Pivot
      ctx.fillStyle='#4A5E78';ctx.strokeStyle='#6B82A5';ctx.lineWidth=1;
      ctx.beginPath();ctx.arc(hx,hy,2.5,0,Math.PI*2);ctx.fill();ctx.stroke();
      // Handle ball
      ctx.fillStyle='#5A7090';ctx.strokeStyle='#7B98B8';ctx.lineWidth=1;
      ctx.beginPath();ctx.arc(cx2,cy2,4,0,Math.PI*2);ctx.fill();ctx.stroke();
      ctx.lineCap='butt';
    }else{
      const[mx,my]=mproj(shLen/2+8,0,shZ);
      ctx.fillStyle='#4A4038';ctx.strokeStyle='#5A5048';ctx.lineWidth=1;
      ctx.beginPath();ctx.roundRect(mx-6,my-9,12,18,2);ctx.fill();ctx.stroke();
      ctx.fillStyle='#8A7A68';ctx.font='bold 6px DM Sans';ctx.textAlign='center';ctx.fillText('M',mx,my+3);
    }

    // ‚îÄ‚îÄ Connection lines ‚îÄ‚îÄ
    if(motions&&motions.motions.length>0){
      const usedCams=new Set(motions.motions.map(m=>m.cam_index||0));
      usedCams.forEach(ci=>{
        const xOff=(ci-(Math.min(nCams,4)-1)/2)*(shLen*0.5/Math.max(Math.min(nCams,4)-1,1));
        const camData=buildCamProfile(ci);
        const realLift=Math.max(7,camData.lift*1.5);
        const[ftx,fty]=mproj(xOff,0,shZ+3+realLift+12);
        ctx.strokeStyle='rgba(196,164,74,.12)';ctx.lineWidth=0.6;ctx.setLineDash([2,5]);
        ctx.beginPath();ctx.moveTo(ftx,fty);ctx.lineTo(ftx,mechY-10);ctx.stroke();ctx.setLineDash([]);
      });
    }

    document.getElementById('statZoom').textContent='√ó'+zoom.toFixed(1);
    anim=requestAnimationFrame(draw);
  }

  if(anim) cancelAnimationFrame(anim);
  draw();
}

window._explode=false;
function toggleExplode(){
  window._explode=!window._explode;
  const btn=document.getElementById('btnExplode');
  btn.style.background=window._explode?'rgba(255,107,53,.2)':'';
  btn.style.borderColor=window._explode?'var(--ac)':'';
  btn.style.color=window._explode?'var(--ac)':'';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
goToStep(1);
</script>
</body>
</html>